name: Fast Feedback - Development

on:
  push:
    branches: ['feature/**', 'fix/**', 'feat/**']
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

concurrency:
  group: fast-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24'
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  pre-check:
    name: Pre-Check
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should-run-tests: ${{ steps.analyze.outputs.should-run-tests }}
      affected-apps: ${{ steps.analyze.outputs.affected-apps }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Analyze changes
        id: analyze
        run: |
          # Check what changed
          CHANGED_FILES=$(git diff --name-only HEAD~1 || true)
          echo "Changed files: $CHANGED_FILES"

          # Check if we need to run tests
          if echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' > /dev/null; then
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
          else
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
          fi

          # Determine affected apps
          AFFECTED_APPS=""
          if echo "$CHANGED_FILES" | grep '^apps/frontend/' > /dev/null; then
            AFFECTED_APPS="$AFFECTED_APPS frontend"
          fi
          if echo "$CHANGED_FILES" | grep '^apps/backend/' > /dev/null; then
            AFFECTED_APPS="$AFFECTED_APPS backend"
          fi
          if echo "$CHANGED_FILES" | grep '^packages/' > /dev/null; then
            AFFECTED_APPS="$AFFECTED_APPS frontend backend"
          fi

          echo "affected-apps=${AFFECTED_APPS:-none}" >> $GITHUB_OUTPUT

      - name: Quick syntax validation
        run: |
          # Ultra-fast syntax check without npm install
          if [[ -f package.json ]]; then
            node -e "JSON.parse(require('fs').readFileSync('package.json'))" || {
              echo "âŒ Invalid package.json"
              exit 1
            }
          fi
          echo "âœ… Syntax check passed"

  quick-quality:
    name: Quick Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: pre-check
    if: needs.pre-check.outputs.should-run-tests == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (minimal)
        run: |
          # Only install what we need for linting/typechecking
          npm ci --omit=optional --ignore-scripts 2>/dev/null || npm install --omit=optional --no-audit --ignore-scripts

      - name: Quick lint (changed files only)
        run: |
          # Get changed TypeScript/JavaScript files
          CHANGED_FILES=$(git diff --name-only HEAD~1 | grep -E '\.(ts|tsx|js|jsx)$' | head -20 || true)

          if [[ -n "$CHANGED_FILES" ]]; then
            LINT_FILES=""
            for FILE in $CHANGED_FILES; do
              if [ -f "$FILE" ]; then
                LINT_FILES="$LINT_FILES $FILE"
              fi
            done

            if [[ -n "$LINT_FILES" ]]; then
              echo "Linting changed files: $LINT_FILES"
              npx eslint $LINT_FILES --max-warnings 5 || {
                echo "âš ï¸ Linting found issues - please fix before merging"
                exit 1
              }
            else
              echo "No existing files to lint."
            fi
          else
            echo "No TypeScript/JavaScript files changed"
          fi

      - name: Build dependencies
        run: |
          # Build shared packages first so TypeScript can find type declarations
          npm run build:shared
          npm run build:database

      - name: Quick typecheck (affected packages only)
        run: |
          # Only typecheck affected packages
          AFFECTED="${{ needs.pre-check.outputs.affected-apps }}"

          if [[ "$AFFECTED" == *"frontend"* ]]; then
            echo "Typechecking frontend..."
            cd apps/frontend && npx tsc --noEmit --incremental
          fi

          if [[ "$AFFECTED" == *"backend"* ]]; then
            echo "Typechecking backend..."
            cd apps/backend && npx tsc --noEmit --incremental
          fi

  essential-tests:
    name: Essential Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [pre-check, quick-quality]
    if: needs.pre-check.outputs.should-run-tests == 'true'
    strategy:
      fail-fast: false
      matrix:
        app:
          - ${{ contains(needs.pre-check.outputs.affected-apps, 'frontend') && 'frontend' || '' }}
          - ${{ contains(needs.pre-check.outputs.affected-apps, 'backend') && 'backend' || '' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --omit=optional

      - name: Run core tests for ${{ matrix.app }}
        run: |
          cd apps/${{ matrix.app }}

          # Run only fast unit tests, skip slow integration tests
          if [[ "${{ matrix.app }}" == "frontend" ]]; then
            # Frontend: Run unit tests
            npm run test:unit --maxWorkers=2 || {
              echo "âš ï¸ Some tests failed - review before merging"
              exit 0  # Don't fail fast feedback for test issues
            }
          elif [[ "${{ matrix.app }}" == "backend" ]]; then
            # Backend: Run unit tests
            npm run test --maxWorkers=2 || {
              echo "âš ï¸ Some tests failed - review before merging"
              exit 0
            }
          fi
        env:
          NODE_ENV: test
          CI: true

  build-smoke-test:
    name: Build Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [pre-check, quick-quality]
    if: needs.pre-check.outputs.should-run-tests == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --omit=optional

      - name: Build essential packages
        run: |
          # Build only what's needed to verify compilation
          npm run build:shared

          AFFECTED="${{ needs.pre-check.outputs.affected-apps }}"

          if [[ "$AFFECTED" == *"frontend"* ]]; then
            echo "Building frontend..."
            cd apps/frontend
            NODE_ENV=production npm run build || {
              echo "âŒ Frontend build failed"
              exit 1
            }
          fi

          if [[ "$AFFECTED" == *"backend"* ]]; then
            echo "Building backend..."
            cd apps/backend
            NODE_OPTIONS='--max-old-space-size=4096' npm run build || {
              echo "âŒ Backend build failed"
              exit 1
            }
          fi
        env:
          NODE_ENV: production

  feedback-summary:
    name: Fast Feedback Summary
    runs-on: ubuntu-latest
    needs: [pre-check, quick-quality, essential-tests, build-smoke-test]
    if: always()
    steps:
      - name: Generate feedback report
        run: |
          echo "## ðŸš€ Fast Feedback Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.pre-check.outputs.should-run-tests }}" == "false" ]]; then
            echo "â„¹ï¸ **No code changes detected** - skipped most checks" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: âœ… Ready to merge" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "**Changed components**: ${{ needs.pre-check.outputs.affected-apps }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Check | ${{ needs.quick-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ~3min |" >> $GITHUB_STEP_SUMMARY
          echo "| Essential Tests | ${{ needs.essential-tests.result == 'success' && 'âœ… Passed' || needs.essential-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Issues' }} | ~5min |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Check | ${{ needs.build-smoke-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | ~7min |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.quick-quality.result }}" == "success" && "${{ needs.build-smoke-test.result }}" == "success" ]]; then
            echo "**Overall Status**: âœ… **Ready for review**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ *This was a fast feedback check. Full CI will run on merge to develop/main.*" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Overall Status**: âŒ **Needs attention**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the issues above before requesting review." >> $GITHUB_STEP_SUMMARY
          fi
