name: Update Supabase Database Types

on:
  schedule:
    # Run daily at 2 AM UTC to sync database schema changes
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger for immediate updates
  push:
    paths:
      # Run when database migrations change
      - 'packages/database/prisma/schema.prisma'
      - 'packages/database/prisma/migrations/**'

jobs:
  update-types:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      PROJECT_REF: "bshjmbshupiibfiewpxb"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        run: npm install -g @supabase/cli

      - name: Generate updated Supabase types
        run: |
          # Generate new types to temporary file
          npx supabase gen types typescript --project-id "$PROJECT_REF" --schema public > temp-supabase-types.ts
          
          # Move to correct location
          mv temp-supabase-types.ts packages/shared/src/types/supabase-generated.ts

      - name: Build shared package
        run: |
          cd packages/shared
          npm run build

      - name: Run type checking
        run: |
          # Verify types compile correctly
          npm run typecheck || echo "Type checking failed - this may indicate breaking schema changes"

      - name: Check for changes
        id: git_status
        run: |
          git add packages/shared/src/types/supabase-generated.ts
          echo "changes=$(git status --porcelain)" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.git_status.outputs.changes != ''
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat(types): update Supabase database types'
          title: '🔄 Update Supabase Database Types'
          body: |
            ## 🗄️ Database Types Update
            
            This PR contains automatically generated updates to Supabase database types.
            
            ### Changes
            - Updated `packages/shared/src/types/supabase-generated.ts`
            - Reflects latest database schema from Supabase
            
            ### Review Checklist
            - [ ] Verify no breaking changes to existing type contracts
            - [ ] Check that enhanced types in `supabase.ts` still work correctly  
            - [ ] Run tests to ensure type compatibility
            - [ ] Update any hardcoded type assumptions if needed
            
            ### Auto-generated
            This PR was created automatically by the `update-supabase-types` workflow.
            
            **Project ID**: `${{ env.PROJECT_REF }}`
            **Generated**: ${{ github.event.head_commit.timestamp }}
            
            🤖 Generated with [TenantFlow Type Automation](https://github.com/tenantflow/tenant-flow)
          branch: automated/update-supabase-types
          delete-branch: true
          labels: |
            enhancement
            types
            automated
            supabase

      - name: Comment on schema changes
        if: steps.git_status.outputs.changes != ''
        run: |
          echo "✅ Supabase types updated successfully!"
          echo "📋 Generated types for schema changes"
          echo "🔍 Review the PR for any breaking changes"

      - name: No changes detected
        if: steps.git_status.outputs.changes == ''
        run: |
          echo "✨ Database schema is up to date - no type changes needed"