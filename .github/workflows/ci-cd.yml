name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    uses: ./.github/workflows/lint.yml
    with:
      pnpm-version: '10.17.1'
      node-version: '22'
    secrets: inherit

  typecheck:
    uses: ./.github/workflows/typecheck.yml
    with:
      pnpm-version: '10.17.1'
      node-version: '22'
    secrets: inherit

  tests:
    needs: [lint, typecheck]
    uses: ./.github/workflows/tests.yml
    with:
      pnpm-version: '10.17.1'
      node-version: '22'
    secrets: inherit

  smoke:
    needs: tests
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/smoke.yml
    with:
      pnpm-version: '10.17.1'
      node-version: '20'
      playwright-grep: '@smoke'
      base-url: http://localhost:3940
    secrets: inherit

  deploy:
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/deploy.yml
    with:
      pnpm-version: '10.17.1'
      node-version: '22'
      vercel-environment: production
      healthcheck-url: https://api.tenantflow.app/health
    secrets: inherit
