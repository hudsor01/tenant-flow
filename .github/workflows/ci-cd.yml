name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PNPM_VERSION: '10.17.1'
  NODE_VERSION: '22'

jobs:
  lint:
    uses: ./.github/workflows/lint.yml
    with:
      pnpm-version: ${{ env.PNPM_VERSION }}
      node-version: ${{ env.NODE_VERSION }}

  typecheck:
    uses: ./.github/workflows/typecheck.yml
    with:
      pnpm-version: ${{ env.PNPM_VERSION }}
      node-version: ${{ env.NODE_VERSION }}

  tests:
    needs: [lint, typecheck]
    uses: ./.github/workflows/tests.yml
    with:
      pnpm-version: ${{ env.PNPM_VERSION }}
      node-version: ${{ env.NODE_VERSION }}
    secrets: inherit

  smoke:
    needs: tests
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/smoke.yml
    with:
      pnpm-version: ${{ env.PNPM_VERSION }}
      node-version: '20'
      playwright-grep: '@smoke'
      base-url: http://localhost:3940
    secrets: inherit

  deploy:
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/deploy.yml
    with:
      pnpm-version: ${{ env.PNPM_VERSION }}
      node-version: ${{ env.NODE_VERSION }}
      vercel-environment: production
      healthcheck-url: https://api.tenantflow.app/health
    secrets: inherit
