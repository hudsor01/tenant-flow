name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 4
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ðŸ”§ Installing dependencies..."
          npm ci --prefer-offline --no-audit --fund=false
          echo "âœ… Dependencies installed"
          
          echo "ðŸ”§ Generating Prisma client..."
          npx turbo run generate --filter=@repo/database
          echo "âœ… Prisma client generated"
          
          echo "ðŸ”§ Building packages..."
          npx turbo build --filter=@repo/shared
          npx turbo build --filter=@repo/backend
          echo "âœ… Packages built"
          
          echo "ðŸ”§ Installing Vercel CLI..."
          npm i -g vercel@latest
          echo "âœ… Vercel CLI installed"
          
          echo "ðŸ”§ Deploying to Vercel..."
          vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
          echo "âœ… Deployment completed"