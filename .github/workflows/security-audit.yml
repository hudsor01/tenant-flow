name: Security Audit Check

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
    workflow_dispatch:

jobs:
    security-audit:
        runs-on: ubuntu-latest
        name: Security Vulnerability Check

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run security audit
              run: |
                  echo "ðŸ” Running npm security audit..."
                  npm audit

                  echo ""
                  echo "ðŸ” Checking production dependencies..."
                  npm audit --omit=dev

                  echo ""
                  echo "ðŸ“‹ Verifying vulnerable package versions are fixed..."

                  # Check specific vulnerable packages
                  PATH_TO_REGEXP_VERSION=$(npm ls path-to-regexp --depth=0 --parseable | head -1 | xargs npm ls path-to-regexp --depth=100 | grep path-to-regexp@ | head -1 | sed 's/.*path-to-regexp@//')
                  ESBUILD_VERSION=$(npm ls esbuild --depth=0 --parseable | head -1 | xargs npm ls esbuild --depth=100 | grep esbuild@ | head -1 | sed 's/.*esbuild@//')  
                  UNDICI_VERSION=$(npm ls undici --depth=0 --parseable | head -1 | xargs npm ls undici --depth=100 | grep undici@ | head -1 | sed 's/.*undici@//')

                  echo "âœ… path-to-regexp version: $PATH_TO_REGEXP_VERSION (should be >=6.3.0)"
                  echo "âœ… esbuild version: $ESBUILD_VERSION (should be >=0.25.0)"  
                  echo "âœ… undici version: $UNDICI_VERSION (should be >=5.29.0)"

            - name: Create security summary
              if: always()
              run: |
                  echo "## ðŸ”’ Security Audit Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Run audit and capture results
                  if npm audit > audit_results.txt 2>&1; then
                    echo "âœ… **No vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "All dependencies are secure!" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ **Vulnerabilities detected**" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                    cat audit_results.txt >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Package Override Status" >> $GITHUB_STEP_SUMMARY
                  echo "- path-to-regexp: $(npm ls path-to-regexp 2>/dev/null | grep path-to-regexp@ | head -1 || echo 'Not found')" >> $GITHUB_STEP_SUMMARY
                  echo "- esbuild: $(npm ls esbuild 2>/dev/null | grep esbuild@ | head -1 || echo 'Not found')" >> $GITHUB_STEP_SUMMARY
                  echo "- undici: $(npm ls undici 2>/dev/null | grep undici@ | head -1 || echo 'Not found')" >> $GITHUB_STEP_SUMMARY
