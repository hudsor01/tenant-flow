name: Barrel File Check
on: [pull_request]

jobs:
  check-barrels:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for barrel/index imports
        run: |
          echo "Checking for forbidden barrel file imports..."

          # Find imports from index files (e.g., from './components' which resolves to index.ts)
          # or explicit index imports (e.g., from './components/index')

          VIOLATIONS=$(grep -rn --include="*.ts" --include="*.tsx" \
            -E "from ['\"](@repo/shared|\.\.?/[^'\"]+)/index['\"]" \
            apps/ packages/ 2>/dev/null || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "❌ Found explicit /index imports (use direct file imports instead):"
            echo "$VIOLATIONS"
            echo ""
            echo "Fix: Import from the specific file, not the index barrel."
            echo "Example: import { Property } from '@repo/shared/types/core' (not '@repo/shared/types/index')"
            exit 1
          fi

          # Check for @repo/shared barrel import (should use direct paths)
          BARREL_IMPORTS=$(grep -rn --include="*.ts" --include="*.tsx" \
            -E "from ['\"]@repo/shared['\"]" \
            apps/ 2>/dev/null || true)

          if [ -n "$BARREL_IMPORTS" ]; then
            echo "❌ Found barrel imports from @repo/shared (use direct path imports):"
            echo "$BARREL_IMPORTS"
            echo ""
            echo "Fix: Use direct path imports like '@repo/shared/types/core' instead of '@repo/shared'"
            exit 1
          fi

          echo "✅ No forbidden barrel imports found!"
