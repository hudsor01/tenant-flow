{"version":3,"file":"cors-config.js","sourceRoot":"","sources":["cors-config.ts"],"names":[],"mappings":"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","sourcesContent":["import { createLogger } from '../lib/frontend-logger.js'\n\nconst logger = createLogger({ component: 'CorsConfig' })\n\n/**\n * Unified CORS Configuration for TenantFlow\n * Ensures alignment between backend CORS and frontend CSP policies\n * Follows DRY/KISS/Native principles\n * Note: ENABLE_MOCK_AUTH disabled in production for real auth providers\n */\n\n/**\n * Get application domains from environment variables ONLY\n * NO HARDCODED URLS - ALL URLs MUST COME FROM ENVIRONMENT\n */\nfunction getApplicationDomains() {\n\t// Consider production only when explicitly set to 'production' or running on Vercel\n\tconst isProduction =\n\t\tprocess.env[\"NODE_ENV\"] === 'production' || process.env[\"VERCEL\"] === '1'\n\n\t// Get all URLs from environment variables only\n\tconst frontendUrl = process.env[\"NEXT_PUBLIC_APP_URL\"]\n\tconst backendUrl = process.env[\"NEXT_PUBLIC_API_BASE_URL\"]\n\n\tif (isProduction) {\n\t\t// Production: prefer env vars but don't throw during local builds.\n\t\t// If envs are missing, warn and fall back to localhost defaults so\n\t\t// a frontend production build can proceed in a developer environment.\n\t\tconst frontendList: string[] = []\n\t\tconst backendList: string[] = []\n\n\t\tif (frontendUrl) {\n\t\t\tfrontendList.push(\n\t\t\t\tfrontendUrl,\n\t\t\t\tfrontendUrl.replace('https://', 'https://www.')\n\t\t\t)\n\t\t}\n\t\tif (backendUrl) {\n\t\t\tbackendList.push(backendUrl)\n\t\t}\n\n\t\t// Fallback to known production domains if env vars are missing\n\t\tif (!frontendUrl || !backendUrl) {\n\t\t\t// Log a warning but do not throw â€” CI/deploy should still set these.\n\t\t\tlogger.warn(\n\t\t\t\t'Missing NEXT_PUBLIC_APP_URL or NEXT_PUBLIC_API_BASE_URL during production build; falling back to known production domains.'\n\t\t\t)\n\t\t\t// Known production domains for TenantFlow\n\t\t\tfrontendList.push('https://tenantflow.app', 'https://www.tenantflow.app')\n\t\t\tbackendList.push('https://api.tenantflow.app')\n\t\t}\n\n\t\treturn {\n\t\t\tFRONTEND: frontendList.filter(Boolean),\n\t\t\tBACKEND: backendList.filter(Boolean)\n\t\t}\n\t}\n\n\t// Development: Use environment variables or fail gracefully\n\tconst developmentOrigins = []\n\n\tif (frontendUrl) developmentOrigins.push(frontendUrl)\n\tif (backendUrl) developmentOrigins.push(backendUrl)\n\n\t// Always add localhost in non-production environments\n\tdevelopmentOrigins.push(\n\t\t'http://localhost:3000',\n\t\t'http://localhost:3001', // Next.js alternate port\n\t\t'http://localhost:4600'\n\t)\n\n\treturn {\n\t\tFRONTEND: developmentOrigins,\n\t\tBACKEND: developmentOrigins\n\t}\n}\n\n// Dynamic domains based on environment\nexport const APP_DOMAINS = getApplicationDomains()\n\n/**\n * Get CORS allowed origins for backend\n */\nexport function getCORSOrigins(\n\tenvironment: 'development' | 'production' = 'production'\n): string[] | boolean {\n\tif (environment === 'development') {\n\t\t// SECURITY FIX: Use specific origins even in development\n\t\treturn [...APP_DOMAINS.FRONTEND, ...APP_DOMAINS.BACKEND]\n\t}\n\n\treturn [\n\t\t...APP_DOMAINS.FRONTEND,\n\t\t// Allow API calls from the same domain (for server-side operations)\n\t\t...APP_DOMAINS.BACKEND\n\t]\n}\n\n/**\n * Get environment-appropriate CORS origins\n * Ensures Vercel builds use production configuration\n */\nexport function getCORSOriginsForEnv(): string[] | boolean {\n\t// Consider production only when explicitly set to 'production' or running on Vercel\n\tconst isProduction =\n\t\tprocess.env[\"NODE_ENV\"] === 'production' || process.env[\"VERCEL\"] === '1'\n\n\tconst env = isProduction ? 'production' : 'development'\n\treturn getCORSOrigins(env)\n}\n\n/**\n * CORS configuration object for Express\n */\nexport function getCORSConfig() {\n\treturn {\n\t\torigin: getCORSOriginsForEnv(),\n\t\tcredentials: true,\n\t\tmethods: ['GET', 'HEAD', 'PUT', 'PATCH', 'POST', 'DELETE', 'OPTIONS'],\n\t\tallowedHeaders: [\n\t\t\t'Origin',\n\t\t\t'X-Requested-With',\n\t\t\t'Content-Type',\n\t\t\t'Accept',\n\t\t\t'Authorization',\n\t\t\t'X-CSRF-Token',\n\t\t\t'X-XSRF-Token'\n\t\t]\n\t}\n}\n"]}