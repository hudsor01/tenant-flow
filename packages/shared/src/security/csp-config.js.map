{"version":3,"file":"csp-config.js","sourceRoot":"","sources":["csp-config.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Unified CSP Configuration for TenantFlow\n * Single source of truth for Content Security Policy directives\n * Follows DRY/KISS/Native principles - consolidates 3 separate CSP definitions\n */\n\nimport type { CSPDirectives } from '../types/security.js'\nimport { APP_DOMAINS } from './cors-config.js'\n\n// Environment-based CSP domains\nexport const CSP_DOMAINS = {\n\t// Core application domains (aligned with CORS config)\n\tAPI_DOMAINS: [...APP_DOMAINS.BACKEND],\n\n\t// Third-party services (production)\n\tSTRIPE: [\n\t\t'https://js.stripe.com',\n\t\t'https://api.stripe.com',\n\t\t'https://checkout.stripe.com'\n\t],\n\n\tSUPABASE: ['https://bshjmbshupiibfiewpxb.supabase.co'],\n\n\tGOOGLE: [\n\t\t'https://fonts.googleapis.com',\n\t\t'https://fonts.gstatic.com',\n\t\t'https://maps.googleapis.com',\n\t\t'https://lh3.googleusercontent.com'\n\t],\n\n\t// Development/build tools (only in non-production)\n\tVERCEL_DEV: ['https://vercel.live', 'https://*.vercel-scripts.com'],\n\n\t// Vercel analytics and speed insights\n\tVERCEL_ANALYTICS: [\n\t\t'https://*.vercel-insights.com',\n\t\t'https://*.speed-insights.com',\n\t\t'https://*.vercel-spdinsghts.com'\n\t],\n\n\t// Image sources\n\tIMAGES: ['https://images.unsplash.com', 'data:', 'blob:'],\n\n\t// External APIs\n\tZIP_API: ['http://api.zippopotam.us', 'https://api.zippopotam.us'],\n\n\t// CDN for browser-image-compression library\n\tCDN: ['https://cdn.jsdelivr.net']\n} as const\n\n/**\n * Generate CSP directives based on environment\n */\nexport function generateCSPDirectives(\n\tenvironment: 'development' | 'production' = 'production'\n): CSPDirectives {\n\tconst isDev = environment === 'development'\n\n\treturn {\n\t\t'default-src': [\"'self'\"],\n\n\t\t'script-src': [\n\t\t\t\"'self'\",\n\t\t\t\"'unsafe-inline'\", // Required for Next.js and some libraries\n\t\t\t\"'unsafe-eval'\", // Required for development and some libraries\n\t\t\t...CSP_DOMAINS.STRIPE,\n\t\t\t...CSP_DOMAINS.GOOGLE,\n\t\t\t...CSP_DOMAINS.CDN, // Allow jsdelivr CDN for browser-image-compression\n\t\t\t...(isDev ? CSP_DOMAINS.VERCEL_DEV : [])\n\t\t],\n\n\t\t'style-src': [\n\t\t\t\"'self'\",\n\t\t\t\"'unsafe-inline'\", // Required for Tailwind CSS and component libraries\n\t\t\t...CSP_DOMAINS.GOOGLE\n\t\t],\n\n\t\t'font-src': [\n\t\t\t\"'self'\",\n\t\t\t'data:', // Required for icon fonts\n\t\t\t...CSP_DOMAINS.GOOGLE\n\t\t],\n\n\t\t'img-src': [\n\t\t\t\"'self'\",\n\t\t\t'https:', // Allow all HTTPS images (common for user uploads)\n\t\t\t...CSP_DOMAINS.IMAGES,\n\t\t\t...CSP_DOMAINS.GOOGLE,\n\t\t\t...CSP_DOMAINS.SUPABASE\n\t\t],\n\n\t\t'connect-src': [\n\t\t\t\"'self'\",\n\t\t\t...CSP_DOMAINS.API_DOMAINS,\n\t\t\t...CSP_DOMAINS.SUPABASE,\n\t\t\t...CSP_DOMAINS.STRIPE,\n\t\t\t...CSP_DOMAINS.ZIP_API,\n\t\t\t...CSP_DOMAINS.VERCEL_ANALYTICS\n\t\t],\n\n\t\t'frame-src': [\"'self'\", ...CSP_DOMAINS.STRIPE],\n\n\t\t// Allow same-origin and blobs for web workers (e.g. data visualizations)\n\t\t'worker-src': [\"'self'\", 'blob:'],\n\n\t\t'object-src': [\"'none'\"], // Prevent object/embed/applet for security\n\n\t\t'base-uri': [\"'self'\"],\n\n\t\t'form-action': [\"'self'\"],\n\n\t\t// Prevent clickjacking in production, allow in development for localhost\n\t\t'frame-ancestors': isDev ? [\"'self'\"] : [\"'none'\"],\n\n\t\t'upgrade-insecure-requests': true,\n\n\t\t'block-all-mixed-content': false // Let upgrade-insecure-requests handle it\n\t}\n}\n\n/**\n * Convert CSP directives to string format\n */\nexport function cspDirectivesToString(directives: CSPDirectives): string {\n\tconst parts: string[] = []\n\n\tfor (const [key, value] of Object.entries(directives)) {\n\t\tif (key === 'upgrade-insecure-requests' && value) {\n\t\t\tparts.push('upgrade-insecure-requests')\n\t\t} else if (key === 'block-all-mixed-content' && value) {\n\t\t\tparts.push('block-all-mixed-content')\n\t\t} else if (Array.isArray(value) && value.length > 0) {\n\t\t\tparts.push(`${key} ${value.join(' ')}`)\n\t\t}\n\t}\n\n\treturn parts.join('; ')\n}\n\n/**\n * Get production CSP string (most secure)\n */\nexport function getProductionCSP(): string {\n\treturn cspDirectivesToString(generateCSPDirectives('production'))\n}\n\n/**\n * Get development CSP string (includes dev tools)\n */\nexport function getDevelopmentCSP(): string {\n\treturn cspDirectivesToString(generateCSPDirectives('development'))\n}\n\n/**\n * Get environment-appropriate CSP string\n */\nexport function getCSPString(\n\tenvironment?: 'development' | 'production'\n): string {\n\tconst env =\n\t\tenvironment ||\n\t\t(process.env[\"NODE_ENV\"] === 'development' ? 'development' : 'production')\n\treturn cspDirectivesToString(generateCSPDirectives(env))\n}\n"]}