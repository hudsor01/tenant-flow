# TenantFlow Stripe Objects Documentation

This documentation covers all Stripe objects implemented in TenantFlow, focusing only on features we actively use for our platform billing system.

## Core Stripe Objects

### Customer Object

The Customer object represents your customer in Stripe, containing their payment information, billing details, and subscription history.

**Key attributes for TenantFlow:**

- `id` - Unique Stripe customer identifier
- `email` - Customer's email address
- `name` - Customer's full name or business name
- `metadata` - Custom data (we store TenantFlow user ID here)
- `default_source` - Default payment method
- `subscriptions` - Active subscriptions
- `invoice_settings` - Billing preferences

### Price Object

Price objects define how much and how often to charge for products. Each plan tier has associated monthly and annual prices.

**Key attributes for TenantFlow:**

- `id` - Unique price identifier (our plan mapping)
- `product` - Associated product ID
- `unit_amount` - Price in cents
- `currency` - Billing currency (USD)
- `recurring.interval` - 'month' or 'year'
- `recurring.usage_type` - 'licensed' (fixed quantity)
- `active` - Whether price can be used for new subscriptions

### Product Object

Product objects represent the goods or services you offer. We have one product per plan tier.

**Key attributes for TenantFlow:**

- `id` - Unique product identifier
- `name` - Plan name (e.g., "TenantFlow Starter")
- `description` - Plan description and features
- `active` - Whether product is available
- `metadata` - Custom plan configuration data

### Invoice Object

Invoices represent amounts owed by customers, either one-off charges or generated by subscriptions.

**Key attributes for TenantFlow:**

- `id` - Unique invoice identifier
- `customer` - Customer who owes the amount
- `subscription` - Associated subscription (if applicable)
- `status` - 'draft', 'open', 'paid', 'uncollectible', 'void'
- `amount_due` - Total amount owed
- `period_start`/`period_end` - Billing period
- `hosted_invoice_url` - Customer-accessible invoice page

### Customer Session Object

Customer Sessions provide secure, limited access for client-side operations without exposing sensitive customer data.

**Key attributes for TenantFlow:**

- `client_secret` - Secure token for client-side use
- `customer` - Associated customer ID
- `expires_at` - Session expiration timestamp
- `components` - Enabled client-side features (payment_element, pricing_table)

## Core Subscription Features

### Subscription Status Types

We handle the following Stripe subscription statuses:

```typescript
export type SubscriptionStatus =
	| 'incomplete' // Initial subscription creation, awaiting payment
	| 'incomplete_expired' // Failed to complete initial setup
	| 'trialing' // In trial period
	| 'active' // Active and current
	| 'past_due' // Payment failed, in grace period
	| 'canceled' // Cancelled subscription
	| 'unpaid' // Cancelled due to non-payment
	| 'paused' // Paused by customer
```

### Collection Methods

TenantFlow uses automatic payment collection:

- `charge_automatically` - Stripe attempts payment using saved payment method
- `send_invoice` - Send invoice for manual payment (not currently used)

### Billing Periods

Supported billing intervals:

- `month` - Monthly billing
- `year` - Annual billing

## Subscription Object Properties (TenantFlow Implementation)

### Core Identification

- `id` - Unique Stripe subscription identifier
- `customer` - Stripe Customer ID
- `status` - Current subscription status (see types above)

### Billing Configuration

- `billing_cycle_anchor` - Timestamp for billing cycle alignment
- `collection_method` - Set to `charge_automatically`
- `currency` - Three-letter ISO currency code (USD)
- `current_period_start` - Start of current billing period
- `current_period_end` - End of current billing period

### Plan & Pricing

- `items` - Array of subscription items with price details
    - `price.id` - Stripe Price ID
    - `price.recurring.interval` - Billing frequency ('month' or 'year')
    - `price.unit_amount` - Price in cents
    - `quantity` - Number of units (typically 1)

### Trial Management

- `trial_start` - Trial period start date
- `trial_end` - Trial period end date
- `trial_settings.end_behavior.missing_payment_method` - Trial end behavior

### Cancellation

- `cancel_at_period_end` - Whether to cancel at period end
- `canceled_at` - Cancellation timestamp
- `cancellation_details` - Cancellation reason and feedback

### Payment Settings

- `default_payment_method` - Default payment method ID
- `payment_settings.save_default_payment_method` - Auto-save payment methods

## TenantFlow Plan Types

We implement a 4-tier subscription system:

```typescript
export const PLAN_TYPES = {
	FREETRIAL: 'FREETRIAL', // Free trial period
	STARTER: 'STARTER', // Basic plan
	GROWTH: 'GROWTH', // Professional plan
	TENANTFLOW_MAX: 'TENANTFLOW_MAX' // Enterprise plan
} as const
```

## Webhook Events (Implemented)

TenantFlow processes these Stripe webhook events:

### Subscription Events

- `customer.subscription.created` - New subscription
- `customer.subscription.updated` - Plan changes, status updates
- `customer.subscription.deleted` - Subscription cancelled
- `customer.subscription.trial_will_end` - Trial ending soon

### Payment Events

- `invoice.payment_succeeded` - Successful payment
- `invoice.payment_failed` - Payment failure
- `checkout.session.completed` - Checkout completion

## Implementation Examples

### Creating a Customer

```typescript
// Create a new Stripe customer
const customer = await stripe.customers.create({
	email: user.email,
	name: user.name,
	metadata: {
		tenantflow_user_id: user.id,
		tenantflow_organization_id: user.organizationId,
		tenantflow_environment: 'production'
	}
})
```

### Creating Products and Prices

```typescript
// Create a product for a plan tier
const product = await stripe.products.create({
	name: 'TenantFlow Starter',
	description: 'Perfect for small property managers',
	metadata: {
		tenantflow_plan_type: 'STARTER',
		tenantflow_property_limit: '5',
		tenantflow_features: 'basic_reporting,email_support'
	}
})

// Create monthly and annual prices
const monthlyPrice = await stripe.prices.create({
	product: product.id,
	unit_amount: 2900, // $29.00
	currency: 'usd',
	recurring: {
		interval: 'month',
		usage_type: 'licensed'
	},
	lookup_key: 'starter_monthly',
	metadata: {
		tenantflow_plan_type: 'STARTER',
		tenantflow_billing_period: 'monthly'
	}
})

const annualPrice = await stripe.prices.create({
	product: product.id,
	unit_amount: 29000, // $290.00 (2 months free)
	currency: 'usd',
	recurring: {
		interval: 'year',
		usage_type: 'licensed'
	},
	lookup_key: 'starter_annual',
	metadata: {
		tenantflow_plan_type: 'STARTER',
		tenantflow_billing_period: 'annual'
	}
})
```

### Creating a Subscription

```typescript
interface CreateSubscriptionParams {
	userId: string
	planType: PlanType
	billingInterval: 'monthly' | 'annual'
	successUrl: string
	cancelUrl: string
	priceId?: string
}

// Creates Stripe Checkout Session for subscription signup
const session = await stripe.checkout.sessions.create({
	mode: 'subscription',
	customer: stripeCustomerId,
	line_items: [
		{
			price: priceId,
			quantity: 1
		}
	],
	success_url: successUrl,
	cancel_url: cancelUrl,
	subscription_data: {
		trial_period_days: 14, // Free trial
		metadata: {
			tenantflow_user_id: userId,
			tenantflow_plan_type: planType,
			tenantflow_billing_period: billingInterval
		}
	}
})
```

### Handling Subscription Updates

```typescript
// Webhook handler for subscription.updated
async handleSubscriptionUpdate(event: Stripe.Event) {
  const subscription = event.data.object as StripeSubscription

  await this.updateUserSubscription({
    stripeSubscriptionId: subscription.id,
    status: subscription.status,
    currentPeriodStart: new Date(subscription.current_period_start * 1000),
    currentPeriodEnd: new Date(subscription.current_period_end * 1000),
    cancelAtPeriodEnd: subscription.cancel_at_period_end,
    planType: this.determinePlanType(subscription.items.data[0].price.id)
  })
}
```

### Processing Invoice Events

```typescript
// Webhook handler for invoice.payment_succeeded
async handleInvoicePaymentSucceeded(event: Stripe.Event) {
  const invoice = event.data.object as Stripe.Invoice

  // Update subscription status and send confirmation
  await this.recordSuccessfulPayment({
    invoiceId: invoice.id,
    customerId: invoice.customer as string,
    amountPaid: invoice.amount_paid,
    currency: invoice.currency,
    subscriptionId: invoice.subscription as string,
    periodStart: new Date(invoice.period_start * 1000),
    periodEnd: new Date(invoice.period_end * 1000)
  })

  // Send payment confirmation email
  await this.sendPaymentConfirmationEmail(invoice)
}

// Webhook handler for invoice.payment_failed
async handleInvoicePaymentFailed(event: Stripe.Event) {
  const invoice = event.data.object as Stripe.Invoice

  // Update subscription to past_due and notify customer
  await this.handleFailedPayment({
    invoiceId: invoice.id,
    customerId: invoice.customer as string,
    amountDue: invoice.amount_due,
    attemptCount: invoice.attempt_count,
    nextPaymentAttempt: invoice.next_payment_attempt
  })
}
```

### Customer Portal Access

```typescript
// Generate customer portal URL for self-service
const portalSession = await stripe.billingPortal.sessions.create({
	customer: stripeCustomerId,
	return_url: 'https://tenantflow.app/billing'
})
```

### Customer Session for Client-Side Operations

```typescript
// Create a customer session for client-side payment element
const customerSession = await stripe.customerSessions.create({
	customer: stripeCustomerId,
	components: {
		payment_element: {
			enabled: true,
			features: {
				payment_method_save: 'enabled',
				payment_method_remove: 'enabled'
			}
		}
	}
})

// Use in frontend
const { client_secret } = customerSession
// Pass client_secret to Stripe.js for payment element initialization
```

## Error Handling

Common subscription errors we handle:

- `subscription_not_found` - Invalid subscription ID
- `customer_not_found` - Invalid customer ID
- `invalid_price_id` - Price not found or inactive
- `payment_declined` - Payment method declined
- `authentication_failed` - Invalid API keys

## TypeScript Type Definitions

See the complete type definitions in our codebase:

- `/packages/shared/src/types/stripe.ts` - Core Stripe types and constants
- `/packages/shared/src/types/stripe-core-objects.ts` - Detailed object type definitions
- `/packages/shared/src/types/stripe-subscription-enhanced.ts` - Enhanced subscription types
- `/packages/shared/src/types/billing.ts` - TenantFlow billing-specific types

### Key Type Exports

```typescript
// Core objects
import {
	StripeCustomer,
	StripePrice,
	StripeProduct,
	StripeInvoice,
	StripeCustomerSession
} from '@repo/shared/types/stripe-core-objects'

// Subscription types
import {
	StripeSubscription,
	SubscriptionStatus,
	CollectionMethod,
	BillingInterval
} from '@repo/shared/types/stripe'

// TenantFlow specific
import {
	PlanType,
	UserSubscription,
	BillingPeriod
} from '@repo/shared/types/billing'
```

## Usage Limits & Plan Enforcement

Each plan has usage limits that we enforce:

```typescript
interface PlanLimits {
	properties: number // Max properties per user
	tenants: number // Max tenants per property
	storage: number // Storage limit in MB
	apiCalls: number // API calls per month
}
```

## Best Practices

1. **Always use webhooks** for subscription status updates
2. **Handle idempotency** with Stripe's idempotency keys
3. **Validate webhook signatures** for security
4. **Store minimal Stripe data** - use IDs for references
5. **Handle partial failures** gracefully
6. **Implement retry logic** for API calls
7. **Test with Stripe's test mode** extensively

## Related Documentation

### TenantFlow Documentation

- [`stripe-payment-objects.md`](./stripe-payment-objects.md) - Payment processing objects (Payment Methods, Checkout Sessions, Payment Intents)
- [`stripe-api-patterns.md`](./stripe-api-patterns.md) - Pagination, error handling, object expansion patterns
- [`stripe-api-best-practices.md`](./stripe-api-best-practices.md) - Essential API concepts (idempotency, metadata, request IDs)
- [`/types/stripe.ts`](../types/stripe.ts) - Core Stripe types and constants
- [`/types/stripe-core-objects.ts`](../types/stripe-core-objects.ts) - Detailed object definitions
- [`/types/stripe-payment-objects.ts`](../types/stripe-payment-objects.ts) - Payment object type definitions
- [`/types/stripe-api-patterns.ts`](../types/stripe-api-patterns.ts) - API patterns type definitions
- [`/types/billing.ts`](../types/billing.ts) - TenantFlow billing types

### Official Stripe Documentation

- [Stripe Subscriptions API](https://stripe.com/docs/api/subscriptions)
- [Stripe Billing Portal](https://stripe.com/docs/billing/subscriptions/customer-portal)
- [Stripe Webhooks](https://stripe.com/docs/webhooks)
- [Idempotent Requests](https://stripe.com/docs/api/idempotent_requests)
- [Metadata](https://stripe.com/docs/api/metadata)
- [Request IDs](https://stripe.com/docs/api/request_ids)
