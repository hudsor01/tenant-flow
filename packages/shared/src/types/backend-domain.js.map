{"version":3,"file":"backend-domain.js","sourceRoot":"","sources":["backend-domain.ts"],"names":[],"mappings":"","sourcesContent":["/**\n * BACKEND DOMAIN TYPES\n *\n * Consolidated backend-specific types for controllers, services, and routing\n * Merged from: backend.ts, router.ts, database.ts, and other backend files\n */\n\nimport type { Database } from './supabase-generated.js'\nimport type { Request, Response } from 'express'\nimport type { HttpMethod } from './core.js'\nimport type { ServiceHealth } from './health.js'\nimport type {\n\tCreatePropertyRequest,\n\tUpdatePropertyRequest,\n\tCreateUnitRequest,\n\tUpdateUnitRequest,\n\tCreateTenantRequest,\n\tUpdateTenantRequest,\n\tCreateLeaseRequest,\n\tUpdateLeaseRequest,\n\tCreateMaintenanceRequest,\n\tUpdateMaintenanceRequest\n} from './api-contracts.js'\n\n// Re-export request types for backward compatibility\nexport type {\n\tCreatePropertyRequest,\n\tUpdatePropertyRequest,\n\tCreateUnitRequest,\n\tUpdateUnitRequest,\n\tCreateTenantRequest,\n\tUpdateTenantRequest,\n\tCreateLeaseRequest,\n\tUpdateLeaseRequest,\n\tCreateMaintenanceRequest,\n\tUpdateMaintenanceRequest\n}\n\nexport interface TypeProvider {\n\toutput: Record<string, unknown>\n\tinput: Record<string, unknown>\n}\n\nexport interface ExpressTypeProvider extends TypeProvider {\n\toutput: Record<string, unknown>\n\tinput: Record<string, unknown>\n\tserializer?: {\n\t\tfromArray: (array: unknown[]) => unknown\n\t\tfromObject: (object: Record<string, unknown>) => unknown\n\t}\n}\n\nexport interface JSONSchema {\n\ttype?: string | string[]\n\tproperties?: Record<string, JSONSchema>\n\trequired?: string[]\n\tadditionalProperties?: boolean | JSONSchema\n\titems?: JSONSchema\n\tenum?: unknown[]\n\tformat?: string\n\tpattern?: string\n\tminimum?: number\n\tmaximum?: number\n\tminLength?: number\n\tmaxLength?: number\n\tdescription?: string\n\toneOf?: JSONSchema[]\n\tanyOf?: JSONSchema[]\n\tallOf?: JSONSchema[]\n\t$ref?: string\n\texamples?: unknown[]\n\tdefault?: unknown\n}\n\nexport type authUser = Database['public']['Tables']['users']['Row']\n\nexport interface Context {\n\treq: Request\n\tres: Response\n\tuser?: authUser\n}\n\nexport type AuthenticatedContext = Context & { user: authUser }\n\nexport interface RequestContext {\n\trequestId: string\n\tuserId?: string\n\torganizationId?: string\n\tstartTime: Date\n\tmetadata: Record<string, unknown>\n}\n\nexport interface UserProfileResponse {\n\tid: string\n\temail: string\n\tname: string\n\tcompany?: string\n\tphone?: string\n\tbio?: string\n\tavatarUrl?: string\n\temailVerified: boolean\n\tcreatedAt: string\n\tupdatedAt: string\n}\n\n/**\n * Lease input for service layer operations\n * Centralized type to avoid inline definitions\n */\nexport interface LeaseInput {\n\ttenantId: string\n\tunitId: string\n\tstartDate: string\n\tendDate: string\n\trentAmount: number\n\tsecurityDeposit?: number\n\tstatus: Database['public']['Enums']['LeaseStatus']\n}\n\n// SECURITY TYPES\n\nexport interface SanitizationConfig {\n\tenabled: boolean\n\tmaxDepth: number\n\tmaxStringLength: number\n\tmaxArrayLength: number\n\tmaxObjectKeys: number\n\tallowHTML: boolean\n\tstrictMode: boolean\n}\n\nexport interface ThreatPattern {\n\tname: string\n\tpattern: RegExp\n\tseverity: 'low' | 'medium' | 'high'\n\tblock: boolean\n}\n\nexport interface SecurityHeadersConfig {\n\tcsp: {\n\t\tenabled: boolean\n\t\treportOnly: boolean\n\t\treportUri?: string\n\t}\n\thsts: {\n\t\tenabled: boolean\n\t\tmaxAge: number\n\t\tincludeSubDomains: boolean\n\t\tpreload: boolean\n\t}\n\tframeOptions: 'DENY' | 'SAMEORIGIN'\n\tcontentTypeOptions: boolean\n\txssProtection: boolean\n\treferrerPolicy: string\n\tpermissionsPolicy: Record<string, string[]>\n}\n\ntype MaintenanceRequest =\n\tDatabase['public']['Tables']['maintenance_request']['Row']\ntype Property = Database['public']['Tables']['property']['Row']\ntype Tenant = Database['public']['Tables']['tenant']['Row']\ntype Unit = Database['public']['Tables']['unit']['Row']\ntype Lease = Database['public']['Tables']['lease']['Row']\n\n// Maintenance router outputs\nexport interface MaintenanceRequestListOutput {\n\trequests: MaintenanceRequest[]\n\ttotal: number\n\tpage: number\n\tlimit: number\n}\n\nexport interface MaintenanceRequestDetailOutput {\n\trequest: MaintenanceRequest\n}\n\n// Property router outputs\nexport interface PropertyListOutput {\n\tproperties: Property[]\n\ttotal: number\n\tpage: number\n\tlimit: number\n}\n\nexport interface PropertyDetailOutput {\n\tproperty: Property\n\tunits?: Unit[]\n\ttenants?: Tenant[]\n}\n\n// Tenant router outputs\nexport interface TenantListOutput {\n\ttenants: Tenant[]\n\ttotal: number\n\tpage: number\n\tlimit: number\n}\n\nexport interface TenantDetailOutput {\n\ttenant: Tenant\n\tleases?: Lease[]\n\tcurrentLease?: Lease\n}\n\n// Unit router outputs\nexport interface UnitListOutput {\n\tunits: Unit[]\n\ttotal: number\n\tpage: number\n\tlimit: number\n}\n\nexport interface UnitDetailOutput {\n\tunit: Unit\n\tproperty?: Property\n\tcurrentTenant?: Tenant\n\tcurrentLease?: Lease\n}\n\n// Lease router outputs\nexport interface LeaseListOutput {\n\tleases: Lease[]\n\ttotal: number\n\tpage: number\n\tlimit: number\n}\n\nexport interface LeaseDetailOutput {\n\tlease: Lease\n\ttenant?: Tenant\n\tunit?: Unit\n\tproperty?: Property\n}\n\n// DATABASE OPTIMIZATION TYPES\n\nexport interface DatabaseOptimizationOptions {\n\tanalyzeQueries: boolean\n\trecommendIndexes: boolean\n\tvacuumTables: boolean\n\tupdateStatistics: boolean\n}\n\nexport interface IndexRecommendation {\n\ttable: string\n\tcolumns: string[]\n\treason: string\n\timpact: 'high' | 'medium' | 'low'\n}\n\nexport interface QueryPerformanceMetric {\n\tquery: string\n\texecutionTime: number\n\trowsReturned: number\n\ttablesUsed: string[]\n}\n\n// Note: PerformanceMetrics interface moved to health.ts to resolve conflicts\n\nexport type { HealthCheckResponse } from './health'\n\n// Row describing index usage metrics (derived from pg_stat_* views or RPC)\nexport interface DbIndexUsageRow {\n\tschemaname: string\n\ttablename: string\n\tindexname: string\n\tscans: number\n\ttuples_read: number\n\ttuples_fetched: number\n\tsize: string\n}\n\n// Row describing slow query statistics (typically from pg_stat_statements)\nexport interface DbSlowQueryRow {\n\tquery: string\n\tcalls: number\n\ttotal_time: number\n\tmean_time: number\n\trows: number\n\thit_percent: number\n}\n\n// Aggregated, normalized DB health metrics returned by backend\nexport interface DbHealthMetrics {\n\tconnections: number\n\tcache_hit_ratio: number\n\ttable_sizes: { table_name: string; size: string; row_count: number }[]\n\tindex_sizes: { index_name: string; size: string; table_name: string }[]\n}\n\n// Overview payload shape produced by performance RPCs (optional sections)\nexport interface DbPerformanceOverview {\n\tindex_usage?: unknown\n\tslow_queries?: unknown\n\thealth?: unknown\n\t[k: string]: unknown\n}\n\nexport interface AppConfig {\n\tport: number\n\thost: string\n\tenv: 'development' | 'production' | 'test'\n\tapiVersion: string\n\tcorsOrigins: string[]\n}\n\nexport interface DatabaseConfig {\n\turl: string\n\tpoolMin: number\n\tpoolMax: number\n\tssl: boolean\n}\n\nexport interface SupabaseConfig {\n\turl: string\n\tsupabaseKey: string\n\tjwtSecret: string\n\tpublishableKey: string\n}\n\nexport interface StripeConfig {\n\tsecretKey: string\n\twebhookSecret: string\n\tpublishableKey?: string\n}\n\nexport interface FullConfig {\n\tapp: AppConfig\n\tdatabase: DatabaseConfig\n\tsupabase: SupabaseConfig\n\tstripe: StripeConfig\n}\n\n// Security audit types\nexport interface EndpointAudit {\n\tcontroller: string\n\tmethod: string\n\tpath: string\n\thttpMethod: string\n\tisPublic: boolean\n\trequiredRoles: string[]\n\tadminOnly: boolean\n\thasRateLimit: boolean\n\tsecurityRisk: 'low' | 'medium' | 'high' | 'critical'\n\trecommendations: string[]\n\tdescription?: string\n}\n\nexport interface SecurityAuditReport {\n\ttimestamp: string\n\ttotalEndpoints: number\n\tpublicEndpoints: number\n\tprotectedEndpoints: number\n\thighRiskEndpoints: number\n\tcriticalRiskEndpoints: number\n\tendpoints: EndpointAudit[]\n\tsummary: {\n\t\tpublicEndpointsRatio: number\n\t\tauthenticationCoverage: number\n\t\trateLimitCoverage: number\n\t\tadminAccessPoints: number\n\t\toverallRisk: 'low' | 'medium' | 'high' | 'critical'\n\t\trecommendations: string[]\n\t}\n}\n\nexport type CacheInvalidationReason =\n\t| 'ttl_expired'\n\t| 'manual'\n\t| 'circuit_breaker_opened'\n\t| 'memory_pressure'\n\t| 'tag_invalidation'\n\nexport type CacheableEntityType =\n\t| 'property'\n\t| 'unit'\n\t| 'tenant'\n\t| 'lease'\n\t| 'maintenance'\n\nexport interface EndpointInfo {\n\tcontroller: string\n\tmethod: string\n\tpath: string\n\thttpMethod: string\n\tfilePath?: string\n\tline?: number\n}\n\n// Script-specific audit result\nexport interface EndpointAudit {\n\tcontroller: string\n\tmethod: string\n\tpath: string\n\thttpMethod: string\n\tisPublic: boolean\n\trequiredRoles: string[]\n\tadminOnly: boolean\n\thasRateLimit: boolean\n\tsecurityRisk: 'low' | 'medium' | 'high' | 'critical'\n\trecommendations: string[]\n\tdescription?: string\n}\n\n// ERROR BOUNDARY TYPES\n\nexport interface CircuitState {\n\tisOpen: boolean\n\tfailureCount: number\n\tlastFailureTime: number\n\tlastSuccessTime: number\n\tnextAttemptTime: number\n}\n\nexport interface ServiceMetrics {\n\ttotalRequests: number\n\tsuccessCount: number\n\tfailureCount: number\n\tavgResponseTime: number\n\tlastError?: string\n\tlastErrorTime?: number\n}\n\n// SECURITY MONITORING TYPES\nexport type { SecurityEvent } from './security'\n\nexport type SecurityEventType =\n\t| 'unauthorized_access'\n\t| 'rate_limit_exceeded'\n\t| 'suspicious_pattern'\n\t| 'sql_injection_attempt'\n\t| 'xss_attempt'\n\t| 'csrf_violation'\n\t| 'authentication_failure'\n\t| 'authorization_failure'\n\t| 'data_breach_attempt'\n\t| 'brute_force_attempt'\n\t| 'session_hijack_attempt'\n\t| 'api_abuse'\n\t| 'malformed_request'\n\t| 'file_upload_violation'\n\t| 'cors_violation'\n\t| 'malicious_request'\n\t| 'suspicious_activity'\n\t| 'account_takeover'\n\t| 'auth_failure'\n\n// SECURITY EXCEPTION FILTER TYPES\n\nexport type { ErrorResponse } from './errors'\n\nexport interface SecurityErrorContext {\n\tip: string\n\tuserAgent?: string\n\tuserId?: string\n\tendpoint: string\n\tmethod: string\n\ttimestamp: string\n\terrorType: string\n\tstatusCode: number\n}\n\n// STRIPE SUBSCRIPTION TYPES\n\nexport type StripeSubscriptionStatus =\n\t| 'ACTIVE'\n\t| 'CANCELED'\n\t| 'TRIALING'\n\t| 'PAST_DUE'\n\t| 'UNPAID'\n\t| 'INCOMPLETE'\n\t| 'INCOMPLETE_EXPIRED'\n\n// Authenticated request with user attached\nexport interface AuthenticatedRequest extends Request {\n\tuser: authUser\n\tstartTime?: number\n\tid?: string\n}\n\n// Raw request body for webhooks\nexport interface RawBodyRequest extends Request {\n\trawBody?: Buffer\n}\n\n// Combined authenticated request with raw body support\nexport interface AuthenticatedRawRequest extends AuthenticatedRequest {\n\trawBody?: Buffer\n}\n\n// Organization-scoped request\nexport interface OrganizationRequest extends AuthenticatedRequest {\n\torganizationId: string\n}\n\n// Request with timing information\nexport interface TimedRequest extends Request {\n\tstartTime: number\n\tduration?: number\n\tid?: string\n}\n\n// Security context for request monitoring\nexport interface SecurityContextRequest extends Request {\n\tsecurityContext?: {\n\t\triskLevel: 'low' | 'medium' | 'high'\n\t\tthreatIndicators: string[]\n\t\tblockRequests: boolean\n\t}\n}\n\n// Request with user attached - Re-export from auth.ts (primary source)\nexport type { RequestWithUser, ThrottlerRequest } from './auth.js'\n\n// Rate limiting interfaces\nexport interface RateLimitWindow {\n\trequests: number\n\tresetTime: number\n}\n\nexport interface RateLimitConfig {\n\twindowMs: number\n\tmaxRequests: number\n\tkeyGenerator?: (req: Request) => string\n\tskipSuccessfulRequests?: boolean\n\tskipFailedRequests?: boolean\n}\n\nexport interface RequestWithTiming extends Request {\n\tstartTime?: number\n\tid?: string\n}\n\n// Renamed from PerformanceMetrics to avoid conflict with health.ts endpoint metrics\nexport interface SystemPerformanceMetrics {\n\tuptime: number\n\tmemory: {\n\t\tused: number\n\t\tfree: number\n\t\tusagePercentage: number\n\t}\n\tcpu: {\n\t\tuser: number\n\t\tsystem: number\n\t}\n\trequests: {\n\t\ttotal: number\n\t\tsuccessful: number\n\t\tfailed: number\n\t\tavgResponseTime: number\n\t}\n}\n\nexport interface CircuitBreakerStatus {\n\ttimestamp: string\n\tservices: Record<string, ServiceHealth>\n\toverall: 'healthy' | 'degraded' | 'unhealthy'\n}\n\n// STRIPE WEBHOOK AND BILLING TYPES\n\nexport interface BackendCreatePaymentIntentRequest {\n\tamount: number\n\ttenantId: string\n}\n\nexport interface EmbeddedCheckoutRequest {\n\tpriceId?: string // Required for payment/subscription, not needed for setup\n\tdomain: string\n}\n\nexport interface CreateBillingPortalRequest {\n\tcustomerId: string\n\treturnUrl: string\n}\n\nexport interface VerifyCheckoutSessionRequest {\n\tsessionId: string\n}\n\n// SUBSCRIPTION EVENT TYPES\n\nexport interface BaseSubscriptionEvent {\n\tuserId: string\n\tsubscriptionId: string\n\ttimestamp?: Date\n}\n\nexport interface SubscriptionCreatedEvent extends BaseSubscriptionEvent {\n\tplanType: string\n\tstatus?: string\n}\n\nexport interface SubscriptionUpdatedEvent extends BaseSubscriptionEvent {\n\tpreviousStatus?: string\n\tnewStatus?: string\n\tplanType?: string\n}\n\nexport interface SubscriptionCanceledEvent extends BaseSubscriptionEvent {\n\tcanceledAt?: Date\n\tcancelationReason?: string\n}\n\nexport interface TrialWillEndEvent extends BaseSubscriptionEvent {\n\ttrialEndDate: Date\n\tplanType: string\n}\n\nexport interface PaymentFailedEvent extends BaseSubscriptionEvent {\n\tpaymentIntentId: string\n\terror: string\n\tattemptCount?: number\n}\n\nexport interface PaymentSucceededEvent extends BaseSubscriptionEvent {\n\tpaymentIntentId: string\n\tamount: number\n\tcurrency?: string\n}\n\n// REGISTERED ROUTE SCHEMA\n\nexport interface RegisteredRouteSchema {\n\tmethod: HttpMethod\n\tpath: string\n\tcontroller: string\n\thandler: string\n\tisPublic: boolean\n\trequiredRoles?: string[]\n\tschema?: JSONSchema\n}\n\n// EXPRESS ROUTER INTERFACES\n\nexport interface ExpressRoute {\n\tpath: string\n\tmethods: Record<string, boolean>\n}\n\nexport interface ExpressLayer {\n\troute?: ExpressRoute\n\tpath?: string\n\tname?: string\n}\n\nexport interface ExpressRouter {\n\tstack: ExpressLayer[]\n}\n\n// VALIDATION AND ENV TYPES\n\nexport interface RequiredEnvVars {\n\tDATABASE_URL: string\n\tDIRECT_URL: string\n\tSUPABASE_URL: string\n\tSERVICE_ROLE_KEY: string\n\tSUPABASE_PUBLISHABLE_KEY: string\n\tNEXTAUTH_SECRET: string\n\tNEXTAUTH_URL: string\n}\n\nexport interface ValidationResult {\n\tsuccess: boolean\n\tmessage: string\n\tdata?: unknown\n\terrors?: string[]\n}\n\n// MINIMAL BILLING TYPES\n\nexport interface PaymentNotificationData {\n\tsubscriptionId: string\n\tcustomerId: string\n\tamount?: number\n\tstatus?: string\n}\n\nexport interface MinimalSubscription {\n\tid: string\n\tcustomer: string | { id: string }\n\tstatus: string\n\tcurrent_period_end?: number\n}\n\nexport interface MinimalInvoice {\n\tid: string\n\tsubscriptionId: string\n\tcustomerId: string\n\tamount?: number\n\tstatus?: string\n}\n\n// EXPRESS PERFORMANCE SERIALIZER\n\nexport interface SerializerMetrics {\n\tdateSerializationCount: number\n\tcurrencySerializationCount: number\n\ttotalSerializations: number\n\tavgSerializationTime: number\n}\n"]}