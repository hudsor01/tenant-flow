<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TenantFlow OAuth Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f9fafb;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #111827;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #f3f4f6;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
        }
        .success {
            background: #dcfce7;
            color: #166534;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
        }
        .section {
            margin-bottom: 20px;
        }
        .config-display {
            background: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .config-display code {
            background: #e5e7eb;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê TenantFlow OAuth Test</h1>
        <p class="subtitle">Test Google OAuth configuration for TenantFlow</p>

        <div class="section config-display">
            <strong>Current Configuration:</strong><br>
            Supabase URL: <code id="supabase-url">Loading...</code><br>
            Current Origin: <code id="current-origin">Loading...</code><br>
            Redirect URL: <code id="redirect-url">Loading...</code>
        </div>

        <div class="section">
            <h3>Step 1: Test OAuth Flow</h3>
            <button onclick="testOAuth()">Test Google OAuth (Production)</button>
            <button onclick="testOAuthLocal()">Test Google OAuth (localhost:3000)</button>
        </div>

        <div class="section">
            <h3>Step 2: Check Current Session</h3>
            <button onclick="checkSession()">Check Session</button>
            <button onclick="signOut()">Sign Out</button>
        </div>

        <div class="section">
            <h3>Step 3: Verify Configuration</h3>
            <button onclick="verifyConfig()">Verify Environment</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://bshjmbshupiibfiewpxb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzaGptYnNodXBpaWJmaWV3cHhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDc1MDYsImV4cCI6MjA2Mzk4MzUwNn0.K9cR4SN_MtutRWPJsymtAtlHpEJFyfnQgtu8BjQRqko';

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Display configuration on load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('supabase-url').textContent = supabaseUrl;
            document.getElementById('current-origin').textContent = window.location.origin;
            document.getElementById('redirect-url').textContent = window.location.href;

            // Check for OAuth callback parameters
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');

            if (code) {
                showResult('OAuth callback received with code. Session should be established.', 'success');
                checkSession();
            } else if (error) {
                showResult(`OAuth Error: ${error}\n${errorDescription || ''}`, 'error');
            }
        });

        async function testOAuth() {
            showResult('Initiating OAuth with production redirect...', 'info');

            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: 'https://tenantflow.app/auth/callback'
                }
            });

            if (error) {
                showResult(`Error: ${JSON.stringify(error, null, 2)}`, 'error');
            } else {
                showResult('OAuth initiated successfully. Redirecting to Google...', 'success');
            }
        }

        async function testOAuthLocal() {
            showResult('Initiating OAuth with localhost:3000 redirect...', 'info');

            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: 'http://localhost:3000/auth/callback'
                }
            });

            if (error) {
                showResult(`Error: ${JSON.stringify(error, null, 2)}`, 'error');
            } else {
                showResult('OAuth initiated successfully. Redirecting to Google...', 'success');
            }
        }

        async function checkSession() {
            showResult('Checking session...', 'info');

            const { data: { session }, error } = await supabaseClient.auth.getSession();

            if (error) {
                showResult(`Session Error: ${JSON.stringify(error, null, 2)}`, 'error');
            } else if (session) {
                showResult(`Session Active:\n${JSON.stringify({
                    user: {
                        id: session.user.id,
                        email: session.user.email,
                        provider: session.user.app_metadata?.provider
                    },
                    expires_at: new Date(session.expires_at * 1000).toLocaleString()
                }, null, 2)}`, 'success');
            } else {
                showResult('No active session found', 'info');
            }
        }

        async function signOut() {
            showResult('Signing out...', 'info');

            const { error } = await supabaseClient.auth.signOut();

            if (error) {
                showResult(`Sign Out Error: ${JSON.stringify(error, null, 2)}`, 'error');
            } else {
                showResult('Signed out successfully', 'success');
            }
        }

        function verifyConfig() {
            const config = {
                supabaseUrl: supabaseUrl,
                supabaseKeyPresent: !!supabaseKey,
                supabaseKeyLength: supabaseKey.length,
                currentUrl: window.location.href,
                origin: window.location.origin,
                expectedCallbacks: [
                    'http://localhost:3000/auth/callback',
                    'https://tenantflow.app/auth/callback',
                    `${supabaseUrl}/auth/v1/callback`
                ],
                browserInfo: {
                    userAgent: navigator.userAgent,
                    cookiesEnabled: navigator.cookieEnabled,
                    localStorage: typeof(Storage) !== "undefined"
                }
            };

            showResult(`Configuration:\n${JSON.stringify(config, null, 2)}`, 'info');
        }

        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }
    </script>
</body>
</html>