. "$(dirname -- "$0")/init.sh"

# Husky v9.1.7 optimized pre-commit hook
# Comprehensive validation before commit

echo "üîç Running pre-commit validation (lockfile + lint + typecheck + tests)..."

# Step 1: Verify pnpm lockfile is in sync
echo "üì¶ Verifying pnpm lockfile is up to date..."
if ! pnpm install --frozen-lockfile --prefer-offline > /dev/null 2>&1; then
  echo "‚ùå pnpm-lock.yaml is out of sync!"
  echo "Please run 'pnpm install' and commit the lockfile changes."
  exit 1
fi

# Step 2: Turbo runs lint, typecheck, and tests on all changed files with caching
npx turbo run lint typecheck test:unit \
  --cache-dir=.turbo \
  --filter='[HEAD^1]' \
  --concurrency=10 || {
    echo "‚ùå Pre-commit checks failed!"
    echo "Fix errors before committing."
    echo "Use 'git commit --no-verify' to bypass (not recommended)."
    exit 1
}

echo "‚úÖ All pre-commit checks passed!"