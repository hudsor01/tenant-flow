. "$(dirname -- "$0")/init.sh"

# Husky v9.1.7 optimized pre-commit hook
# Comprehensive validation before commit

echo "üîç Running pre-commit validation (lockfile + db types + lint + typecheck + tests)..."

# Step 1: Regenerate DB types from live schema (ensures types are always current)
echo "üóÑÔ∏è Regenerating DB types from Supabase..."
if ! pnpm db:types > /dev/null 2>&1; then
  echo "‚ö†Ô∏è DB type regeneration failed (Doppler/network issue) - continuing with existing types"
fi
# Stage any type changes
git add packages/shared/src/types/supabase.ts 2>/dev/null || true

# Step 2: Verify pnpm lockfile is in sync
echo "üì¶ Verifying pnpm lockfile is up to date..."
if ! pnpm install --frozen-lockfile --prefer-offline > /dev/null 2>&1; then
  echo "‚ùå pnpm-lock.yaml is out of sync!"
  echo "Please run 'pnpm install' and commit the lockfile changes."
  exit 1
fi

# Step 3: Turbo runs lint, typecheck, and unit tests
# Integration/e2e tests excluded (require running services)
# Run tasks for all packages to ensure comprehensive validation
# --continue: Show all errors across all packages
# --output-logs=errors-only: Only show failed task output (cleaner logs)
# --summarize: Display cache performance metrics
CI=true npx turbo run lint typecheck test:unit \
  --continue \
  --force \
  --output-logs=errors-only \
  --summarize || {
    echo "‚ùå Pre-commit checks failed!"
    echo "Fix errors before committing."
    exit 1
}

echo "‚úÖ All pre-commit checks passed!"