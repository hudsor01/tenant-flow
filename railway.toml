[build]
builder = "DOCKERFILE"
dockerfilePath = "./Dockerfile"
watchPatterns = [
  "apps/backend/**",
  "packages/shared/**",
  "packages/database/**",
  "packages/**",
  "package.json",
  "pnpm-lock.yaml",
  "pnpm-workspace.yaml",
  "turbo.json",
  "Dockerfile",
  ".dockerignore"
]

[deploy]
healthcheckPath = "/health"
healthcheckTimeout = 300
overlapSeconds = 10
drainingSeconds = 30
restartPolicyType = "ALWAYS"
restartPolicyMaxRetries = 5

# Run database migrations before deployment
# CRITICAL: This must run before deployment to keep schema in sync with code
# Deployment will fail if migrations fail (|| exit 1)
preDeployCommand = "pnpm --filter @repo/database migrate:deploy || exit 1"
