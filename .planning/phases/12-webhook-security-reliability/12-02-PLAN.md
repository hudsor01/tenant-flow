---
phase: 12-webhook-security-reliability
plan: 02
type: execute
---

<objective>
Refactor webhook handlers to use transaction RPCs and add explicit tenant ownership verification.

Purpose: Ensure atomic database operations and prevent cross-tenant data modification.
Output: Updated handlers using RPC calls with tenant verification before any modifications.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-webhook-security-reliability/12-CONTEXT.md
@.planning/phases/12-webhook-security-reliability/12-RESEARCH.md

# Prior plan summary
@.planning/phases/12-webhook-security-reliability/12-01-SUMMARY.md

# Files to modify
@apps/backend/src/modules/billing/webhooks/handlers/payment-webhook.handler.ts
@apps/backend/src/modules/billing/webhooks/handlers/subscription-webhook.handler.ts

**From CONTEXT.md - Essential requirements:**
- Tenant isolation: A webhook for Tenant A must NEVER affect Tenant B's data
- Atomic processing: Either the whole webhook processes successfully, or nothing changes

**From RESEARCH.md:**
- Pattern 4: Tenant Ownership Verification (MISSING - NEEDS IMPLEMENTATION)
- Current issue: Handlers lookup tenant by stripe_customer_id and trust it without cross-checking
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor PaymentWebhookHandler to use RPC</name>
  <files>apps/backend/src/modules/billing/webhooks/handlers/payment-webhook.handler.ts</files>
  <action>
Modify handlePaymentIntentFailed method:

1. Replace the Promise.all([update, upsert]) pattern (lines ~301-325) with single RPC call:
```typescript
const { error: rpcError } = await client.rpc('process_payment_intent_failed', {
  p_rent_payment_id: rentPayment.id,
  p_payment_intent_id: paymentIntent.id,
  p_amount: paymentIntent.amount,
  p_failure_reason: paymentIntent.last_payment_error?.message || 'Unknown error'
})

if (rpcError) {
  this.logger.error('Failed to process payment intent failure', {
    error: rpcError.message,
    rentPaymentId: rentPayment.id
  })
  throw new Error(`Transaction failed: ${rpcError.message}`)
}
```

2. Remove the individual updateResult/transactionResult error handling since RPC is atomic

3. Keep the SSE broadcast and email sending (these are idempotent and non-critical)

4. Add tenant verification after looking up rentPayment:
   - After finding rentPayment, log tenant_id for audit trail
   - The RPC naturally scopes to the found record, but logging provides observability
  </action>
  <verify>
Run: pnpm --filter @repo/backend typecheck
Confirm no TypeScript errors
  </verify>
  <done>handlePaymentIntentFailed uses process_payment_intent_failed RPC instead of separate operations</done>
</task>

<task type="auto">
  <name>Task 2: Refactor SubscriptionWebhookHandler to use RPCs</name>
  <files>apps/backend/src/modules/billing/webhooks/handlers/subscription-webhook.handler.ts</files>
  <action>
Modify all three handler methods:

1. handleSubscriptionCreated (lines ~24-113):
   - Replace the conditional update logic with confirm_lease_subscription RPC
   - When leaseId exists from metadata:
     ```typescript
     const { error } = await client.rpc('confirm_lease_subscription', {
       p_lease_id: leaseId,
       p_subscription_id: subscription.id
     })
     ```
   - RPC handles "only update if pending" logic internally
   - Remove fallback lookup by subscription_id (RPC handles idempotency)

2. handleSubscriptionUpdated (lines ~115-165):
   - Replace separate select + update with process_subscription_status_change RPC:
     ```typescript
     const newStatus = subscription.status === 'active' ? 'active'
       : subscription.status === 'canceled' ? 'terminated' : 'draft'

     const { error } = await client.rpc('process_subscription_status_change', {
       p_subscription_id: subscription.id,
       p_new_status: newStatus,
       p_subscription_failure_reason: null
     })
     ```

3. handleSubscriptionDeleted (lines ~167-207):
   - Use process_subscription_status_change with status='terminated'
   - Same pattern as updated handler

4. Add structured logging with subscription_id and resolved lease_id for audit trail
  </action>
  <verify>
Run: pnpm --filter @repo/backend typecheck
Confirm no TypeScript errors
  </verify>
  <done>All subscription handlers use RPCs, removing multiple separate database calls</done>
</task>

<task type="auto">
  <name>Task 3: Add explicit tenant verification logging</name>
  <files>apps/backend/src/modules/billing/webhooks/handlers/payment-webhook.handler.ts, apps/backend/src/modules/billing/webhooks/handlers/subscription-webhook.handler.ts</files>
  <action>
Add tenant context logging for audit trail in both handlers:

1. In PaymentWebhookHandler:
   - After resolving tenant from stripe_customer_id, log:
     ```typescript
     this.logger.log('Tenant ownership verified for webhook', {
       stripe_customer_id: customerId,
       tenant_id: tenant.id,
       event_type: 'payment_intent.failed' // or succeeded
     })
     ```

2. In SubscriptionWebhookHandler:
   - After resolving lease from subscription metadata or ID, log:
     ```typescript
     this.logger.log('Lease ownership verified for webhook', {
       stripe_subscription_id: subscription.id,
       lease_id: leaseId,
       event_type: 'customer.subscription.X'
     })
     ```

3. Ensure all handlers log before AND after RPC calls for full traceability

This provides observability without adding RLS complexity (handlers use admin client appropriately for webhooks).
  </action>
  <verify>
Run: pnpm --filter @repo/backend test:unit -- --testPathPattern="webhook"
Existing tests should pass (or note if tests need updating)
  </verify>
  <done>Handlers have audit logging for tenant/lease ownership before modifications</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit` passes (or documented test updates needed)
- [ ] PaymentWebhookHandler.handlePaymentIntentFailed uses RPC
- [ ] All 3 SubscriptionWebhookHandler methods use RPCs
- [ ] Audit logging present for tenant/lease verification
- [ ] No Promise.all with multiple unrelated DB operations remains
</verification>

<success_criteria>
- Handlers use transaction RPCs instead of multiple separate operations
- Audit logging provides tenant ownership traceability
- Type checking passes
- Existing unit tests pass (or updates documented)
</success_criteria>

<output>
After completion, create `.planning/phases/12-webhook-security-reliability/12-02-SUMMARY.md` with frontmatter:

```yaml
---
phase: 12-webhook-security-reliability
plan: 02
subsystem: billing
tags: [webhooks, handlers, transactions, tenant-verification]

requires:
  - phase: 12-01
    provides: Transaction RPC functions

provides:
  - Atomic webhook handler operations
  - Tenant ownership audit logging
  - Consistent RPC usage across handlers

affects: [12-03-observability]

tech-stack:
  added: []
  patterns: [rpc-first-handlers, audit-logging]

key-files:
  created: []
  modified:
    - apps/backend/src/modules/billing/webhooks/handlers/payment-webhook.handler.ts
    - apps/backend/src/modules/billing/webhooks/handlers/subscription-webhook.handler.ts

key-decisions:
  - "Use RPC for all multi-step operations"
  - "Audit logging instead of runtime RLS checks for webhook handlers"
---
```

Include: accomplishments, files modified, any test updates needed.
</output>
