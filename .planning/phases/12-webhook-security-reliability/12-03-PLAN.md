---
phase: 12-webhook-security-reliability
plan: 03
type: execute
---

<objective>
Add dead letter queue alerting and webhook processing observability metrics.

Purpose: Ensure failed webhooks are noticed and investigated, provide visibility into webhook health.
Output: DLQ alerting integration (Sentry) and Prometheus metrics for webhook processing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-webhook-security-reliability/12-CONTEXT.md
@.planning/phases/12-webhook-security-reliability/12-RESEARCH.md

# Prior plan summary
@.planning/phases/12-webhook-security-reliability/12-02-SUMMARY.md

# Files to modify
@apps/backend/src/modules/billing/webhooks/webhook-queue.processor.ts

# Existing metrics infrastructure
@apps/backend/src/shared/metrics/prometheus.service.ts

**From CONTEXT.md - Essential requirements:**
- Never lose an event: Even if processing fails, event must be captured and recoverable
- Full observability: You should be able to see exactly what happened with any webhook

**From RESEARCH.md:**
- Pattern 5: Dead Letter Queue with Alerting (PARTIALLY IMPLEMENTED)
- Current: BullMQ retries 5 times, logs on final failure
- Missing: No alerting, no DLQ dashboard, no replay mechanism (dashboard is out of scope per CONTEXT.md)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DLQ alerting on final webhook failure</name>
  <files>apps/backend/src/modules/billing/webhooks/webhook-queue.processor.ts</files>
  <action>
Enhance the onFailed handler to send alerts when webhooks permanently fail:

1. Add Sentry integration (if @sentry/nestjs is available) OR structured error for log aggregation:
```typescript
@OnWorkerEvent('failed')
async onFailed(job: Job<WebhookJob>, error: Error) {
  const isExhausted = job.attemptsMade >= (job.opts.attempts ?? 5)

  this.logger.error(
    `Stripe webhook ${isExhausted ? 'permanently' : ''} failed after ${job.attemptsMade} attempts`,
    {
      jobId: job.id,
      eventId: job.data.eventId,
      eventType: job.data.eventType,
      error: error.message,
      stack: error.stack,
      isExhausted,
      severity: isExhausted ? 'critical' : 'warning'
    }
  )

  if (isExhausted) {
    // DLQ alert - structured for alerting systems
    this.logger.error('WEBHOOK_DLQ_ALERT: Webhook moved to dead letter queue', {
      alertType: 'webhook_dlq',
      eventId: job.data.eventId,
      eventType: job.data.eventType,
      failureReason: error.message,
      attemptsMade: job.attemptsMade,
      jobData: JSON.stringify(job.data),
      // Include enough context to investigate and potentially replay
      stripeEventData: job.data.stripeEvent?.id
    })
  }
}
```

2. If @sentry/nestjs is available, add Sentry capture:
```typescript
import * as Sentry from '@sentry/nestjs'

if (isExhausted) {
  Sentry.captureException(error, {
    tags: { eventType: job.data.eventType },
    extra: { jobData: job.data }
  })
}
```

3. Check if Sentry is installed: look for @sentry/nestjs in package.json. If not installed, use structured logging only (alerting via log aggregator).
  </action>
  <verify>
Run: pnpm --filter @repo/backend typecheck
Confirm no TypeScript errors
  </verify>
  <done>DLQ failures trigger structured alert logs (and Sentry if available)</done>
</task>

<task type="auto">
  <name>Task 2: Add webhook processing metrics</name>
  <files>apps/backend/src/modules/billing/webhooks/webhook-queue.processor.ts, apps/backend/src/shared/metrics/prometheus.service.ts</files>
  <action>
Add Prometheus metrics for webhook observability:

1. In prometheus.service.ts, add webhook-specific metrics (if not already present):
```typescript
private readonly webhookProcessingDuration = new Histogram({
  name: 'stripe_webhook_processing_duration_seconds',
  help: 'Duration of Stripe webhook processing',
  labelNames: ['event_type', 'status']
})

private readonly webhookTotal = new Counter({
  name: 'stripe_webhook_total',
  help: 'Total Stripe webhooks processed',
  labelNames: ['event_type', 'status']
})

private readonly webhookDlqTotal = new Counter({
  name: 'stripe_webhook_dlq_total',
  help: 'Total Stripe webhooks moved to DLQ',
  labelNames: ['event_type']
})

// Add getter methods for these metrics
```

2. In webhook-queue.processor.ts, inject PrometheusService and record metrics:
```typescript
constructor(
  private readonly processor: WebhookProcessor,
  private readonly logger: AppLogger,
  private readonly metrics: PrometheusService
) {
  super()
}

async process(job: Job<WebhookJob>): Promise<void> {
  const startTime = Date.now()
  const { eventType } = job.data

  try {
    await this.processor.processEvent(job.data.stripeEvent)

    const duration = (Date.now() - startTime) / 1000
    this.metrics.recordWebhookDuration(eventType, 'success', duration)
    this.metrics.incrementWebhookTotal(eventType, 'success')
  } catch (error) {
    const duration = (Date.now() - startTime) / 1000
    this.metrics.recordWebhookDuration(eventType, 'failure', duration)
    this.metrics.incrementWebhookTotal(eventType, 'failure')
    throw error
  }
}

onFailed(job: Job<WebhookJob>, error: Error) {
  // ... existing code ...

  if (isExhausted) {
    this.metrics.incrementWebhookDlq(job.data.eventType)
  }
}
```

3. Add methods to PrometheusService if not already modular:
```typescript
recordWebhookDuration(eventType: string, status: string, duration: number) {
  this.webhookProcessingDuration.labels(eventType, status).observe(duration)
}

incrementWebhookTotal(eventType: string, status: string) {
  this.webhookTotal.labels(eventType, status).inc()
}

incrementWebhookDlq(eventType: string) {
  this.webhookDlqTotal.labels(eventType).inc()
}
```
  </action>
  <verify>
Run: pnpm --filter @repo/backend typecheck
Run: pnpm --filter @repo/backend test:unit -- --testPathPattern="webhook"
  </verify>
  <done>Webhook processing has Prometheus metrics for duration, success/failure counts, and DLQ depth</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
- DLQ alerting on permanent webhook failures
- Prometheus metrics for webhook processing health
  </what-built>
  <how-to-verify>
1. Run the backend: pnpm --filter @repo/backend dev
2. Visit http://localhost:4650/metrics
3. Search for "stripe_webhook" metrics - should see:
   - stripe_webhook_processing_duration_seconds
   - stripe_webhook_total
   - stripe_webhook_dlq_total
4. Check logs for WEBHOOK_DLQ_ALERT format (or verify Sentry integration if installed)
  </how-to-verify>
  <resume-signal>Type "approved" if metrics appear in /metrics endpoint, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit` passes
- [ ] Metrics visible at /metrics endpoint
- [ ] DLQ alerting logs structured with alertType: 'webhook_dlq'
- [ ] Human verified metrics endpoint
</verification>

<success_criteria>
- DLQ failures trigger alerts (structured logs + Sentry if available)
- Prometheus metrics track webhook health
- Metrics visible at /metrics endpoint
- Phase 12 complete: atomic processing + tenant verification + observability
</success_criteria>

<output>
After completion, create `.planning/phases/12-webhook-security-reliability/12-03-SUMMARY.md` with frontmatter:

```yaml
---
phase: 12-webhook-security-reliability
plan: 03
subsystem: billing
tags: [webhooks, observability, metrics, alerting, dlq]

requires:
  - phase: 12-02
    provides: Handler refactoring complete

provides:
  - DLQ alerting for failed webhooks
  - Prometheus metrics for webhook health
  - Full observability into webhook processing

affects: [monitoring, operations]

tech-stack:
  added: []
  patterns: [structured-alerting, prometheus-metrics]

key-files:
  created: []
  modified:
    - apps/backend/src/modules/billing/webhooks/webhook-queue.processor.ts
    - apps/backend/src/shared/metrics/prometheus.service.ts

key-decisions:
  - "Use structured logging for DLQ alerts (log aggregator compatible)"
  - "Optional Sentry integration for richer alerting"
  - "Prometheus metrics for webhook health monitoring"
---
```

Include: accomplishments, metrics added, Sentry status (installed or not).

**Phase 12 Summary:**
After this plan completes, Phase 12 is done:
- [x] Transaction wrapping via RPCs (Plan 1)
- [x] Handler refactoring with tenant verification (Plan 2)
- [x] DLQ alerting and observability (Plan 3)
</output>
