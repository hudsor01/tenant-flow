---
phase: 15-stripe-documentation-alignment
plan: 01
type: execute
domain: stripe-backend
---

<objective>
Align Stripe integration with official documentation best practices.

Purpose: Address the 5 minor issues identified during the documentation audit.
Output: Improved error handling, idempotency, webhook deduplication, and metadata.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-stripe-documentation-alignment/15-CONTEXT.md

**Key source files:**
@apps/backend/src/modules/billing/stripe-shared.service.ts
@apps/backend/src/modules/billing/webhooks/webhook-processor.service.ts
@apps/backend/src/modules/billing/stripe-sync.service.ts
@apps/backend/src/modules/connect/connect-billing.service.ts

**Constraining decisions:**
- Minimal changes - codebase already excellent
- Keep existing patterns, enhance where needed
- No breaking changes to existing APIs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix rate limit error status code</name>
  <files>
    apps/backend/src/modules/billing/stripe-shared.service.ts
  </files>
  <action>
    Change StripeRateLimitError to return 429 Too Many Requests instead of 500.

    **Current code (line ~89):**
    ```typescript
    if (error instanceof Stripe.errors.StripeRateLimitError) {
      throw new InternalServerErrorException(
        'Our payment system is temporarily unavailable. Please try again in a moment.'
      )
    }
    ```

    **Update to:**
    - Import `HttpException` from `@nestjs/common`
    - Use `HttpException` with 429 status code
    - Include Retry-After header guidance in message

    This aligns with Stripe's recommendation that clients should distinguish rate limiting from server errors.
  </action>
  <verify>
    Rate limit errors return 429 status
    Error message provides retry guidance
    Type-check passes
  </verify>
  <done>
    Rate limit errors properly return 429 Too Many Requests
  </done>
</task>

<task type="auto">
  <name>Task 2: Add idempotency keys to destructive operations</name>
  <files>
    apps/backend/src/modules/billing/stripe-owner.service.ts,
    apps/backend/src/modules/connect/connect-billing.service.ts
  </files>
  <action>
    Add idempotency keys to delete and cancel operations.

    **Operations needing idempotency:**
    1. Customer deletion (stripe-owner.service.ts)
    2. Subscription cancellation (connect-billing.service.ts)

    **Pattern:**
    ```typescript
    const idempotencyKey = this.sharedService.generateIdempotencyKey(
      'cus_del',
      userId,
      customerId
    )

    await this.stripeClient.customers.del(customerId, {
      idempotencyKey
    })
    ```

    Add similar pattern for:
    - `deleteCustomer` operations
    - `cancelSubscription` operations

    This ensures retry safety for destructive operations.
  </action>
  <verify>
    Delete operations include idempotency keys
    Cancel operations include idempotency keys
    Existing tests still pass
  </verify>
  <done>
    All destructive Stripe operations are idempotent
  </done>
</task>

<task type="auto">
  <name>Task 3: Add webhook event deduplication</name>
  <files>
    apps/backend/src/modules/billing/webhooks/webhook-processor.service.ts,
    supabase/migrations/[timestamp]_add_webhook_event_tracking.sql
  </files>
  <action>
    Track processed webhook event IDs to prevent duplicate processing.

    **Database table:**
    ```sql
    create table stripe.processed_webhook_events (
      event_id text primary key,
      event_type text not null,
      processed_at timestamptz not null default now(),
      -- Auto-cleanup: events older than 7 days
      constraint event_id_format check (event_id like 'evt_%')
    );

    -- Index for cleanup job
    create index idx_webhook_events_processed_at
    on stripe.processed_webhook_events(processed_at);
    ```

    **Service update:**
    Before processing any event:
    1. Check if event_id exists in processed_webhook_events
    2. If exists, log "duplicate event" and return early
    3. If not, insert event_id and proceed with processing
    4. Use UPSERT to handle race conditions

    This prevents duplicate webhook delivery from causing data inconsistencies.
  </action>
  <verify>
    Duplicate webhook events are detected and skipped
    Event tracking table created
    Processing continues for new events
  </verify>
  <done>
    Webhook events are deduplicated before processing
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix Stripe Sync config and add payment metadata</name>
  <files>
    apps/backend/src/modules/billing/stripe-sync.service.ts,
    apps/backend/src/modules/connect/connect-billing.service.ts
  </files>
  <action>
    **Fix 1: Stripe Sync backfillRelatedEntities**

    Review and align the config value with the comment.
    Current code has `backfillRelatedEntities: true` but behavior should be verified.

    Options:
    - If true is correct, update comment to explain why
    - If false is correct, change value to false

    **Fix 2: Add payment intent metadata**

    When creating rent payment intents, add detailed metadata:
    ```typescript
    metadata: {
      platform: 'tenantflow',
      payment_type: 'rent',
      tenant_id: tenantId,
      tenant_name: tenantName,
      property_id: propertyId,
      property_name: propertyName,
      unit_id: unitId,
      unit_name: unitName,
      lease_id: leaseId,
      payment_period: paymentPeriod // e.g., "2026-01"
    }
    ```

    This improves Stripe dashboard reconciliation and debugging.
  </action>
  <verify>
    Stripe Sync config is consistent
    Payment intents include detailed metadata
    Type-check passes
  </verify>
  <done>
    Config aligned, payment metadata enriched
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stripe documentation alignment improvements</what-built>
  <how-to-verify>
    1. Run: pnpm --filter @repo/backend test:unit
    2. Verify: All tests pass
    3. Check: Rate limit error handling returns 429
    4. Review: Idempotency keys added to delete/cancel operations
    5. Verify: Webhook deduplication migration created
    6. Check: Payment intent metadata includes tenant/property info
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm typecheck passes
- [ ] pnpm lint passes
- [ ] pnpm test:unit:backend passes
- [ ] Rate limit returns 429 status code
- [ ] Destructive operations have idempotency keys
- [ ] Webhook deduplication table created
- [ ] Payment intents have detailed metadata
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Stripe integration fully aligned with documentation
</success_criteria>

<output>
After completion, create `.planning/phases/15-stripe-documentation-alignment/15-01-SUMMARY.md`
</output>
