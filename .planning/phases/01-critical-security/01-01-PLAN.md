---
phase: 01-critical-security
plan: 01
type: execute
---

<objective>
Fix the critical security vulnerability in the `active_entitlements` RLS policy that allows all authenticated users to see all subscription entitlements.

Purpose: Prevent unauthorized access to other users' subscription entitlements, which could expose billing/subscription information.
Output: New migration that replaces the vulnerable `USING (true)` policy with proper user-scoped access control.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/1-critical-security/1-RESEARCH.md

**Key files:**
@supabase/migrations/20251220060000_secure_stripe_schema_rls.sql (lines 270-296 contain the vulnerability)
@supabase/migrations/20260103120000_fix_properties_rls_comprehensive.sql (reference implementation for correct RLS patterns)

**Vulnerability details:**
The `active_entitlements_select_own` policy on `stripe.active_entitlements` uses `USING (true)` which grants ALL authenticated users access to ALL entitlements. This allows users to see each other's subscription entitlements.

**Fix pattern (from research):**
```sql
USING (
  EXISTS (
    SELECT 1 FROM stripe.customers c
    WHERE c.id = active_entitlements.customer
    AND (
      c.email = (SELECT email FROM auth.users WHERE id = (SELECT auth.uid()))
      OR (c.metadata->>'user_id')::uuid = (SELECT auth.uid())
    )
  )
)
```

**Constraint:** The stripe schema is dynamically created by Stripe's Supabase integration. The migration must check if the table exists before attempting to modify it.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration to fix active_entitlements RLS vulnerability</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_fix_active_entitlements_rls.sql</files>
  <action>
Create a new migration file with timestamp format (use current UTC time). The migration must:

1. Check if `stripe.active_entitlements` table exists (wrap in DO block)
2. Drop the existing vulnerable policy `active_entitlements_select_own`
3. Create new policy with proper user-scoping via customer linkage

**Use this exact SQL pattern:**
```sql
-- Migration: Fix critical RLS vulnerability in stripe.active_entitlements
-- Issue: USING (true) allowed all authenticated users to see all entitlements
-- Fix: Scope access to users via customer email or metadata linkage

DO $$
BEGIN
  -- Check if active_entitlements table exists in stripe schema
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.tables
    WHERE table_schema = 'stripe' AND table_name = 'active_entitlements'
  ) THEN
    RAISE NOTICE 'stripe.active_entitlements not found; skipping';
    RETURN;
  END IF;

  -- Drop the vulnerable policy
  DROP POLICY IF EXISTS "active_entitlements_select_own" ON stripe.active_entitlements;

  -- Create secure policy that links entitlements to users via customer
  -- Users can only see entitlements for customers they own (matched by email or metadata)
  CREATE POLICY "active_entitlements_select_own" ON stripe.active_entitlements
  FOR SELECT TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM stripe.customers c
      WHERE c.id = active_entitlements.customer
      AND (
        c.email = (SELECT email FROM auth.users WHERE id = (SELECT auth.uid()))
        OR (c.metadata->>'user_id')::uuid = (SELECT auth.uid())
      )
    )
  );

  COMMENT ON POLICY "active_entitlements_select_own" ON stripe.active_entitlements IS
    'Users can only view entitlements for customers linked to their account via email or user_id metadata';
END $$;
```

**Do NOT modify the original migration file** - create a new migration that fixes the issue. This preserves migration history.
  </action>
  <verify>
Run `supabase db reset` locally to verify migration applies cleanly without errors. Check that no SQL syntax errors occur.
  </verify>
  <done>
New migration file exists in supabase/migrations/ with proper timestamp, contains the secure policy, and applies without errors during `supabase db reset`.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Migration to fix active_entitlements RLS vulnerability</what-built>
  <how-to-verify>
    1. Review the new migration file in `supabase/migrations/`
    2. Verify it contains the secure USING clause with customer linkage
    3. If you have a local Supabase instance: run `supabase db reset` and verify it completes
    4. If you have access to production: plan deployment during low-traffic window
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file exists with correct timestamp format
- [ ] Migration contains `DROP POLICY IF EXISTS` for the old policy
- [ ] Migration contains `CREATE POLICY` with proper user-scoping via EXISTS subquery
- [ ] Migration handles case where stripe schema/table doesn't exist
- [ ] Migration includes explanatory comment
</verification>

<success_criteria>

- Migration file created with proper naming convention
- Policy correctly scopes access via customer email OR metadata linkage
- Migration is idempotent (uses DROP IF EXISTS, checks table existence)
- Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security/01-01-SUMMARY.md`
</output>
