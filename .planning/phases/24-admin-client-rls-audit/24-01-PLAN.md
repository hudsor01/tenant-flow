# Phase 24, Plan 01: Admin Client RLS Security Audit

<objective>
Systematically audit all 52 production files using `getAdminClient()` to:
1. Document legitimate uses (webhooks, system operations, guards)
2. Convert to user-scoped client where token is available
3. Add ownership verification where admin client is required but missing authorization

**Success Criteria:**
- Every admin client usage has documented justification OR is fixed
- Zero cross-tenant data leakage risk remains
- Security comments (SEC-XXX) added for all legitimate bypasses
</objective>

<context>
**Research Summary (from 24-RESEARCH.md):**
- Admin client ALWAYS bypasses RLS
- Three valid patterns: User Client, Ownership+Admin, Webhook Handler
- Existing guards: TenantOwnershipGuard, LeaseOwnershipGuard, PropertyOwnershipGuard
- Existing helpers: ensureTenantOwnedByUser(), ensureLeaseOwner()

**Categories Identified:**
1. **Legitimate (No Change):** Webhooks, guards, system services
2. **Needs Ownership Check:** Services with tenantId/leaseId params but no verification
3. **Convert to User Client:** Services called from JWT-protected endpoints with available token
</context>

<execution>

## Task 1: Audit Webhook Handlers (Legitimate)

**Files to review (7 files):**
- `modules/billing/webhooks/handlers/payment-webhook.handler.ts`
- `modules/billing/webhooks/handlers/subscription-webhook.handler.ts`
- `modules/billing/webhooks/handlers/checkout-webhook.handler.ts`
- `modules/billing/webhooks/handlers/connect-webhook.handler.ts`
- `modules/billing/webhooks/webhook.service.ts`
- `modules/docuseal/docuseal-webhook.controller.ts`
- `modules/docuseal/docuseal-webhook.service.ts`

**Action:** Verify webhook signature validation exists, add SEC comment documenting legitimate use.

**Comment Template:**
```typescript
// SEC-024-01: REVIEWED - Webhook handler, no user context available.
// Authorization: Webhook signature verified by controller guard.
```

---

## Task 2: Audit Ownership Guards (Legitimate)

**Files to review (4 files):**
- `shared/guards/property-ownership.guard.ts`
- `shared/guards/stripe-connected.guard.ts`
- `shared/guards/tenant-ownership.guard.ts`
- `shared/guards/lease-ownership.guard.ts`

**Action:** Verify guards perform ownership check, add SEC comment.

**Comment Template:**
```typescript
// SEC-024-02: REVIEWED - Ownership guard requires admin client to verify cross-user relationships.
// This guard IS the authorization layer - it validates ownerâ†’resource relationship.
```

---

## Task 3: Audit System/Background Services (Legitimate)

**Files to review (8 files):**
- `modules/rent-payments/payment-reminder.service.ts` - Cron job
- `modules/leases/subscription-retry.service.ts` - Background retry
- `modules/leases/lease-expiry-checker.service.ts` - Cron job
- `modules/leases/listeners/subscription-alert.listener.ts` - Event listener
- `modules/notifications/notification-event-handler.service.ts` - Event handler
- `security/security-metrics.service.ts` - System metrics
- `security/security.service.ts` - Auth validation
- `shared/services/event-idempotency.service.ts` - Idempotency tracking

**Action:** Verify these are system-level operations with no user context, add SEC comment.

---

## Task 4: Audit Billing Services (Needs Review)

**Files to review (6 files):**
- `modules/billing/billing.service.ts`
- `modules/billing/stripe-owner.service.ts`
- `modules/billing/stripe-tenant.service.ts`
- `modules/billing/connect/connect-setup.service.ts`
- `modules/billing/subscriptions/payment-methods.controller.ts`
- `subscriptions/subscription-billing.service.ts`

**Analysis needed:**
- Check if called from JWT-protected endpoints
- Determine if user token is available in call chain
- Either convert to user client OR add ownership verification

---

## Task 5: Audit Tenant Services (Needs Review)

**Files to review (5 files):**
- `modules/tenants/tenant-stats.service.ts`
- `modules/tenants/tenant-payment.service.ts`
- `modules/tenants/tenant-payment-query.service.ts`
- `modules/tenants/tenant-invitation-token.service.ts`
- `modules/users/users.service.ts`

**Analysis needed:**
- Verify ownership checks exist before tenant data access
- Add `ensureTenantOwnedByUser()` where missing
- Check for cross-tenant leakage risk

---

## Task 6: Audit Dashboard/Analytics Services (Needs Review)

**Files to review (4 files):**
- `modules/dashboard/dashboard-stats.service.ts`
- `modules/dashboard/dashboard-trends.service.ts`
- `modules/analytics/property-performance.service.ts`
- `modules/analytics/dashboard-analytics.service.ts`

**Analysis needed:**
- These aggregate user's own data - verify userId filter is applied
- Consider converting to user client if called from authenticated endpoints

---

## Task 7: Audit PDF/Document Services (Needs Review)

**Files to review (4 files):**
- `modules/pdf/pdf-storage.service.ts`
- `modules/pdf/lease-generation.controller.ts`
- `modules/documents/document-template-storage.service.ts`
- `database/storage.service.ts`

**Analysis needed:**
- Verify lease/document ownership before access
- Add ownership verification where missing

---

## Task 8: Audit Subscription Services (Needs Review)

**Files to review (2 files):**
- `subscriptions/subscription-lifecycle.service.ts`
- `subscriptions/subscription-query.service.ts`

**Analysis needed:**
- Check authorization flow for subscription operations
- Verify owner has access to subscription data

---

## Task 9: Audit Remaining Services (Needs Review)

**Files to review (8 files):**
- `modules/notifications/notification.service.ts`
- `modules/notifications/sse/sse.controller.ts`
- `modules/payment-methods/payment-methods.service.ts`
- `modules/stripe-sync/stripe-sync.controller.ts`
- `modules/admin/services/admin.service.ts`
- `modules/financial/financial-expense.service.ts`
- `shared/services/search.service.ts`
- `shared/services/utility.service.ts`

**Analysis needed:**
- Admin service is intentionally admin-only (legitimate)
- SSE controller needs user-scoped queries
- Search service needs review for multi-tenant safety

---

## Task 10: Infrastructure Files (No Action)

**Files (3 files):**
- `database/supabase.service.ts` - Defines getAdminClient (source)
- `config/config.schema.ts` - Config definition
- `__tests__/supabase-mock.ts` - Test utility

**Action:** No changes needed - these define/mock the service.

</execution>

<verification>
After completing all tasks:
1. Run `rg "getAdminClient" apps/backend/src --glob "!*.spec.ts" | grep -v "SEC-024"` to find any undocumented usages
2. Run full test suite: `pnpm test:unit:backend`
3. Run integration tests: `pnpm test:integration`
4. Manual review: Check for any remaining cross-tenant query patterns
</verification>

<references>
- Research: `.planning/phases/24-admin-client-rls-audit/24-RESEARCH.md`
- Context: `.planning/phases/24-admin-client-rls-audit/24-CONTEXT.md`
- Existing patterns: `modules/leases/lease-signature.service.ts` (SEC-001 example)
- ADR-0004: Three-tier client strategy
- ADR-0005: RPC guidelines
</references>
