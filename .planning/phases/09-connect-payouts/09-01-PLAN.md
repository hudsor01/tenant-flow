---
phase: 09-connect-payouts
plan: 01
type: execute
subsystem: backend
---

<objective>
Extract payouts and transfers endpoints from connect.controller.ts (605 lines).

Purpose: Separate financial operations (payouts, transfers) from account management.
Output: payouts.controller.ts with 3 endpoints, connect.controller.ts focused on account ops.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/TECH_DEBT.md

# Prior plan
@.planning/phases/08-service-decomposition/08-01-SUMMARY.md

# Current controller structure (605 lines)
@apps/backend/src/modules/billing/connect/connect.controller.ts

Sections identified:
- Account Management Operations (7 endpoints) → KEEP
  - getStripeAccountId (helper)
  - createConnectedAccount (POST /onboard)
  - refreshAccountLink (POST /refresh-link)
  - getConnectedAccountStatus (GET /status)
  - getConnectedAccountDetails (GET /account)
  - getStripeDashboardLink (POST /dashboard-link)
  - getConnectedAccountBalance (GET /balance)

- Financial Operations (3 endpoints) → EXTRACT
  - listPayouts (GET /payouts)
  - getPayoutDetails (GET /payouts/:payoutId)
  - listTransfers (GET /transfers)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract payouts controller</name>
  <files>
    apps/backend/src/modules/billing/connect/payouts.controller.ts
  </files>
  <action>
1. Create `connect/payouts.controller.ts`:
   - Extract: GET /payouts
   - Extract: GET /payouts/:payoutId
   - Extract: GET /transfers
   - Use @Controller('stripe/connect') to maintain route paths
   - Include all Swagger decorators
   - Copy getStripeAccountId helper (needed for auth)
   - Inject ConnectService, SupabaseService, AppLogger

2. These are financial operation endpoints for viewing payouts and transfers
  </action>
  <verify>File created with 3 endpoints</verify>
  <done>Payouts controller extracted</done>
</task>

<task type="auto">
  <name>Task 2: Update connect.controller.ts and connect.module.ts</name>
  <files>
    apps/backend/src/modules/billing/connect/connect.controller.ts
    apps/backend/src/modules/billing/connect/connect.module.ts
  </files>
  <action>
1. Update connect.controller.ts:
   - Remove listPayouts, getPayoutDetails, listTransfers methods
   - Keep getStripeAccountId helper (still needed for balance endpoint)
   - Update file header comment

2. Update connect.module.ts:
   - Add PayoutsController to controllers array

3. Run typecheck and tests:
   ```bash
   pnpm --filter @repo/backend typecheck
   pnpm --filter @repo/backend test:unit
   ```
  </action>
  <verify>
    - `pnpm --filter @repo/backend typecheck` passes
    - `pnpm --filter @repo/backend test:unit` passes
    - connect.controller.ts reduced to <470 lines
  </verify>
  <done>Module updated, payouts controller integrated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] connect/payouts.controller.ts exists (3 endpoints)
- [ ] connect.controller.ts reduced to <470 lines (account ops only)
- [ ] connect.module.ts registers PayoutsController
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit` passes
</verification>

<success_criteria>
- connect.controller.ts reduced from 605 to <470 lines
- 1 new focused controller created (payouts)
- All endpoints maintain same route paths
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-connect-payouts/09-01-SUMMARY.md` using summary template.
</output>
