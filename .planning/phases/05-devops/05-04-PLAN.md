---
phase: 05-devops
plan: 04
type: execute
subsystem: ci-cd
---

<objective>
Add automated backend deployment to Railway via GitHub Actions.

Purpose: Eliminate manual deploys, ensure consistent deployment process on merge to main.
Output: GitHub Actions workflow that deploys backend to Railway on push to main.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans
@.planning/phases/05-devops/05-03-SUMMARY.md

# Current CI/CD
@.github/workflows/ci-cd.yml - runs lint, typecheck, tests, migrations (no deploy)

# Deployment topology
- Frontend: Vercel (auto-deploys via GitHub integration)
- Backend: Railway (currently manual, needs automation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Railway deploy workflow</name>
  <files>
    .github/workflows/deploy-backend.yml
  </files>
  <action>
Create `.github/workflows/deploy-backend.yml`:

```yaml
name: Deploy Backend to Railway

on:
  push:
    branches: [main]
    paths:
      - 'apps/backend/**'
      - 'packages/shared/**'
      - 'pnpm-lock.yaml'
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel in-progress deploys

jobs:
  # Run tests first
  test:
    uses: ./.github/workflows/tests.yml
    with:
      pnpm-version: '10.23.0'
      node-version: '24'
      test-script: 'pnpm --filter @repo/backend test:unit'
    secrets: inherit

  # Deploy only after tests pass
  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up --service backend --environment production
```

Note: This requires:
1. RAILWAY_TOKEN secret in GitHub repository settings
2. Railway project configured with "backend" service name
  </action>
  <verify>Workflow file created</verify>
  <done>Railway deploy workflow created</done>
</task>

<task type="auto">
  <name>Task 2: Document Railway setup</name>
  <files>
    docs/DEPLOYMENT.md
  </files>
  <action>
Create `docs/DEPLOYMENT.md`:

```markdown
# TenantFlow Deployment Guide

## Architecture

| Component | Platform | Deploy Method |
|-----------|----------|---------------|
| Frontend | Vercel | Auto (GitHub integration) |
| Backend | Railway | Auto (GitHub Actions on merge to main) |
| Database | Supabase | Managed |
| Secrets | Doppler | Synced to Vercel/Railway |

## Setup Instructions

### Railway (Backend)

1. Create Railway project at https://railway.app
2. Add a service named "backend"
3. Connect to your Supabase database
4. Get Railway token: `railway login` then `railway whoami`
5. Add `RAILWAY_TOKEN` to GitHub repository secrets

### GitHub Actions

Required secrets in GitHub repository settings:
- `RAILWAY_TOKEN` - Railway deployment token

### Environment Variables

See:
- `apps/frontend/.env.example` - Frontend variables
- `apps/backend/.env.example` - Backend variables

### Manual Deploy (if needed)

```bash
# Backend
cd apps/backend
railway up --service backend

# Frontend (usually not needed - Vercel auto-deploys)
vercel --prod
```

## Monitoring

- Railway Dashboard: https://railway.app/dashboard
- Vercel Dashboard: https://vercel.com/dashboard
- Supabase Dashboard: https://supabase.com/dashboard
```
  </action>
  <verify>Documentation created</verify>
  <done>Deployment documentation created</done>
</task>

<task type="auto">
  <name>Task 3: Update ci-cd.yml to include deploy job</name>
  <files>
    .github/workflows/ci-cd.yml
  </files>
  <action>
Option A: Keep deploy-backend.yml separate (recommended)
- ci-cd.yml handles PR checks
- deploy-backend.yml handles production deployment

Option B: Add deploy job to ci-cd.yml for main branch only

Recommend Option A for separation of concerns. If choosing Option B:

```yaml
  deploy-backend:
    needs: [lint, typecheck, tests, migrations]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/deploy-backend.yml
    secrets: inherit
```

Document the chosen approach in DEPLOYMENT.md
  </action>
  <verify>Deploy strategy documented</verify>
  <done>CI/CD integration documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .github/workflows/deploy-backend.yml exists
- [ ] docs/DEPLOYMENT.md exists
- [ ] Workflow syntax is valid (`gh workflow view deploy-backend.yml`)
- [ ] Documentation explains setup steps
</verification>

<success_criteria>
- Clear deployment workflow for backend
- Documentation for setting up CI/CD
- Ready to enable once RAILWAY_TOKEN is configured
</success_criteria>

<output>
After completion, create `.planning/phases/05-devops/05-04-SUMMARY.md` using summary template.

Note: The workflow won't run until RAILWAY_TOKEN secret is added to GitHub.
This plan creates the infrastructure; enabling it requires manual secret configuration.
</output>
