---
phase: 05-devops
plan: 01
type: execute
subsystem: frontend
---

<objective>
Add type-safe environment validation to Next.js frontend using @t3-oss/env-nextjs.

Purpose: Catch missing/invalid env vars at build time, provide type-safe access throughout the app.
Output: `apps/frontend/src/env.ts` with validated, typed environment variables.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current env usage (from grep)
Frontend uses these env vars:
- NEXT_PUBLIC_APP_URL
- NEXT_PUBLIC_API_BASE_URL
- NEXT_PUBLIC_SUPABASE_URL
- NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
- NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
- NEXT_PUBLIC_JWT_ALGORITHM
- STRIPE_STARTER_MONTHLY_PRICE_ID (and other price IDs)
- VERCEL_URL (auto-injected)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @t3-oss/env-nextjs</name>
  <files>
    apps/frontend/package.json
  </files>
  <action>
1. Install the package:
   ```bash
   pnpm --filter @repo/frontend add @t3-oss/env-nextjs
   ```

2. Verify it's added to package.json
  </action>
  <verify>Package installed successfully</verify>
  <done>@t3-oss/env-nextjs installed</done>
</task>

<task type="auto">
  <name>Task 2: Create env.ts with validation schema</name>
  <files>
    apps/frontend/src/env.ts
  </files>
  <action>
1. Create `apps/frontend/src/env.ts`:

```typescript
import { createEnv } from '@t3-oss/env-nextjs'
import { z } from 'zod'

export const env = createEnv({
  /**
   * Server-side environment variables (not exposed to client)
   */
  server: {
    NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),
    // Stripe price IDs (server-only for checkout sessions)
    STRIPE_STARTER_MONTHLY_PRICE_ID: z.string().min(1),
    STRIPE_STARTER_ANNUAL_PRICE_ID: z.string().min(1),
    STRIPE_GROWTH_MONTHLY_PRICE_ID: z.string().min(1),
    STRIPE_GROWTH_ANNUAL_PRICE_ID: z.string().min(1),
    STRIPE_MAX_MONTHLY_PRICE_ID: z.string().min(1),
    STRIPE_MAX_ANNUAL_PRICE_ID: z.string().min(1),
  },

  /**
   * Client-side environment variables (exposed to browser)
   * Must be prefixed with NEXT_PUBLIC_
   */
  client: {
    NEXT_PUBLIC_APP_URL: z.string().url(),
    NEXT_PUBLIC_API_BASE_URL: z.string().url(),
    NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
    NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: z.string().min(1),
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().startsWith('pk_'),
    NEXT_PUBLIC_JWT_ALGORITHM: z.enum(['ES256', 'RS256', 'HS256']).default('ES256'),
  },

  /**
   * Runtime environment variables
   * Destructure from process.env to enable tree-shaking
   */
  runtimeEnv: {
    NODE_ENV: process.env.NODE_ENV,
    // Server
    STRIPE_STARTER_MONTHLY_PRICE_ID: process.env.STRIPE_STARTER_MONTHLY_PRICE_ID,
    STRIPE_STARTER_ANNUAL_PRICE_ID: process.env.STRIPE_STARTER_ANNUAL_PRICE_ID,
    STRIPE_GROWTH_MONTHLY_PRICE_ID: process.env.STRIPE_GROWTH_MONTHLY_PRICE_ID,
    STRIPE_GROWTH_ANNUAL_PRICE_ID: process.env.STRIPE_GROWTH_ANNUAL_PRICE_ID,
    STRIPE_MAX_MONTHLY_PRICE_ID: process.env.STRIPE_MAX_MONTHLY_PRICE_ID,
    STRIPE_MAX_ANNUAL_PRICE_ID: process.env.STRIPE_MAX_ANNUAL_PRICE_ID,
    // Client
    NEXT_PUBLIC_APP_URL: process.env.NEXT_PUBLIC_APP_URL,
    NEXT_PUBLIC_API_BASE_URL: process.env.NEXT_PUBLIC_API_BASE_URL,
    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
    NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY,
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
    NEXT_PUBLIC_JWT_ALGORITHM: process.env.NEXT_PUBLIC_JWT_ALGORITHM,
  },

  /**
   * Skip validation in test environment
   */
  skipValidation: process.env.SKIP_ENV_VALIDATION === 'true',
})
```

2. Export type for use in other files if needed
  </action>
  <verify>File created with correct schema</verify>
  <done>env.ts created with type-safe validation</done>
</task>

<task type="auto">
  <name>Task 3: Update existing env usage</name>
  <files>
    apps/frontend/src/lib/generate-metadata.ts
    apps/frontend/src/lib/api-client.ts
    apps/frontend/src/lib/supabase/client.ts
    apps/frontend/src/lib/supabase/server.ts
  </files>
  <action>
1. Search for all `process.env.NEXT_PUBLIC_*` usage:
   ```bash
   rg "process\.env\.NEXT_PUBLIC" apps/frontend/src --type ts -l
   ```

2. Update each file to import from env.ts:
   ```typescript
   // Before
   const url = process.env.NEXT_PUBLIC_API_BASE_URL

   // After
   import { env } from '@/env'
   const url = env.NEXT_PUBLIC_API_BASE_URL
   ```

3. Update server-only files to use server env vars appropriately
  </action>
  <verify>No direct process.env.NEXT_PUBLIC_* calls remain (except in env.ts)</verify>
  <done>All env usage migrated to type-safe env.ts</done>
</task>

<task type="auto">
  <name>Task 4: Update test setup</name>
  <files>
    apps/frontend/src/test/unit-setup.ts
  </files>
  <action>
1. Update test setup to set SKIP_ENV_VALIDATION:
   ```typescript
   process.env.SKIP_ENV_VALIDATION = 'true'
   ```

2. Keep existing mock env vars for tests

3. Run tests to verify nothing breaks:
   ```bash
   pnpm --filter @repo/frontend test:unit
   ```
  </action>
  <verify>Frontend tests pass</verify>
  <done>Test setup updated for env validation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @t3-oss/env-nextjs installed
- [ ] apps/frontend/src/env.ts exists with validation schema
- [ ] All process.env.NEXT_PUBLIC_* replaced with env.* imports
- [ ] `pnpm --filter @repo/frontend typecheck` passes
- [ ] `pnpm --filter @repo/frontend test:unit` passes
- [ ] `pnpm --filter @repo/frontend build` passes (validates env at build time)
</verification>

<success_criteria>
- Type-safe env access throughout frontend
- Build fails if required env vars missing
- Tests still pass with SKIP_ENV_VALIDATION
</success_criteria>

<output>
After completion, create `.planning/phases/05-devops/05-01-SUMMARY.md` using summary template.
</output>
