---
phase: 04-code-quality
plan: 02
type: execute
subsystem: backend
---

<objective>
Extract WebhookModule from StripeModule god module.

Purpose: Begin StripeModule decomposition by extracting the most isolated subsystem - webhooks. This follows the existing @todo ARCH-003 in the codebase.
Output: New `billing/webhooks/` sub-module with webhook-related services and handlers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan
@.planning/phases/04-code-quality/04-01-SUMMARY.md

# Current module structure
@apps/backend/src/modules/billing/stripe.module.ts

**Webhook-related files to extract:**
- stripe-webhook.controller.ts (+ spec)
- stripe-webhook.service.ts (+ spec)
- webhook-processor.service.ts (+ spec)
- stripe-webhook.queue.ts
- handlers/subscription-webhook.handler.ts
- handlers/payment-webhook.handler.ts
- handlers/checkout-webhook.handler.ts
- handlers/connect-webhook.handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhooks sub-module structure</name>
  <files>
    apps/backend/src/modules/billing/webhooks/webhooks.module.ts
    apps/backend/src/modules/billing/webhooks/index.ts
  </files>
  <action>
1. Create directory: `apps/backend/src/modules/billing/webhooks/`
2. Create `webhooks.module.ts`:
   - Import required dependencies (BullModule, SupabaseModule, etc.)
   - Register webhook providers and controller
   - Export services that other modules need

3. Move files to webhooks/ directory:
   - stripe-webhook.controller.ts → webhooks/webhook.controller.ts
   - stripe-webhook.service.ts → webhooks/webhook.service.ts
   - webhook-processor.service.ts → webhooks/webhook-processor.service.ts
   - stripe-webhook.queue.ts → webhooks/webhook-queue.processor.ts
   - handlers/ → webhooks/handlers/ (entire directory)

4. Rename classes to remove "Stripe" prefix (they're in billing/webhooks now):
   - StripeWebhookController → WebhookController
   - StripeWebhookService → WebhookService
   - StripeWebhookQueueProcessor → WebhookQueueProcessor

5. Update internal imports within moved files
  </action>
  <verify>Files exist in webhooks/ directory with correct structure</verify>
  <done>Webhooks sub-module structure created</done>
</task>

<task type="auto">
  <name>Task 2: Update imports and integrate module</name>
  <files>
    apps/backend/src/modules/billing/stripe.module.ts
    apps/backend/src/modules/billing/webhooks/webhooks.module.ts
  </files>
  <action>
1. Update stripe.module.ts:
   - Remove webhook-related imports
   - Remove webhook providers from providers array
   - Remove StripeWebhookController from controllers array
   - Import WebhooksModule
   - Re-export WebhooksModule if needed by other modules

2. Update webhooks.module.ts:
   - Import dependencies it needs (StripeService, etc. from parent)
   - Handle circular dependency if any (use forwardRef)

3. Search for all external imports of moved files:
   - `rg "stripe-webhook" apps/backend/src --type ts`
   - Update each import path

4. Run typecheck to find any broken imports:
   - `pnpm --filter @repo/backend typecheck`
   - Fix any errors
  </action>
  <verify>
    - `pnpm --filter @repo/backend typecheck` passes
    - `pnpm --filter @repo/backend test:unit -- --testPathPattern="webhook"` passes
  </verify>
  <done>WebhooksModule integrated, all imports updated, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `apps/backend/src/modules/billing/webhooks/` directory exists with all webhook files
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit -- --testPathPattern="webhook"` passes
- [ ] stripe.module.ts imports WebhooksModule instead of individual webhook providers
</verification>

<success_criteria>
- WebhooksModule extracted as sub-module
- All webhook tests still pass
- No TypeScript errors
- stripe.module.ts is smaller (removed ~6 providers, 1 controller)
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-02-SUMMARY.md` using summary template.

Track: Lines removed from stripe.module.ts, files moved, any issues encountered.
</output>
