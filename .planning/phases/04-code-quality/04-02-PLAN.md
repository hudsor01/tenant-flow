---
phase: 04-code-quality
plan: 02
type: execute
subsystem: documentation
---

<objective>
Document deferred code quality work and update project state.

Purpose: The StripeModule split (9,000+ lines, 35 files) and large file refactoring (10 files >500 lines) are significant architectural changes that need dedicated planning beyond this health remediation milestone. Document these for a future milestone.
Output: Updated STATE.md with deferred issues, ROADMAP notes, Phase 4 complete.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/04-code-quality/04-01-SUMMARY.md

**Deferred work analysis:**

1. **StripeModule Split** (DEFERRED - High complexity)
   - Current state: 35 files, 9,000+ lines in single module
   - Proposed: Split into customers/, subscriptions/, webhooks/, connect/
   - Why defer: Architectural change requiring dedicated planning, testing strategy
   - Risk if rushed: Breaking changes to Stripe integration

2. **Large File Refactoring** (DEFERRED - Medium complexity)
   - 10 service files over 500 lines
   - Largest: lease-signature.service.ts (801), property-analytics.service.ts (791)
   - Why defer: Each refactor needs careful analysis of responsibilities
   - Risk if rushed: Introducing bugs in critical business logic

**What WAS completed in Phase 4:**
- Dead code deleted (property-stats, notification-formatter)
- Duplicate service names resolved (tenant-stats, metrics)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document deferred issues in STATE.md</name>
  <files>.planning/STATE.md</files>
  <action>
Add to STATE.md Deferred Issues section:

```markdown
### Deferred Issues

**From Phase 4 (Code Quality):**

1. **StripeModule Split** - DEFERRED to future milestone
   - Scope: 35 files, 9,000+ lines
   - Reason: Architectural change needs dedicated planning
   - Risk: Breaking Stripe integration if rushed
   - Recommendation: Create dedicated milestone for billing refactor

2. **Large File Refactoring** - DEFERRED to future milestone
   - Files over 500 lines:
     - lease-signature.service.ts (801)
     - property-analytics.service.ts (791)
     - maintenance.service.ts (659)
     - pdf-generator.service.ts (604)
     - utility.service.ts (590)
     - late-fees.service.ts (539)
     - subscription-query.service.ts (534)
     - payment-analytics.service.ts (526)
     - financial-report.service.ts (511)
     - connect-setup.service.ts (506)
   - Reason: Each refactor needs analysis of responsibilities
   - Risk: Bugs in business logic if rushed
```
  </action>
  <verify>STATE.md contains Deferred Issues section with both items</verify>
  <done>Deferred work documented for future planning</done>
</task>

<task type="auto">
  <name>Task 2: Update ROADMAP.md Phase 4 details</name>
  <files>.planning/ROADMAP.md</files>
  <action>
Update Phase 4 details to reflect actual scope completed:

In Phase 4 section, update Plans line and add completion note:
```markdown
**Plans**: 2 (04-01: Dead code + duplicates, 04-02: Documentation)

**Completed:**
- Deleted 2 dead services
- Consolidated 4 duplicate service names

**Deferred to future milestone:**
- StripeModule split (9,000+ lines - needs dedicated planning)
- Large file refactoring (10 files >500 lines)
```

Update progress table:
- Phase 4: 2/2 plans, Complete, date
  </action>
  <verify>ROADMAP.md shows Phase 4 complete with deferred work noted</verify>
  <done>Phase 4 documented as complete with scope notes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] STATE.md has Deferred Issues section
- [ ] ROADMAP.md shows Phase 4 complete
- [ ] Deferred work clearly documented with reasoning
</verification>

<success_criteria>
- Deferred issues documented in STATE.md
- ROADMAP.md updated with completion status
- Clear rationale for what was deferred and why
- Phase 4 marked complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-02-SUMMARY.md` using summary template.

Phase 4 summary should note:
- What was completed (dead code, duplicates)
- What was deferred (StripeModule split, large files)
- Why deferred (scope too large for health remediation)
- Recommendation (create dedicated refactoring milestone)
</output>
