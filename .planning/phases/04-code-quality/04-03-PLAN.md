---
phase: 04-code-quality
plan: 03
type: execute
subsystem: backend
---

<objective>
Extract ConnectModule from StripeModule god module.

Purpose: Continue StripeModule decomposition by extracting Stripe Connect functionality (multi-tenant payment processing).
Output: New `billing/connect/` sub-module with Connect-related services and controller.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan
@.planning/phases/04-code-quality/04-02-SUMMARY.md

# Current module structure
@apps/backend/src/modules/billing/stripe.module.ts

**Connect-related files to extract:**
- stripe-connect.controller.ts (+ spec)
- stripe-connect.service.ts
- connect-setup.service.ts (506 lines)
- connect-billing.service.ts
- connect-payouts.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create connect sub-module structure</name>
  <files>
    apps/backend/src/modules/billing/connect/connect.module.ts
  </files>
  <action>
1. Create directory: `apps/backend/src/modules/billing/connect/`

2. Move files to connect/ directory:
   - stripe-connect.controller.ts → connect/connect.controller.ts
   - stripe-connect.service.ts → connect/connect.service.ts
   - connect-setup.service.ts → connect/connect-setup.service.ts
   - connect-billing.service.ts → connect/connect-billing.service.ts
   - connect-payouts.service.ts → connect/connect-payouts.service.ts

3. Rename classes to remove "Stripe" prefix where applicable:
   - StripeConnectController → ConnectController
   - StripeConnectService → ConnectService

4. Create `connect.module.ts`:
   - Import required dependencies
   - Register Connect providers and controller
   - Export services needed by other modules

5. Update internal imports within moved files
  </action>
  <verify>Files exist in connect/ directory with correct structure</verify>
  <done>Connect sub-module structure created</done>
</task>

<task type="auto">
  <name>Task 2: Update imports and integrate module</name>
  <files>
    apps/backend/src/modules/billing/stripe.module.ts
    apps/backend/src/modules/billing/connect/connect.module.ts
  </files>
  <action>
1. Update stripe.module.ts:
   - Remove Connect-related imports
   - Remove Connect providers from providers array
   - Remove StripeConnectController from controllers array
   - Import ConnectModule
   - Re-export ConnectModule services if needed

2. Update connect.module.ts:
   - Import dependencies it needs from parent/shared
   - Handle circular dependency if any (use forwardRef)

3. Search for all external imports of moved files:
   - `rg "stripe-connect|connect-setup|connect-billing|connect-payouts" apps/backend/src --type ts`
   - Update each import path

4. Run typecheck and tests
  </action>
  <verify>
    - `pnpm --filter @repo/backend typecheck` passes
    - `pnpm --filter @repo/backend test:unit -- --testPathPattern="connect"` passes
  </verify>
  <done>ConnectModule integrated, all imports updated, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `apps/backend/src/modules/billing/connect/` directory exists with all Connect files
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit` passes
- [ ] stripe.module.ts imports ConnectModule instead of individual Connect providers
</verification>

<success_criteria>
- ConnectModule extracted as sub-module
- All Connect tests still pass
- No TypeScript errors
- stripe.module.ts is smaller (removed ~5 providers, 1 controller)
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-03-SUMMARY.md` using summary template.
</output>
