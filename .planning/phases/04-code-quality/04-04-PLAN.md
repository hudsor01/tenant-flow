---
phase: 04-code-quality
plan: 04
type: execute
subsystem: backend
---

<objective>
Extract SubscriptionsModule from StripeModule god module.

Purpose: Continue StripeModule decomposition by extracting subscription and payment method functionality.
Output: New `billing/subscriptions/` sub-module with subscription-related services and controllers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan
@.planning/phases/04-code-quality/04-03-SUMMARY.md

# Current module structure
@apps/backend/src/modules/billing/stripe.module.ts

**Subscription-related files to extract:**
- stripe-subscription.controller.ts
- stripe-subscription.service.ts (+ spec)
- stripe-payment-methods.controller.ts
- stripe-payment-method.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create subscriptions sub-module structure</name>
  <files>
    apps/backend/src/modules/billing/subscriptions/subscriptions.module.ts
  </files>
  <action>
1. Create directory: `apps/backend/src/modules/billing/subscriptions/`

2. Move files to subscriptions/ directory:
   - stripe-subscription.controller.ts → subscriptions/subscription.controller.ts
   - stripe-subscription.service.ts → subscriptions/subscription.service.ts
   - stripe-subscription.service.spec.ts → subscriptions/subscription.service.spec.ts
   - stripe-payment-methods.controller.ts → subscriptions/payment-methods.controller.ts
   - stripe-payment-method.service.ts → subscriptions/payment-method.service.ts

3. Rename classes to remove "Stripe" prefix:
   - StripeSubscriptionController → SubscriptionController
   - StripeSubscriptionService → SubscriptionService
   - StripePaymentMethodsController → PaymentMethodsController
   - StripePaymentMethodService → PaymentMethodService

4. Create `subscriptions.module.ts`:
   - Import required dependencies
   - Register subscription providers and controllers
   - Export services needed by other modules

5. Update internal imports within moved files
  </action>
  <verify>Files exist in subscriptions/ directory with correct structure</verify>
  <done>Subscriptions sub-module structure created</done>
</task>

<task type="auto">
  <name>Task 2: Update imports and integrate module</name>
  <files>
    apps/backend/src/modules/billing/stripe.module.ts
    apps/backend/src/modules/billing/subscriptions/subscriptions.module.ts
  </files>
  <action>
1. Update stripe.module.ts:
   - Remove subscription-related imports
   - Remove subscription providers from providers array
   - Remove StripeSubscriptionController, StripePaymentMethodsController from controllers
   - Import SubscriptionsModule
   - Re-export SubscriptionsModule services if needed

2. Update subscriptions.module.ts:
   - Import dependencies it needs
   - Handle circular dependencies if any

3. Search and update all external imports:
   - `rg "stripe-subscription|stripe-payment-method" apps/backend/src --type ts`

4. Run typecheck and tests
  </action>
  <verify>
    - `pnpm --filter @repo/backend typecheck` passes
    - `pnpm --filter @repo/backend test:unit -- --testPathPattern="subscription"` passes
  </verify>
  <done>SubscriptionsModule integrated, all imports updated, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `apps/backend/src/modules/billing/subscriptions/` directory exists
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit` passes
- [ ] stripe.module.ts imports SubscriptionsModule
</verification>

<success_criteria>
- SubscriptionsModule extracted as sub-module
- All subscription tests still pass
- No TypeScript errors
- stripe.module.ts is smaller (removed ~4 providers, 2 controllers)
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-04-SUMMARY.md` using summary template.
</output>
