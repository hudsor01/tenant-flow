---
phase: 04-code-quality
plan: 05
type: execute
subsystem: backend
---

<objective>
Refactor top 3 largest service files to reduce complexity.

Purpose: Break down oversized service classes into focused, single-responsibility services.
Output: Smaller, more maintainable services with clear separation of concerns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan
@.planning/phases/04-code-quality/04-04-SUMMARY.md

# Target files
- lease-signature.service.ts (801 lines) - Already has helpers, review if further decomposition needed
- property-analytics.service.ts (791 lines) - 4 analytics types in one service
- maintenance.service.ts (659 lines) - CRUD + expense operations mixed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract PropertyAnalytics domain services</name>
  <files>
    apps/backend/src/modules/properties/services/property-analytics.service.ts
    apps/backend/src/modules/properties/services/analytics/occupancy-analytics.service.ts
    apps/backend/src/modules/properties/services/analytics/financial-analytics.service.ts
  </files>
  <action>
1. Analyze property-analytics.service.ts structure:
   - 4 public methods: getPropertyPerformanceAnalytics, getPropertyOccupancyAnalytics, getPropertyFinancialAnalytics, getPropertyMaintenanceAnalytics
   - Private helpers: validation, parsing, processing

2. Create analytics/ subdirectory with focused services:
   - occupancy-analytics.service.ts - getPropertyOccupancyAnalytics + processOccupancyData
   - financial-analytics.service.ts - getPropertyFinancialAnalytics + processFinancialData

3. Keep in main service (orchestration):
   - getPropertyPerformanceAnalytics (aggregates the others)
   - getPropertyMaintenanceAnalytics (distinct domain)
   - Shared validation/auth helpers

4. Update PropertiesModule to register new services

5. Update imports in any consumers
  </action>
  <verify>
    - `pnpm --filter @repo/backend typecheck` passes
    - property-analytics.service.ts is <500 lines
  </verify>
  <done>PropertyAnalytics decomposed into focused services</done>
</task>

<task type="auto">
  <name>Task 2: Extract MaintenanceExpenseService</name>
  <files>
    apps/backend/src/modules/maintenance/maintenance.service.ts
    apps/backend/src/modules/maintenance/maintenance-expense.service.ts
  </files>
  <action>
1. Analyze maintenance.service.ts:
   - CRUD: findAll, findOne, create, update, remove (~450 lines)
   - Expense operations: createExpense, getExpenses, deleteExpense (~150 lines)

2. Extract expense operations to maintenance-expense.service.ts:
   - Move createExpense, getExpenses, deleteExpense
   - Include any private helpers specific to expenses

3. Update MaintenanceModule:
   - Register MaintenanceExpenseService
   - Export if needed by other modules

4. Update MaintenanceController to inject both services

5. Search and update any external consumers
  </action>
  <verify>
    - `pnpm --filter @repo/backend typecheck` passes
    - maintenance.service.ts is <500 lines
  </verify>
  <done>MaintenanceExpenseService extracted</done>
</task>

<task type="auto">
  <name>Task 3: Assess lease-signature.service.ts</name>
  <files>
    apps/backend/src/modules/leases/lease-signature.service.ts
  </files>
  <action>
1. Review current structure:
   - Already uses helpers: SignatureValidationHelper, LeasePdfHelper, SignatureNotificationHelper
   - 8 main methods: sendForSignature, signLeaseAsOwner, signLeaseAsTenant, getSignatureStatus, getSigningUrl, cancelSignatureRequest, resendSignatureRequest, getSignedDocumentUrl

2. Assess if further decomposition provides value:
   - If methods are well-organized and helpers handle complexity → document as acceptable
   - If clear separation possible → extract (e.g., signature status operations)

3. Document findings:
   - If >500 lines but already well-structured with helpers, mark as "acceptable complexity"
   - Record any future decomposition recommendations

4. Run typecheck to ensure no issues
  </action>
  <verify>
    - Assessment documented in summary
    - `pnpm --filter @repo/backend typecheck` passes
  </verify>
  <done>lease-signature.service.ts assessed and documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] property-analytics.service.ts reduced to <500 lines
- [ ] maintenance.service.ts reduced to <500 lines
- [ ] lease-signature.service.ts assessed with documented decision
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit` passes
</verification>

<success_criteria>
- At least 2 of 3 files reduced to <500 lines
- New services follow NestJS patterns
- No TypeScript errors
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-05-SUMMARY.md` using summary template.
</output>
