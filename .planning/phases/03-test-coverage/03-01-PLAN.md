---
phase: 03-test-coverage
plan: 01
type: execute
subsystem: billing
---

<objective>
Add unit tests for Stripe subscription and customer services.

Purpose: These critical billing services have 0% test coverage despite handling subscription management and customer lifecycle operations. Tests provide regression protection and documentation of expected behavior.
Output: Test files for stripe-subscription.service.ts and stripe-customer.service.ts with >80% coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md

# Prior phase summaries (dependency graph)
@.planning/phases/02-database-stability/02-01-SUMMARY.md

# Source files to test
@apps/backend/src/modules/billing/stripe-subscription.service.ts
@apps/backend/src/modules/billing/stripe-customer.service.ts

# Existing test patterns to follow
@apps/backend/src/modules/billing/stripe-tenant.service.spec.ts
@apps/backend/src/modules/billing/stripe-webhook.service.spec.ts

**Tech stack available:** Jest 30.0.2, @nestjs/testing, vi.fn() mocking
**Established patterns:** Arrange/Act/Assert, mock Stripe client, SilentLogger for clean output
**Constraining decisions:**
- Phase 02-01: Stripe schema safeguards in place
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for stripe-subscription.service.ts</name>
  <files>apps/backend/src/modules/billing/stripe-subscription.service.spec.ts</files>
  <action>
Create unit tests for StripeSubscriptionService following existing patterns in stripe-tenant.service.spec.ts.

Test cases to cover:
1. listSubscriptions() - returns subscriptions, handles customer filter, handles status filter
2. getAllSubscriptions() - pagination works, respects max items limit
3. getSubscription() - retrieves by ID, returns null on not found
4. createSubscription() - creates with params, uses idempotency key
5. updateSubscription() - updates existing, handles errors
6. cancelSubscription() - cancels subscription, handles already cancelled

Mock dependencies:
- StripeClientService.getClient() → mock Stripe instance
- AppLogger → SilentLogger or mock
- RedisCacheService → mock with get/set methods

Use jest.fn() for all mocks. Follow Arrange/Act/Assert pattern. Test both success and error paths.
  </action>
  <verify>pnpm --filter @repo/backend test:unit -- --testPathPattern="stripe-subscription.service" passes</verify>
  <done>All tests pass, coverage for stripe-subscription.service.ts >80%</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for stripe-customer.service.ts</name>
  <files>apps/backend/src/modules/billing/stripe-customer.service.spec.ts</files>
  <action>
Create unit tests for StripeCustomerService following existing patterns.

Test cases to cover:
1. listCustomers() - returns customers, filters by email, filters out deleted
2. getAllCustomers() - pagination works correctly, aggregates all pages
3. getCustomer() - retrieves by ID, returns null for deleted, returns null on error
4. createCustomer() - creates with params, uses idempotency key when provided

Mock dependencies:
- StripeClientService.getClient() → mock Stripe instance with customers.list/retrieve/create
- AppLogger → SilentLogger or mock

Key edge cases:
- Deleted customers should be filtered out (check `'deleted' in customer`)
- Pagination should continue while has_more is true
- Errors should be logged and re-thrown (or return null for getCustomer)
  </action>
  <verify>pnpm --filter @repo/backend test:unit -- --testPathPattern="stripe-customer.service" passes</verify>
  <done>All tests pass, coverage for stripe-customer.service.ts >80%</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @repo/backend test:unit -- --testPathPattern="stripe"` passes
- [ ] Both new test files exist and have meaningful tests
- [ ] No TypeScript errors in test files
- [ ] Coverage report shows >80% for both services
</verification>

<success_criteria>
- stripe-subscription.service.spec.ts created with passing tests
- stripe-customer.service.spec.ts created with passing tests
- Coverage >80% for both services
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-coverage/03-01-SUMMARY.md` using summary template.
</output>
