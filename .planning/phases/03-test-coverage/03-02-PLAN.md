---
phase: 03-test-coverage
plan: 02
type: execute
subsystem: pdf
---

<objective>
Add unit tests for the PDF generator service.

Purpose: The PDFGeneratorService (604 lines) is the core PDF generation engine using React-PDF and Puppeteer but has 0% test coverage. Tests will document the API and catch regressions in invoice/lease PDF generation.
Output: Test file for pdf-generator.service.ts with meaningful test coverage for public methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Prior plan in this phase
@.planning/phases/03-test-coverage/03-01-SUMMARY.md

# Source file to test
@apps/backend/src/modules/pdf/pdf-generator.service.ts

# Existing PDF test patterns to follow
@apps/backend/src/modules/pdf/lease-pdf-generator.service.spec.ts
@apps/backend/src/modules/pdf/react-lease-pdf.service.spec.ts
@apps/backend/src/modules/pdf/pdf-storage.service.spec.ts

**Tech stack available:** Jest 30.0.2, @nestjs/testing
**Established patterns:** Mock @react-pdf/renderer, mock puppeteer, Arrange/Act/Assert
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for PDFGeneratorService core methods</name>
  <files>apps/backend/src/modules/pdf/pdf-generator.service.spec.ts</files>
  <action>
Create unit tests for PDFGeneratorService following existing patterns in pdf module.

Mock strategy:
- Mock @react-pdf/renderer's renderToBuffer to return a test buffer
- Mock puppeteer to return controlled page/browser mocks
- Mock PdfTemplateRendererService
- Mock AppLogger with SilentLogger

Test cases for generateInvoicePDF():
1. Generates PDF buffer with valid invoice data
2. Includes all invoice items in output
3. Logs invoice number during generation
4. Throws on render errors

Test cases for generateFromHtml():
1. Launches browser if not already running
2. Generates PDF from HTML string
3. Closes page after generation
4. Handles errors gracefully

Test cases for generateFromTemplate():
1. Uses template renderer service
2. Passes template data correctly
3. Returns rendered PDF buffer

Test cases for lifecycle:
1. onModuleDestroy closes browser if open
2. Browser reuse works correctly

Focus on unit tests - mock external dependencies. Do NOT test actual PDF content rendering (integration test territory).
  </action>
  <verify>pnpm --filter @repo/backend test:unit -- --testPathPattern="pdf-generator.service" passes</verify>
  <done>All tests pass, core public methods have test coverage</done>
</task>

<task type="auto">
  <name>Task 2: Verify PDF module test coverage</name>
  <files>apps/backend/src/modules/pdf/</files>
  <action>
Run coverage report for PDF module to verify improvement.

Steps:
1. Run: pnpm --filter @repo/backend test:unit -- --coverage --collectCoverageFrom="src/modules/pdf/**/*.ts"
2. Review coverage report for pdf-generator.service.ts
3. If coverage below 70%, add additional tests for uncovered branches

Document coverage numbers in summary for comparison.
  </action>
  <verify>Coverage report generated, pdf-generator.service.ts shows coverage improvement</verify>
  <done>Coverage documented, target met or gaps identified for follow-up</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @repo/backend test:unit -- --testPathPattern="pdf-generator"` passes
- [ ] pdf-generator.service.spec.ts exists with meaningful tests
- [ ] No TypeScript errors
- [ ] Coverage improvement documented
</verification>

<success_criteria>
- pdf-generator.service.spec.ts created with passing tests
- Core methods (generateInvoicePDF, generateFromHtml, generateFromTemplate) have test coverage
- No regressions in existing PDF module tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-coverage/03-02-SUMMARY.md` using summary template.
</output>
