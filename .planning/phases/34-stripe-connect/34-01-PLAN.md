---
phase: 34-stripe-connect
plan: 01
type: execute
---

<objective>
Verify and fix the Stripe Connect end-to-end flow so property owners can complete Connect onboarding and receive rent payments from tenants.

Purpose: The backend endpoints and frontend components exist but have never been verified end-to-end. This plan walks every step of the Connect flow — owner initiates onboarding, Stripe onboarding completes, webhook fires, account status updates — and fixes any gaps.
Output: Working Stripe Connect onboarding (owner can click "Connect Stripe Account" → complete Stripe Express onboarding → account shows "Verified" status).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/frontend/src/components/settings/billing-settings.tsx
@apps/frontend/src/components/connect/connect-account-status.tsx
@apps/backend/src/modules/billing/connect/connect.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit ConnectAccountStatus "no account" state</name>
  <files>
    apps/frontend/src/components/connect/connect-account-status.tsx
    apps/frontend/src/hooks/api/use-stripe-connect.ts
  </files>
  <action>
  Read `connect-account-status.tsx` in full. Find the render branch for when `useConnectedAccount()` returns null/undefined (no account exists yet).

  Verify:
  1. Is there a "Pending Setup" state that shows a CTA button?
  2. Does the CTA call `onSetupClick` prop to open `ConnectOnboardingDialog`?
  3. Is `onSetupClick` wired in `billing-settings.tsx` to `setShowOnboarding(true)`?

  The ConnectAccountStatus component receives `onSetupClick` prop from BillingSettings. If the "no account" branch exists and correctly calls `onSetupClick`, this is working. Document the finding.

  Check `useConnectedAccount()` hook for the query it makes:
  ```bash
  grep -n "useConnectedAccount\|/connect/account\|GET.*account" \
    apps/frontend/src/hooks/api/use-stripe-connect.ts
  ```

  Confirm the hook calls `GET /api/v1/stripe/connect/account` and that errors (404 when no account) are handled gracefully (returns null/undefined, not throws).
  </action>
  <verify>
  ```bash
  grep -n "onSetupClick\|Pending Setup\|no.*account\|isLoading\|error" \
    apps/frontend/src/components/connect/connect-account-status.tsx | head -20
  ```
  ConnectAccountStatus has a "no account" branch that calls onSetupClick. If the no-account state is missing, fix it in the next task.
  </verify>
  <done>ConnectAccountStatus "no account" state behavior documented. Any gaps identified.</done>
</task>

<task type="auto">
  <name>Task 2: Fix ConnectAccountStatus no-account render (if needed)</name>
  <files>apps/frontend/src/components/connect/connect-account-status.tsx</files>
  <action>
  Based on Task 1 findings:

  IF the "no account" state is missing or doesn't call onSetupClick: Add a clean empty state with a "Connect Stripe Account" button. The component should already have `onSetupClick?: () => void` as a prop. If not, add it.

  The empty state should look like:
  ```tsx
  // When connectedAccount is null/undefined and not loading:
  <div className="flex items-center justify-between p-4 border border-dashed rounded-lg">
    <div>
      <p className="text-sm font-medium">Connect your bank account</p>
      <p className="text-xs text-muted-foreground">
        Set up Stripe to receive rent payments from your tenants
      </p>
    </div>
    <Button size="sm" onClick={onSetupClick}>
      Connect Stripe Account
    </Button>
  </div>
  ```

  IF the "no account" state is already correct: Skip this task (no changes needed).

  Also check that `useConnectedAccount()` does NOT throw on 404 (when owner has no Connect account). It should return `{ data: null }` not an error. If it throws, add error handling:
  ```typescript
  // In use-stripe-connect.ts, useConnectedAccount:
  queryFn: async () => {
    try {
      return await apiRequest('/api/v1/stripe/connect/account')
    } catch (err) {
      if (err?.status === 404 || err?.message?.includes('not found')) return null
      throw err
    }
  }
  ```
  </action>
  <verify>
  ```bash
  grep -n "onSetupClick\|Connect Stripe Account\|not.*found\|null" \
    apps/frontend/src/components/connect/connect-account-status.tsx | head -20
  ```
  Component renders an actionable CTA when no account exists.
  </verify>
  <done>ConnectAccountStatus renders "Connect Stripe Account" CTA when owner has no connected account.</done>
</task>

<task type="auto">
  <name>Task 3: Audit backend GET /connect/account for no-account 404 handling</name>
  <files>apps/backend/src/modules/billing/connect/connect.controller.ts</files>
  <action>
  Read the `getConnectedAccountDetails` endpoint (GET /api/v1/stripe/connect/account).

  Check what happens when the owner has no `stripe_connected_accounts` record yet:
  ```bash
  grep -n "getConnectedAccountDetails\|stripe_connected_accounts\|NotFoundException\|null\|not.*found" \
    apps/backend/src/modules/billing/connect/connect.controller.ts | head -30
  ```

  IF it throws NotFoundException when no record exists: This is correct behavior — the frontend hook needs to handle 404 gracefully (Task 2).

  IF it returns empty/null: Also fine — frontend shows empty state.

  No changes needed here unless the endpoint crashes unexpectedly. Document the behavior.
  </action>
  <verify>
  ```bash
  grep -n "NotFoundException\|HttpStatus\|status.*404\|return null\|data: null" \
    apps/backend/src/modules/billing/connect/connect.controller.ts | head -10
  ```
  </verify>
  <done>Backend GET /connect/account behavior documented. Returns 404 or null when no account, handled gracefully.</done>
</task>

<task type="auto">
  <name>Task 4: Verify ConnectOnboardingDialog form submission</name>
  <files>
    apps/frontend/src/app/(tenant)/tenant/settings/stripe-connect-onboarding.tsx
    apps/backend/src/modules/billing/connect/connect.controller.ts
  </files>
  <action>
  Read `stripe-connect-onboarding.tsx` to understand the form submission flow (lines 59-116).

  The flow should be:
  1. Owner fills form: entity type (individual/company), display name, country
  2. `useCreateConnectedAccountMutation()` fires: POST /api/v1/stripe/connect/onboard
  3. Returns: `{ accountId, onboardingUrl, existing: boolean }`
  4. `useRefreshOnboardingMutation()` fires: POST /api/v1/stripe/connect/refresh-link
  5. Opens `onboardingUrl` in new window

  Check the URL security validation:
  ```bash
  grep -n "https\|stripe.com\|window.open\|validateUrl\|security" \
    apps/frontend/src/app/\(tenant\)/tenant/settings/stripe-connect-onboarding.tsx | head -20
  ```

  Verify the component file is in the correct location — it's at `(tenant)/tenant/settings/` but used by the owner's BillingSettings. This is just a file location quirk; the component itself should work fine from any import location.

  Check the import in billing-settings.tsx:
  ```bash
  grep -n "ConnectOnboardingDialog\|import" \
    apps/frontend/src/components/settings/billing-settings.tsx | head -10
  ```

  If the import path is correct and the component is well-formed, no changes needed. Document any issues found.
  </action>
  <verify>
  ```bash
  grep -rn "ConnectOnboardingDialog" apps/frontend/src/ | head -10
  ```
  Component is imported by billing-settings.tsx and located at its import path.
  </verify>
  <done>ConnectOnboardingDialog form submission audited. Import paths verified correct.</done>
</task>

<task type="auto">
  <name>Task 5: Verify webhook handler for account.updated event</name>
  <files>
    apps/backend/src/modules/billing/webhooks/handlers/connect-webhook.handler.ts
    apps/backend/src/modules/billing/webhooks/webhook.controller.ts
  </files>
  <action>
  Read `connect-webhook.handler.ts` to confirm the `account.updated` handler:
  1. Receives `Stripe.Account` object
  2. Determines `onboarding_status`: 'completed' | 'in_progress' | 'not_started'
  3. Updates `stripe_connected_accounts` table with: `charges_enabled`, `payouts_enabled`, `onboarding_status`, `requirements_due`, `onboarding_completed_at`

  Check that the webhook routing correctly dispatches `account.updated` to this handler:
  ```bash
  grep -n "account.updated\|handleAccountUpdated\|connect" \
    apps/backend/src/modules/billing/webhooks/webhook.controller.ts | head -20
  ```

  Also check the `webhook.service.ts` or `webhook-processor.service.ts` for routing:
  ```bash
  grep -rn "account.updated" apps/backend/src/modules/billing/webhooks/ | head -10
  ```

  Verify the webhook endpoint uses the correct Stripe signing secret:
  ```bash
  grep -n "STRIPE_CONNECT_WEBHOOK\|webhookSecret\|constructEvent" \
    apps/backend/src/modules/billing/webhooks/webhook.controller.ts | head -10
  ```

  Note: Connect webhooks require a SEPARATE signing secret from platform webhooks (`STRIPE_CONNECT_WEBHOOK_SECRET` vs `STRIPE_WEBHOOK_SECRET`). Verify this is configured correctly.
  </action>
  <verify>
  ```bash
  grep -rn "STRIPE_CONNECT_WEBHOOK_SECRET\|CONNECT.*WEBHOOK" apps/backend/src/ | head -5
  grep -rn "account.updated" apps/backend/src/modules/billing/ | head -5
  ```
  Webhook `account.updated` is routed to `connect-webhook.handler.ts` and uses the correct Connect signing secret env var.
  </verify>
  <done>Webhook routing for account.updated verified. Connect webhook secret configuration documented.</done>
</task>

<task type="auto">
  <name>Task 6: Add STRIPE_CONNECT_WEBHOOK_SECRET to env config if missing</name>
  <files>
    apps/backend/src/config/app-config.service.ts
    apps/backend/.env.example (or equivalent)
  </files>
  <action>
  Check if `STRIPE_CONNECT_WEBHOOK_SECRET` is defined in the app config:
  ```bash
  grep -rn "STRIPE_CONNECT_WEBHOOK\|connectWebhookSecret" \
    apps/backend/src/config/ | head -10
  ```

  IF it's missing from the config service: Add it alongside `STRIPE_WEBHOOK_SECRET`. This env var is required for verifying Connect account webhook signatures in test mode.

  Also check `apps/backend/.env.example` or equivalent for the env var documentation:
  ```bash
  ls apps/backend/.env* 2>/dev/null | head -5
  grep -n "STRIPE.*WEBHOOK" apps/backend/.env.example 2>/dev/null | head -10
  ```

  If the env var is missing from config AND the webhook handler uses it, add it to:
  1. `app-config.service.ts` getter
  2. Env documentation/example file

  If it's already present and correctly configured: Skip.
  </action>
  <verify>
  ```bash
  grep -rn "STRIPE_CONNECT_WEBHOOK_SECRET\|connectWebhookSecret" \
    apps/backend/src/ | head -10
  ```
  </verify>
  <done>STRIPE_CONNECT_WEBHOOK_SECRET present in config and documented in env examples.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stripe Connect onboarding flow (UI + backend + webhook)</what-built>
  <how-to-verify>
  Start the app: `pnpm dev`
  Sign in as the owner account (test-admin@tenantflow.app or your owner account).

  Navigate to: http://localhost:3050/settings?tab=billing

  **Check 1: Connect section visible**
  - Scroll to the "Payment Account" section
  - Do you see "Connect Stripe Account" button or "Pending Setup" status?
  - Mark: ✅ PASS | ❌ FAIL

  **Check 2: Dialog opens**
  - Click the "Connect Stripe Account" button (or equivalent CTA)
  - Does a dialog appear with entity type, display name, country fields?
  - Mark: ✅ PASS | ❌ FAIL

  **Check 3: Dialog submits to backend** (use browser network tab)
  - Fill in: Individual / "Test Owner" / United States
  - Click submit
  - In Network tab: does `POST /api/v1/stripe/connect/onboard` fire?
  - Does it return 200 with `{ accountId, onboardingUrl }`?
  - Mark: ✅ PASS | ❌ FAIL (with error if fails)

  **Check 4: Stripe onboarding opens**
  - Does a new tab/window open to a stripe.com URL?
  - Mark: ✅ PASS | ❌ FAIL

  Note: In test mode, you can complete the Stripe Express onboarding using test data. If you have a Stripe test account configured, complete the onboarding. Otherwise just verify the redirect occurs.
  </how-to-verify>
  <resume-signal>
  Paste results:
  1. Connect section visible: PASS/FAIL
  2. Dialog opens: PASS/FAIL
  3. Dialog submits: PASS/FAIL (include error if any)
  4. Stripe onboarding opens: PASS/FAIL

  When finished, type: connect-verified
  </resume-signal>
</task>

<task type="auto">
  <name>Task 7: Fix any issues found in manual verification</name>
  <files>
    apps/frontend/src/components/settings/billing-settings.tsx
    apps/frontend/src/components/connect/connect-account-status.tsx
    apps/frontend/src/app/(tenant)/tenant/settings/stripe-connect-onboarding.tsx
    apps/backend/src/modules/billing/connect/connect.controller.ts
  </files>
  <action>
  Based on the manual verification checkpoint results, fix any reported failures.

  Common issues and fixes:

  **If Connect section not visible:**
  - Check billing-settings.tsx imports ConnectOnboardingDialog and ConnectAccountStatus
  - Verify the "Payment Account" section is rendered (not conditionally hidden)

  **If dialog doesn't open:**
  - Verify `setShowOnboarding` state is wired to `ConnectAccountStatus onSetupClick` prop
  - Check for console errors

  **If POST /onboard fails:**
  - Check auth token is included in request headers
  - Verify CORS is not blocking
  - Check backend logs for the error
  - Common fix: ensure `@UseGuards(JwtAuthGuard)` is on the endpoint

  **If Stripe redirect doesn't open:**
  - URL security validation may be too strict — check `validateStripeUrl()` or similar
  - The URL must be HTTPS and from stripe.com domain

  If all 4 checks passed: No changes needed. Move to Task 8.
  </action>
  <verify>
  Re-run the manual checks mentally: all 4 steps complete without errors.
  </verify>
  <done>All issues from manual verification fixed. Connect onboarding CTA → dialog → backend → Stripe redirect working.</done>
</task>

<task type="auto">
  <name>Task 8: Run typecheck to confirm no TypeScript errors introduced</name>
  <files>N/A</files>
  <action>
  ```bash
  cd /Users/richard/Developer/tenant-flow
  pnpm typecheck 2>&1 | tail -20
  ```

  Fix any TypeScript errors introduced by changes in this plan. Do not fix pre-existing errors.
  </action>
  <verify>
  ```bash
  pnpm typecheck 2>&1 | grep -c "error TS" || echo "0"
  ```
  Zero new TypeScript errors from this plan's changes.
  </verify>
  <done>Typecheck passes with no new errors.</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] ConnectAccountStatus renders "Connect Stripe Account" CTA when no account exists
- [ ] Dialog opens and calls POST /api/v1/stripe/connect/onboard successfully
- [ ] Backend returns onboardingUrl pointing to Stripe
- [ ] Webhook account.updated is routed correctly to connect-webhook.handler.ts
- [ ] STRIPE_CONNECT_WEBHOOK_SECRET is present in config
- [ ] Manual verification checkpoint: all 4 steps passed
- [ ] pnpm typecheck passes
</verification>

<success_criteria>
- Owner can navigate to /settings?tab=billing and see the Connect section
- Clicking "Connect Stripe Account" opens the onboarding dialog
- Submitting the dialog fires POST /onboard and opens Stripe's onboarding URL
- account.updated webhook is correctly handled (status updates in DB)
- All TypeScript checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/34-stripe-connect/34-01-SUMMARY.md`:

---
phase: 34-stripe-connect
plan: 01
subsystem: payments
provides: stripe-connect-onboarding-verified
affects: [36-tenant-onboarding, 37-financial-wiring]
key-files:
  - apps/frontend/src/components/connect/connect-account-status.tsx
  - apps/frontend/src/components/settings/billing-settings.tsx
  - apps/frontend/src/app/(tenant)/tenant/settings/stripe-connect-onboarding.tsx
  - apps/backend/src/modules/billing/connect/connect.controller.ts
  - apps/backend/src/modules/billing/webhooks/handlers/connect-webhook.handler.ts
key-decisions:
  - ConnectOnboardingDialog lives at (tenant)/tenant/settings/ but is used by owner BillingSettings — path quirk, not a bug
  - Connect webhooks use STRIPE_CONNECT_WEBHOOK_SECRET (separate from platform STRIPE_WEBHOOK_SECRET)
---

# Phase 34 Plan 01 Summary: Stripe Connect E2E Verification

**[Headline: Connect onboarding flow verified — owner can initiate and complete Stripe Express onboarding]**

## Accomplishments

- ConnectAccountStatus "no account" empty state audited/fixed
- ConnectOnboardingDialog → POST /onboard → onboarding URL flow verified
- Webhook account.updated routing confirmed
- Manual walkthrough of Connect CTA → dialog → Stripe redirect completed

## Files Created/Modified

[list changes made]

## Key Findings

[list what was broken vs working]

## Next Step

Phase 34 complete. Ready for Phase 35: Subscription Enforcement.
Update STATE.md: Phase 35, Plan 01, Ready to plan.
</output>
