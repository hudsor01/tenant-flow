# Phase 19, Plan 01: Query Performance Audit & RPC Documentation

---
phase: 19-query-performance-rpc
plan: 01
type: standard
domain: database
---

<objective>
Audit database indexes for performance-critical query patterns, validate N+1 detection effectiveness, and document RPC usage guidelines in an ADR.

**Key Research Finding:** The codebase already has comprehensive query performance infrastructure (N+1 detection, RPC service, slow query logging). This plan focuses on verification and documentation, not code changes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
## Prior Phase Context

@.planning/phases/19-query-performance-rpc/19-CONTEXT.md
@.planning/phases/18-supabase-client-patterns/18-01-SUMMARY.md
@.planning/adr/0004-supabase-client-patterns.md

## Relevant Source Files

@apps/backend/src/database/supabase-instrumentation.service.ts
@apps/backend/src/interceptors/query-performance.interceptor.ts
@supabase/migrations/20251101000000_base_schema.sql

## Key Facts

**Tech stack available:** Prometheus metrics, CLS-based query tracking, Supabase RPC service with retries/caching

**Established patterns:**
- N+1 detection via `SupabaseInstrumentationService` (threshold: 8 same-signature queries)
- Slow query logging via `QueryPerformanceInterceptor` (threshold: 1s)
- RPC service with exponential backoff retries

**Constraining decisions:**
- Phase 18: Use admin client for webhooks, user client for authenticated requests
- ADR-0004: Three-tier client strategy documented

**Current infrastructure:**
- 30+ RPC functions already defined in migrations
- N+1 prevention tests exist for tenant and financial services
- CONCERNS.md: "No Specific Performance Issues Detected"
</context>

<tasks>

## Task 1: Audit Database Indexes

**Objective:** Verify indexes exist for foreign keys and frequently-queried columns.

**Actions:**
1. Extract all foreign key columns from base_schema.sql
2. Check which FK columns have explicit indexes vs relying on automatic PK indexes
3. Identify common query patterns from services (WHERE clauses on status, dates, etc.)
4. List any missing indexes that would improve query performance
5. If gaps found, create migration to add indexes (or document for future)

**Verification:**
- Document which FK columns have indexes
- List recommended indexes (if any) for common query patterns

**Done when:**
- Index audit complete with findings documented
- Any missing critical indexes identified

---

## Task 2: Validate N+1 Detection Effectiveness

**Objective:** Confirm the N+1 detection system catches real issues and logs appropriately.

**Actions:**
1. Review `SupabaseInstrumentationService.trackQuery()` implementation
2. Check if Prometheus metric `tenantflow_supabase_nplusone_detected_total` is being recorded
3. Review existing N+1 spec tests to understand coverage
4. Verify CLS context is properly initialized in request lifecycle
5. Document any gaps in N+1 detection coverage

**Verification:**
- N+1 detection confirmed working (or issues identified)
- Metrics endpoint includes N+1 counter

**Done when:**
- N+1 detection validated or improvements documented
- Test coverage for N+1 prevention confirmed adequate

---

## Task 3: Create RPC Patterns ADR

**Objective:** Document when to use Supabase RPCs vs direct queries for team reference.

**Actions:**
1. Create `docs/adr/0005-rpc-usage-patterns.md` (or `.planning/adr/` if docs/ gitignored)
2. Document:
   - When to use RPCs (atomic operations, complex aggregations, performance-critical paths)
   - When to use direct queries (simple CRUD, single-table operations)
   - Existing RPC inventory with purposes
   - RPC service features (retries, caching, instrumentation)
3. Include code snippets from actual implementation

**Verification:**
- ADR follows project template format
- Patterns documented with rationale
- Existing RPCs catalogued

**Done when:**
- ADR created documenting RPC usage guidelines
- Team can reference for consistency

</tasks>

<verification>
## Plan Verification

After completing all tasks:

1. **Index Audit Complete:**
   - FK columns checked for indexes
   - Common query patterns reviewed
   - Any recommendations documented

2. **N+1 Detection Validated:**
   - Instrumentation service confirmed working
   - Metrics verified
   - Test coverage confirmed

3. **Documentation Created:**
   - ADR documents RPC patterns
   - Team can reference for consistency
</verification>

<success_criteria>
- [ ] Index audit completed with findings documented
- [ ] N+1 detection validated (or issues identified)
- [ ] ADR created documenting RPC usage patterns
- [ ] No code refactoring required (patterns already correct) OR migration created for missing indexes
</success_criteria>

<output>
After execution:
1. Create `19-01-SUMMARY.md` with findings
2. Update `STATE.md` with any decisions made
3. Update `ROADMAP.md` with phase completion
4. Commit changes
</output>
