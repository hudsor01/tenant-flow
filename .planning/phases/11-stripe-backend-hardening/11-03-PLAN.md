---
phase: 11-stripe-backend-hardening
plan: 03
type: execute
---

<objective>
Replace manual customer and invoice pagination with SDK auto-pagination.

Purpose: Ensure consistent pagination behavior across all Stripe list operations.
Output: getAllCustomers() and getAllInvoices() use autoPagingToArray() instead of manual while loops.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-stripe-backend-hardening/11-RESEARCH.md

**Key files:**
@apps/backend/src/modules/billing/stripe-customer.service.ts
@apps/backend/src/modules/billing/stripe.service.ts

**From RESEARCH.md:**
- Use `autoPagingToArray({limit: 10000})` instead of manual while loops
- For customers, filter deleted ones after pagination completes
- SDK handles has_more, memory management automatically
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace getAllCustomers with autoPagingToArray</name>
  <files>apps/backend/src/modules/billing/stripe-customer.service.ts</files>
  <action>
Replace the manual while loop in `getAllCustomers` (lines 46-83) with SDK auto-pagination:

```typescript
/**
 * Get ALL customers with complete pagination
 * Uses SDK auto-pagination for reliability
 */
async getAllCustomers(params?: {
  email?: string
}): Promise<Stripe.Customer[]> {
  try {
    const requestParams: Stripe.CustomerListParams = {
      limit: this.STRIPE_DEFAULT_LIMIT,
      expand: ['data.subscriptions']
    }
    if (params?.email) {
      requestParams.email = params.email
    }

    const allCustomers = await this.stripe.customers
      .list(requestParams)
      .autoPagingToArray({ limit: 10000 })

    // Filter out deleted customers after pagination
    const activeCustomers = allCustomers.filter(c => !('deleted' in c))

    this.logger.log(`Fetched ${activeCustomers.length} total customers`)
    return activeCustomers
  } catch (error) {
    this.logger.error('Failed to get all customers', { error })
    throw error
  }
}
```

Key changes:
- Removes manual while loop with has_more
- Uses autoPagingToArray({limit: 10000})
- Filters deleted customers after pagination completes (simpler logic)
  </action>
  <verify>
grep -c "autoPagingToArray" apps/backend/src/modules/billing/stripe-customer.service.ts returns 1
grep -c "while (hasMore" apps/backend/src/modules/billing/stripe-customer.service.ts returns 0
pnpm --filter @repo/backend build passes
  </verify>
  <done>
- getAllCustomers uses autoPagingToArray
- Manual while loop removed
- Deleted customers filtered post-pagination
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace getAllInvoices with autoPagingToArray</name>
  <files>apps/backend/src/modules/billing/stripe.service.ts</files>
  <action>
Replace the manual while loop in `getAllInvoices` (lines 126-175) with SDK auto-pagination:

```typescript
/**
 * Get ALL invoices with complete pagination
 * Uses SDK auto-pagination for reliability
 */
async getAllInvoices(params?: {
  customer?: string
  subscription?: string
  status?: string
  created?: { gte?: number; lte?: number }
}): Promise<Stripe.Invoice[]> {
  try {
    const requestParams: Stripe.InvoiceListParams = {
      limit: this.STRIPE_DEFAULT_LIMIT,
      expand: ['data.subscription', 'data.customer']
    }
    if (params?.customer) {
      requestParams.customer = params.customer
    }
    if (params?.subscription) {
      requestParams.subscription = params.subscription
    }
    if (params?.status) {
      requestParams.status = params.status as Stripe.InvoiceListParams.Status
    }
    if (params?.created) {
      requestParams.created = params.created
    }

    const allInvoices = await this.stripe.invoices
      .list(requestParams)
      .autoPagingToArray({ limit: 10000 })

    this.logger.log(`Fetched ${allInvoices.length} total invoices`)
    return allInvoices
  } catch (error) {
    this.logger.error('Failed to get all invoices', { error })
    throw error
  }
}
```

Key changes:
- Removes manual while loop with has_more
- Removes startingAfter tracking
- Uses autoPagingToArray({limit: 10000})
  </action>
  <verify>
grep -c "autoPagingToArray" apps/backend/src/modules/billing/stripe.service.ts returns 1
grep -c "while (hasMore" apps/backend/src/modules/billing/stripe.service.ts returns 0
pnpm --filter @repo/backend build passes
  </verify>
  <done>
- getAllInvoices uses autoPagingToArray
- Manual while loop removed
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @repo/backend build` succeeds
- [ ] getAllCustomers uses autoPagingToArray in stripe-customer.service.ts
- [ ] getAllInvoices uses autoPagingToArray in stripe.service.ts
- [ ] No manual while loops with has_more in either file
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Customer and invoice pagination use SDK auto-pagination
- Consistent pattern across all Stripe list operations
</success_criteria>

<output>
After completion, append results to `.planning/phases/11-stripe-backend-hardening/11-01-SUMMARY.md`
</output>
