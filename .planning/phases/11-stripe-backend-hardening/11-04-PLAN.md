---
phase: 11-stripe-backend-hardening
plan: 04
type: execute
---

<objective>
Replace console.log with structured logging in backfill script.

Purpose: Enable searchable, filterable logs in production environments.
Output: backfill-stripe-customers.ts uses NestJS Logger pattern instead of console.log.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-stripe-backend-hardening/11-RESEARCH.md

**Key files:**
@apps/backend/scripts/backfill-stripe-customers.ts

**From RESEARCH.md:**
- Use NestJS Logger instead of console.log for production scripts
- Structured logging enables filtering and searching in log aggregators
- Pattern: `logger.log('message', { key: value })` instead of template strings
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Logger import and instantiation</name>
  <files>apps/backend/scripts/backfill-stripe-customers.ts</files>
  <action>
Add NestJS Logger import and create a logger instance at the top of the file after imports:

```typescript
import { Logger } from '@nestjs/common'

// After existing imports, before the env var block:
const logger = new Logger('BackfillStripeCustomers')
```

This creates a standalone logger that can be used outside the NestJS DI context (scripts run standalone).
  </action>
  <verify>
grep -c "Logger" apps/backend/scripts/backfill-stripe-customers.ts returns at least 2 (import and instantiation)
  </verify>
  <done>
- Logger imported from @nestjs/common
- Logger instance created with 'BackfillStripeCustomers' context
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace all console.log/error/warn calls with logger</name>
  <files>apps/backend/scripts/backfill-stripe-customers.ts</files>
  <action>
Replace all console.* calls with structured logger calls. The file has these occurrences:

1. Line 34: `console.error('Missing required env vars...')` → `logger.error('Missing required env vars', { required: ['SUPABASE_URL', 'STRIPE_SECRET_KEY', 'SUPABASE_*_KEY'] })`

2. Line 70: `console.error('Failed to persist...')` → `logger.error('Failed to persist Stripe customer to users table', { userId: user.id, error })`

3. Line 94: `console.error('Error fetching users...')` → `logger.error('Error fetching users without Stripe ID', { error })`

4. Line 104: `console.log('✔️ Backfilled Stripe...')` → `logger.log('Backfilled Stripe customer for user', { userId: user.id })`

5. Line 106: `console.error('Failed to backfill user...')` → `logger.error('Failed to backfill user', { userId: user.id, error: err })`

6. Line 133: `console.error('Error fetching tenants...')` → `logger.error('Error fetching tenants without Stripe ID', { error })`

7. Line 149: `console.warn('Skipping tenant...')` → `logger.warn('Skipping tenant: user not found', { tenantId: tenant.id, userId: tenant.user_id })`

8. Line 163: `console.error('Failed to update tenant...')` → `logger.error('Failed to update tenant with Stripe ID', { tenantId: tenant.id, error: tenantUpdateError })`

9. Line 171-173: `console.log('✔️ Linked tenant...')` → `logger.log('Linked tenant to Stripe customer', { tenantId: tenant.id, stripeCustomerId: stripeId })`

10. Line 175: `console.error('Failed to backfill tenant...')` → `logger.error('Failed to backfill tenant', { tenantId: tenant.id, error: err })`

11. Line 187: `console.log('Starting Stripe...')` → `logger.log('Starting Stripe customer backfill')`

12. Line 192-195: `console.log('Backfill complete...')` → `logger.log('Backfill complete', { usersCreated: userCreates, tenantsUpdated: tenantUpdates })`

13. Line 199-200: `console.error('Backfill failed...')` → `logger.error('Backfill failed', { error: err })`

Key pattern changes:
- Remove emoji characters (✔️) - they don't render well in log aggregators
- Use structured objects `{ key: value }` instead of template strings
- Use camelCase for object keys (userId not user_id) to match JS conventions
  </action>
  <verify>
grep -c "console\." apps/backend/scripts/backfill-stripe-customers.ts returns 0
grep -c "logger\." apps/backend/scripts/backfill-stripe-customers.ts returns at least 10
pnpm --filter @repo/backend build passes
  </verify>
  <done>
- All console.log replaced with logger.log
- All console.error replaced with logger.error
- All console.warn replaced with logger.warn
- Emoji characters removed
- Structured logging objects used throughout
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @repo/backend build` succeeds
- [ ] No console.log/error/warn calls remain in the file
- [ ] Logger properly imported and instantiated
- [ ] All log calls use structured objects
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Script uses NestJS Logger throughout
- Logs are structured and searchable
</success_criteria>

<output>
After completion, append results to `.planning/phases/11-stripe-backend-hardening/11-01-SUMMARY.md`
</output>
