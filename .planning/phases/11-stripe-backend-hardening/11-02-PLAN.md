---
phase: 11-stripe-backend-hardening
plan: 02
type: execute
---

<objective>
Replace manual subscription pagination with SDK auto-pagination.

Purpose: Eliminate the 1,000 item hard limit that could cause data loss when fetching subscriptions.
Output: getAllSubscriptions() uses autoPagingToArray() with 10,000 limit, STRIPE_MAX_TOTAL_ITEMS constant removed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-stripe-backend-hardening/11-RESEARCH.md

**Key files:**
@apps/backend/src/modules/billing/subscriptions/subscription.service.ts

**From RESEARCH.md:**
- Use `autoPagingToArray({limit: 10000})` instead of manual while loops
- SDK handles has_more, memory management, and edge cases automatically
- DON'T hand-roll: Manual while loops with has_more, arbitrary limits
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove hard pagination limit constant</name>
  <files>apps/backend/src/modules/billing/subscriptions/subscription.service.ts</files>
  <action>
Remove the `STRIPE_MAX_TOTAL_ITEMS` constant (line 13) as it creates an arbitrary limit that truncates data:

```typescript
// REMOVE THIS:
private readonly STRIPE_MAX_TOTAL_ITEMS = 1000
```

This constant was causing data loss when customers had more than 1,000 subscriptions.
  </action>
  <verify>
grep -c "STRIPE_MAX_TOTAL_ITEMS" apps/backend/src/modules/billing/subscriptions/subscription.service.ts returns 0
  </verify>
  <done>
- STRIPE_MAX_TOTAL_ITEMS constant removed
- No references to the constant remain
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace getAllSubscriptions with autoPagingToArray</name>
  <files>apps/backend/src/modules/billing/subscriptions/subscription.service.ts</files>
  <action>
Replace the manual while loop in `getAllSubscriptions` (lines 74-122) with SDK auto-pagination:

```typescript
/**
 * Get ALL subscriptions with complete pagination
 * Uses SDK auto-pagination for reliability
 */
async getAllSubscriptions(params?: {
  customer?: string
  status?: Stripe.SubscriptionListParams.Status
}): Promise<Stripe.Subscription[]> {
  try {
    const requestParams: Stripe.SubscriptionListParams = {
      limit: this.STRIPE_DEFAULT_LIMIT,
      expand: ['data.customer', 'data.items']
    }
    if (params?.customer) {
      requestParams.customer = params.customer
    }
    if (params?.status) {
      requestParams.status = params.status
    }

    const allSubscriptions = await this.stripe.subscriptions
      .list(requestParams)
      .autoPagingToArray({ limit: 10000 })

    this.logger.log(`Fetched ${allSubscriptions.length} total subscriptions`)
    return allSubscriptions
  } catch (error) {
    this.logger.error('Failed to get all subscriptions', { error })
    throw error
  }
}
```

Key changes:
- Removes manual while loop with has_more
- Removes startingAfter tracking
- Uses autoPagingToArray({limit: 10000}) for safe upper bound
- Removes warning about hitting max limit (SDK handles gracefully)
  </action>
  <verify>
grep -c "autoPagingToArray" apps/backend/src/modules/billing/subscriptions/subscription.service.ts returns 1
grep -c "while (hasMore" apps/backend/src/modules/billing/subscriptions/subscription.service.ts returns 0
pnpm --filter @repo/backend build passes without errors
  </verify>
  <done>
- getAllSubscriptions uses autoPagingToArray
- Manual while loop removed
- No arbitrary limits that could truncate data
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @repo/backend build` succeeds
- [ ] STRIPE_MAX_TOTAL_ITEMS constant is removed
- [ ] getAllSubscriptions uses autoPagingToArray
- [ ] No manual while loops with has_more in subscription.service.ts
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Subscription pagination uses SDK auto-pagination
- No arbitrary limits that could cause data loss
</success_criteria>

<output>
After completion, append results to `.planning/phases/11-stripe-backend-hardening/11-01-SUMMARY.md`
</output>
