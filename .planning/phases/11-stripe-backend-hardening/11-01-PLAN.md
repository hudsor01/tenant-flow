---
phase: 11-stripe-backend-hardening
plan: 01
type: execute
---

<objective>
Add Stripe SDK monitoring and configure automatic retry behavior.

Purpose: Enable observability into Stripe API calls (timing, errors, rate limits) and ensure automatic retry with exponential backoff for transient failures.
Output: StripeClientService with event listeners logging all API interactions, configured with maxNetworkRetries: 2.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-stripe-backend-hardening/11-RESEARCH.md

**Key files:**
@apps/backend/src/shared/stripe-client.service.ts
@apps/backend/src/logger/app-logger.service.ts

**From RESEARCH.md:**
- SDK emits `request` and `response` events with timing, status, request IDs
- Configure `maxNetworkRetries: 2` (default is 1) for automatic exponential backoff
- DON'T hand-roll: Request timing, request ID tracking - use SDK events
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stripe SDK event listeners for monitoring</name>
  <files>apps/backend/src/shared/stripe-client.service.ts</files>
  <action>
Add SDK event listeners to the StripeClientService constructor AFTER stripe client initialization:

1. Inject AppLogger into constructor (add to imports)
2. Add `stripe.on('response', ...)` listener that logs:
   - method, path, status, request_id, elapsed (ms)
   - Warn if elapsed > 2000ms (slow request)
   - Error if status === 429 (rate limit hit)
3. Optionally add `stripe.on('request', ...)` for debug-level request logging

Use the pattern from RESEARCH.md code_examples section. Use `this.logger` not console.log.

DO NOT add custom metrics/counters yet - just logging. Metrics can come in a later phase if needed.
  </action>
  <verify>
pnpm --filter @repo/backend build passes without errors
grep -r "stripe.on" apps/backend/src/shared/stripe-client.service.ts shows event listeners
  </verify>
  <done>
- Event listeners attached to Stripe client
- Response events logged with method, path, status, requestId, elapsedMs
- Slow requests (>2s) logged at warn level
- Rate limit hits (429) logged at error level
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure maxNetworkRetries for automatic rate limit handling</name>
  <files>apps/backend/src/shared/stripe-client.service.ts</files>
  <action>
Add `maxNetworkRetries: 2` to the Stripe client configuration options:

```typescript
this.stripe = new Stripe(stripeSecretKey, {
  apiVersion: '2025-11-17.clover',
  typescript: true,
  maxNetworkRetries: 2, // ADD THIS - automatic exponential backoff on transient failures
})
```

This enables the SDK's built-in retry logic with exponential backoff for:
- Network failures
- Rate limit errors (429)
- Server errors (5xx)

The SDK automatically handles idempotency keys for retried requests.

DO NOT add custom retry logic - the SDK handles this.
  </action>
  <verify>
grep "maxNetworkRetries" apps/backend/src/shared/stripe-client.service.ts shows configuration
pnpm --filter @repo/backend build passes
  </verify>
  <done>
- maxNetworkRetries: 2 configured in Stripe client options
- Build passes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @repo/backend build` succeeds
- [ ] Event listeners are attached in stripe-client.service.ts
- [ ] maxNetworkRetries: 2 is configured
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Stripe SDK now logs all API interactions
- Automatic retry configured for transient failures
</success_criteria>

<output>
After completion, create `.planning/phases/11-stripe-backend-hardening/11-01-SUMMARY.md`
</output>
