# Phase 18, Plan 01: Supabase Configuration Audit & Documentation

<objective>
Verify Supabase client patterns and connection configuration align with official best practices, then document patterns for team reference.

**Key Research Finding:** The codebase already implements Supabase best practices correctly (singleton admin client, user client pool with `accessToken` callback, lifecycle management). This plan focuses on configuration verification and documentation, not code refactoring.
</objective>

<execution_context>
@.planning/phases/18-supabase-client-patterns/18-RESEARCH.md
@.planning/phases/18-supabase-client-patterns/18-CONTEXT.md
@apps/backend/src/database/supabase.module.ts
@apps/backend/src/database/supabase.service.ts
@apps/backend/src/database/supabase-user-client-pool.ts
@apps/backend/src/database/supabase-rpc.service.ts
</execution_context>

<context>
## Current State (from Research)

The backend Supabase implementation is well-architected:

1. **Singleton Admin Client** ✅ - Created via NestJS DI, proper auth settings
2. **User Client Pool** ✅ - Uses `accessToken` callback (recommended pattern), TTL-based caching
3. **Lifecycle Management** ✅ - OnModuleDestroy cleanup implemented
4. **RPC Service** ✅ - Retries with exponential backoff, caching, instrumentation

## Verification Focus

1. **Connection String Configuration** - Verify using pooler URL with transaction mode (port 6543)
2. **Environment Variables** - Confirm all required Supabase vars are documented
3. **Observability Gaps** - Check if connection pool metrics are exposed
4. **Documentation** - Codify patterns in ADR for team reference
</context>

<tasks>

## Task 1: Verify Connection String Configuration

**Objective:** Confirm connection strings use Supavisor pooler URL with transaction mode for optimal performance.

**Actions:**
1. Check `apps/backend/src/database/supabase.constants.ts` for connection config
2. Verify environment variables in `turbo.json` and backend env handling
3. Confirm connection strings use port 6543 (transaction mode) not 5432 (session mode)
4. If using session mode, evaluate whether transaction mode is appropriate

**Verification:**
- Connection strings documented and correct
- Transaction mode used where appropriate for stateless backend

---

## Task 2: Audit Observability & Metrics

**Objective:** Verify connection pool health is observable; add metrics if missing.

**Actions:**
1. Check `supabase-instrumentation.service.ts` for existing metrics
2. Check `supabase-health.service.ts` for health check implementation
3. Verify user client pool exposes metrics (pool size, hit rate, evictions)
4. If metrics missing, add Prometheus counters for:
   - `supabase_user_client_pool_size`
   - `supabase_user_client_pool_hits_total`
   - `supabase_user_client_pool_misses_total`

**Verification:**
- Metrics endpoint includes Supabase pool health
- Grafana/monitoring can track connection pool performance

---

## Task 3: Create Supabase Patterns ADR

**Objective:** Document current patterns in an ADR for team reference and onboarding.

**Actions:**
1. Create `docs/adr/NNNN-supabase-client-patterns.md`
2. Document:
   - Singleton admin client pattern and why
   - User client pool with `accessToken` callback
   - Connection string configuration (pooler URL, transaction mode)
   - Lifecycle management (OnModuleDestroy)
   - When to use admin vs user client
3. Include code snippets from actual implementation

**Verification:**
- ADR follows project template format
- Patterns documented with rationale

</tasks>

<verification>
## Plan Verification

After completing all tasks:

1. **Configuration Verified:**
   - Connection strings use pooler URL with appropriate mode
   - Environment variables documented

2. **Observability Complete:**
   - Connection pool metrics exposed (or confirmed already present)
   - Health checks cover Supabase connectivity

3. **Documentation Created:**
   - ADR documents Supabase patterns
   - Team can reference for consistency
</verification>

<success_criteria>
- [ ] Connection string configuration verified and documented
- [ ] Observability gaps identified and addressed (metrics added if missing)
- [ ] ADR created documenting Supabase client patterns
- [ ] No code refactoring required (patterns already correct)
</success_criteria>

<output>
After execution:
1. Update `18-01-SUMMARY.md` with findings
2. Update `STATE.md` with any decisions made
3. Mark phase complete if no additional work needed
</output>
