---
phase: 02-database-stability
plan: 02
type: execute
---

<objective>
Add CI/CD pipeline validation for database migrations to catch errors before merge.

Purpose: Prevent broken migrations from reaching production by validating SQL syntax and structure in CI.
Output: GitHub Action workflow for migration validation, documented migration development process.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-stability/02-01-SUMMARY.md (will exist after 02-01)

**Existing CI/CD:**
@.github/workflows/ci-cd.yml

**Codebase context:**
@.planning/codebase/CONCERNS.md (mentions missing CI migration validation)

**Key insight:**
Current CI has lint, typecheck, tests - but NO migration validation. This means broken migrations aren't caught until deployment.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration validation workflow</name>
  <files>.github/workflows/migrations.yml</files>
  <action>
    Create a new reusable workflow that validates migrations:

    ```yaml
    name: Migration Validation

    on:
      workflow_call:
        inputs:
          pnpm-version:
            type: string
            default: '10.23.0'
          node-version:
            type: string
            default: '24'

    jobs:
      validate-migrations:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Setup pnpm
            uses: pnpm/action-setup@v4
            with:
              version: ${{ inputs.pnpm-version }}

          - name: Setup Node
            uses: actions/setup-node@v4
            with:
              node-version: ${{ inputs.node-version }}
              cache: pnpm

          - name: Install Supabase CLI
            run: |
              curl -sSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar -xz
              sudo mv supabase /usr/local/bin/

          - name: Validate migration syntax
            run: |
              # Check all .sql files for basic syntax issues
              for file in supabase/migrations/*.sql; do
                echo "Checking: $file"
                # Supabase CLI doesn't have a pure syntax check, so we verify:
                # 1. File is valid UTF-8
                # 2. File ends with newline
                # 3. No Windows line endings
                if ! file "$file" | grep -q "UTF-8\|ASCII"; then
                  echo "ERROR: $file is not valid UTF-8"
                  exit 1
                fi
                if [[ $(tail -c 1 "$file" | wc -l) -eq 0 ]]; then
                  echo "WARNING: $file does not end with newline"
                fi
                if grep -q $'\r' "$file"; then
                  echo "ERROR: $file contains Windows line endings (CRLF)"
                  exit 1
                fi
              done
              echo "All migration files validated"

          - name: Check migration naming convention
            run: |
              # Verify all migrations follow YYYYMMDDHHmmss_description.sql pattern
              for file in supabase/migrations/*.sql; do
                basename=$(basename "$file")
                if ! echo "$basename" | grep -qE '^[0-9]{14}_[a-z0-9_]+\.sql$'; then
                  echo "ERROR: $basename does not follow naming convention (YYYYMMDDHHmmss_description.sql)"
                  exit 1
                fi
              done
              echo "All migration names follow convention"
    ```

    This validates:
    - File encoding (UTF-8 or ASCII)
    - No CRLF line endings
    - Naming convention compliance
  </action>
  <verify>File exists at .github/workflows/migrations.yml</verify>
  <done>Migration validation workflow created</done>
</task>

<task type="auto">
  <name>Task 2: Add migration validation to CI pipeline</name>
  <files>.github/workflows/ci-cd.yml</files>
  <action>
    Add migration validation to the main CI/CD workflow:

    After the existing jobs (lint, typecheck, tests), add:

    ```yaml
      migrations:
        uses: ./.github/workflows/migrations.yml
        with:
          pnpm-version: '10.23.0'
          node-version: '24'
    ```

    This ensures migration validation runs on every PR and push to main/develop.
  </action>
  <verify>grep -q "migrations:" .github/workflows/ci-cd.yml returns success</verify>
  <done>Migration validation integrated into CI pipeline</done>
</task>

<task type="auto">
  <name>Task 3: Verify CI changes locally</name>
  <files>None (verification only)</files>
  <action>
    Run the validation checks locally to ensure they pass:

    1. Check file encoding:
       ```bash
       for file in supabase/migrations/*.sql; do file "$file"; done | head -5
       ```

    2. Check naming convention:
       ```bash
       for file in supabase/migrations/*.sql; do
         basename=$(basename "$file")
         if echo "$basename" | grep -qE '^[0-9]{14}_[a-z0-9_]+\.sql$'; then
           echo "OK: $basename"
         else
           echo "FAIL: $basename"
         fi
       done | grep FAIL | head -5
       ```

    3. Check for CRLF line endings:
       ```bash
       grep -rl $'\r' supabase/migrations/*.sql 2>/dev/null | head -5 || echo "No CRLF files found"
       ```

    Fix any issues found.
  </action>
  <verify>All local validation checks pass</verify>
  <done>CI validation verified to work with current migrations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .github/workflows/migrations.yml exists with validation logic
- [ ] .github/workflows/ci-cd.yml includes migrations job
- [ ] Local validation passes for all current migrations
</verification>

<success_criteria>

- Migration validation workflow created
- Validation integrated into main CI pipeline
- All current migrations pass validation
- Phase 2: Database Stability complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-stability/02-02-SUMMARY.md`

**Phase completion:** This is the final plan for Phase 2. After SUMMARY.md, update:
- STATE.md: Phase 2 complete, ready for Phase 3
- ROADMAP.md: Mark Phase 2 checkbox as complete
</output>
