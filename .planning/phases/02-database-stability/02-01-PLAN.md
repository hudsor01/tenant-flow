---
phase: 02-database-stability
plan: 01
type: execute
---

<objective>
Audit migration health and add stripe schema safeguards to prevent migration failures.

Purpose: Ensure migrations fail gracefully when stripe schema doesn't exist (e.g., fresh Supabase instance before Stripe sync runs).
Output: Protected migrations, verified migration chain, documented audit findings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-security/01-01-SUMMARY.md
@.planning/phases/02-database-stability/02-RESEARCH.md

**Codebase context:**
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md

**Prior decisions:**
- Phase 1: Stripe RLS pattern established via customer table linkage with schema existence check

**Resolved issues (no work needed):**
- 35 .sql.skip files: Already integrated (confirmed 0 exist)
- property_owner_id cascade: Column renamed to owner_user_id in production
- Duplicate function definitions: CREATE OR REPLACE handles gracefully (tech debt, not blocking)

**Actual issues to address:**
- 16 migrations reference stripe.* schema
- Only 1 migration (20251220060000) has proper schema existence checks
- Missing checks could cause migration failures on fresh instances
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit stripe-dependent migrations</name>
  <files>supabase/migrations/*.sql (audit only, no modifications)</files>
  <action>
    Scan all 16 migrations that reference stripe.* and categorize:

    1. **Protected** (has schema existence check) - document as OK
    2. **Needs protection** (references stripe.* without check) - list for Task 2
    3. **Safe** (uses IF EXISTS/DROP POLICY IF EXISTS pattern) - document as acceptable

    Output audit to console showing:
    - Migration filename
    - Protection status
    - Stripe objects referenced

    Do NOT modify any files in this task.
  </action>
  <verify>Audit output lists all 16 stripe-referencing migrations with protection status</verify>
  <done>All stripe-dependent migrations categorized by protection status</done>
</task>

<task type="auto">
  <name>Task 2: Add stripe schema checks to vulnerable migrations</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_add_stripe_schema_safeguards.sql (new file)</files>
  <action>
    Create a NEW migration (not modifying existing ones) that:

    1. Adds a reusable helper function `public.require_stripe_schema()` that:
       - Checks if stripe schema exists
       - Returns true if exists, false otherwise
       - Can be called by any migration needing stripe

    2. Documents which existing migrations would benefit from protection
       (as comments, not actual changes to historical migrations)

    Pattern to use:
    ```sql
    CREATE OR REPLACE FUNCTION public.require_stripe_schema()
    RETURNS boolean
    LANGUAGE plpgsql
    AS $$
    BEGIN
      RETURN EXISTS (
        SELECT 1 FROM pg_namespace WHERE nspname = 'stripe'
      );
    END;
    $$;

    COMMENT ON FUNCTION public.require_stripe_schema() IS
      'Returns true if stripe schema exists. Use in migrations: IF public.require_stripe_schema() THEN ... END IF;';
    ```

    This is a forward-looking safeguard - new migrations can use it, existing ones are fine as-is since they've already run.
  </action>
  <verify>Migration file exists and is valid SQL</verify>
  <done>Helper function created for future stripe-dependent migrations</done>
</task>

<task type="auto">
  <name>Task 3: Verify migration chain with dry-run</name>
  <files>None (verification only)</files>
  <action>
    Run `supabase db push --dry-run` to verify:
    1. All migrations parse correctly
    2. No syntax errors in new migration
    3. Migration chain is consistent

    If dry-run fails, diagnose and fix the issue.
    If Supabase CLI not authenticated, note this for checkpoint.
  </action>
  <verify>supabase db push --dry-run completes without errors (or documents auth requirement)</verify>
  <done>Migration chain verified as healthy, or auth requirement documented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 16 stripe-dependent migrations audited
- [ ] Helper function migration created
- [ ] Migration chain verified or auth blocker documented
</verification>

<success_criteria>

- Audit completed showing protection status of all stripe migrations
- Helper function created for future safeguards
- Migration chain verified healthy
- No new errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-stability/02-01-SUMMARY.md`
</output>
