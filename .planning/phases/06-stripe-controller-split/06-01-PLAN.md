---
phase: 06-stripe-controller-split
plan: 01
type: execute
subsystem: backend
---

<objective>
Split stripe.controller.ts (760 lines) into focused controllers by operation type.

Purpose: Improve maintainability by grouping related endpoints into separate controllers.
Output: 3 new controllers (charges, checkout, invoices) with stripe.controller.ts reduced to core operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/TECH_DEBT.md

# Current controller structure (760 lines)
@apps/backend/src/modules/billing/stripe.controller.ts

Sections identified:
- Account & Balance Operations (2 endpoints) - KEEP in main
- Charge Operations (2 endpoints) - EXTRACT
- Refund Operations (2 endpoints) - EXTRACT with charges
- Checkout Session Operations (3 endpoints) - EXTRACT
- Invoice Operations (3 endpoints) - EXTRACT
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract charges and refunds controller</name>
  <files>
    apps/backend/src/modules/billing/charges.controller.ts
  </files>
  <action>
1. Create `billing/charges.controller.ts`:
   - Extract: GET /charges, GET /charges/:id
   - Extract: POST /refunds, GET /refunds
   - Use @Controller('stripe') to maintain route paths
   - Include all Swagger decorators
   - Inject StripeService, StripeSharedService, AppLogger

2. Update imports from stripe.controller.ts

3. Keep route paths unchanged (e.g., /stripe/charges, /stripe/refunds)
  </action>
  <verify>File created with 4 endpoints</verify>
  <done>Charges controller extracted</done>
</task>

<task type="auto">
  <name>Task 2: Extract checkout controller</name>
  <files>
    apps/backend/src/modules/billing/checkout.controller.ts
  </files>
  <action>
1. Create `billing/checkout.controller.ts`:
   - Extract: POST /checkout-sessions
   - Extract: GET /checkout-sessions/:id
   - Extract: POST /checkout-sessions/:id/expire
   - Use @Controller('stripe') to maintain route paths
   - Include all Swagger decorators

2. Update imports from stripe.controller.ts
  </action>
  <verify>File created with 3 endpoints</verify>
  <done>Checkout controller extracted</done>
</task>

<task type="auto">
  <name>Task 3: Extract invoices controller</name>
  <files>
    apps/backend/src/modules/billing/invoices.controller.ts
  </files>
  <action>
1. Create `billing/invoices.controller.ts`:
   - Extract: POST /invoices
   - Extract: POST /invoices/:id/send
   - Extract: POST /invoices/:id/void
   - Use @Controller('stripe') to maintain route paths
   - Include all Swagger decorators

2. Update imports from stripe.controller.ts
  </action>
  <verify>File created with 3 endpoints</verify>
  <done>Invoices controller extracted</done>
</task>

<task type="auto">
  <name>Task 4: Update stripe.module.ts and cleanup</name>
  <files>
    apps/backend/src/modules/billing/stripe.module.ts
    apps/backend/src/modules/billing/stripe.controller.ts
  </files>
  <action>
1. Update stripe.module.ts:
   - Add ChargesController, CheckoutController, InvoicesController to controllers array
   - Keep StripeController for account/balance endpoints

2. Clean up stripe.controller.ts:
   - Remove extracted endpoint methods
   - Keep only Account & Balance Operations section
   - Update file header comment

3. Run typecheck and tests:
   ```bash
   pnpm --filter @repo/backend typecheck
   pnpm --filter @repo/backend test:unit
   ```
  </action>
  <verify>
    - `pnpm --filter @repo/backend typecheck` passes
    - `pnpm --filter @repo/backend test:unit` passes
    - stripe.controller.ts reduced to <200 lines
  </verify>
  <done>Module updated, all controllers integrated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] billing/charges.controller.ts exists (4 endpoints)
- [ ] billing/checkout.controller.ts exists (3 endpoints)
- [ ] billing/invoices.controller.ts exists (3 endpoints)
- [ ] stripe.controller.ts reduced to ~150 lines (account/balance only)
- [ ] stripe.module.ts registers all controllers
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit` passes
</verification>

<success_criteria>
- stripe.controller.ts reduced from 760 to <200 lines
- 3 new focused controllers created
- All endpoints maintain same route paths
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-stripe-controller-split/06-01-SUMMARY.md` using summary template.
</output>
