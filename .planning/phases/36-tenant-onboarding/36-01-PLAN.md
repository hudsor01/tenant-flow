---
phase: 36-tenant-onboarding
plan: 01
type: execute
---

<objective>
Verify and fix the end-to-end tenant journey: owner invites tenant → tenant accepts invite → tenant activates account → tenant can view lease and pay rent.

Purpose: The invitation flow and payment flow code exists but has never been verified end-to-end. This plan walks every step from invitation email through rent payment and fixes any gaps. The primary goal is: a real tenant can sign up from an invitation and make a rent payment.
Output: Complete tenant onboarding flow working — invitation, accept, activate, pay rent.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/backend/src/modules/tenants/tenant-invitation.controller.ts
@apps/frontend/src/app/(auth)/accept-invite/page.tsx
@apps/frontend/src/app/(tenant)/tenant/payments/new/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit invite endpoint and InviteWithLeaseDto</name>
  <files>
    apps/backend/src/modules/tenants/tenant-invitation.controller.ts
    apps/backend/src/modules/tenants/tenant-platform-invitation.service.ts
  </files>
  <action>
  Read `tenant-invitation.controller.ts` to understand the POST /tenants/invite endpoint.

  Check the DTO shape:
  ```bash
  grep -rn "InviteWithLeaseDto\|inviteDto\|InviteToplatform" \
    apps/backend/src/modules/tenants/ | head -15
  ```

  Verify the endpoint:
  1. Accepts: `{ email, first_name, last_name, phone?, property_id?, unit_id? }`
  2. Validates property ownership (if property_id provided)
  3. Creates invitation record with 6-hour expiry token
  4. Emits email event via EventEmitter2

  Check what email event handler exists:
  ```bash
  grep -rn "tenant.*invitation\|invitation.*email\|TENANT_INVITED" \
    apps/backend/src/ | head -10
  ```

  If no email handler exists (the invitation email never sends), document this as a gap — the flow technically works if the token is extracted directly from the DB, but real-world usage needs the email.

  Check if there's a mock/dev email setup:
  ```bash
  grep -rn "MailService\|emailService\|resend\|nodemailer\|smtp" \
    apps/backend/src/ | head -10
  ```
  </action>
  <verify>
  ```bash
  grep -rn "InviteToPlatformResponse\|invitation_id\|invitation_token" \
    apps/backend/src/modules/tenants/ | head -10
  ```
  POST /tenants/invite endpoint audited. Email sending mechanism identified.
  </verify>
  <done>Invite endpoint audited. Email sending gap (if any) documented.</done>
</task>

<task type="auto">
  <name>Task 2: Audit accept-invite page and API flow</name>
  <files>
    apps/frontend/src/app/(auth)/accept-invite/page.tsx
    apps/backend/src/modules/tenants/tenant-invitation-token.service.ts
  </files>
  <action>
  Read `accept-invite/page.tsx` in full.

  Verify the complete acceptance flow:
  1. Reads `code` from URL query params
  2. Calls `GET /api/v1/tenants/invitation/{code}` to validate
  3. Displays invitation details (owner name, property, email)
  4. Tenant submits signup form (email pre-filled, password, confirm)
  5. Calls `supabase.auth.signUp({ email, password })`
  6. Calls `POST /api/v1/tenants/invitation/{code}/accept { authuser_id }`
  7. Redirects to `/tenant/onboarding`

  Check that steps 5-7 handle errors gracefully:
  ```bash
  grep -n "signUp\|auth\|accept\|error\|catch" \
    apps/frontend/src/app/\(auth\)/accept-invite/page.tsx | head -30
  ```

  Read `tenant-invitation-token.service.ts`:
  ```bash
  grep -n "acceptToken\|validateToken\|activateTenantFromAuthUser" \
    apps/backend/src/modules/tenants/tenant-invitation-token.service.ts | head -20
  ```

  Verify `POST /invitation/:token/accept` marks the token as used, creates the `tenants` record, and links to a lease if `unit_id` was provided during invitation.
  </action>
  <verify>
  ```bash
  grep -n "accept\|tenants.*insert\|tenant.*record" \
    apps/backend/src/modules/tenants/tenant-invitation-token.service.ts | head -15
  ```
  Accept flow creates tenant record and marks invitation as used.
  </verify>
  <done>Accept invite page and backend acceptToken flow audited.</done>
</task>

<task type="auto">
  <name>Task 3: Audit tenant onboarding page and activation endpoint</name>
  <files>
    apps/frontend/src/app/(tenant)/tenant/onboarding/page.tsx
    apps/backend/src/modules/tenants/tenant-invitation.controller.ts
  </files>
  <action>
  Read `tenant/onboarding/page.tsx` in full.

  Verify the state machine:
  1. Gets Supabase session
  2. Calls `POST /api/v1/tenants/activate { authuser_id }`
  3. On success, shows success message and redirects to `/tenant`

  Check for edge cases:
  - What if the tenant visits `/tenant/onboarding` without completing `/accept-invite` first?
  - What if `activate` is called for an already-activated tenant?

  ```bash
  grep -n "activate\|authuser_id\|error\|redirect" \
    apps/frontend/src/app/\(tenant\)/tenant/onboarding/page.tsx | head -30
  ```

  Check `POST /tenants/activate` backend handler:
  ```bash
  grep -n "activateTenant\|activate\|@Post\|@SetMetadata" \
    apps/backend/src/modules/tenants/tenant-invitation.controller.ts | head -15
  ```

  Verify `activateTenantFromAuthUser` is idempotent (calling it twice doesn't fail):
  ```bash
  grep -n "activateTenantFromAuthUser\|already.*active\|ON CONFLICT" \
    apps/backend/src/modules/tenants/tenant-invitation-token.service.ts | head -15
  ```
  </action>
  <verify>
  ```bash
  grep -n "isPublic\|@SetMetadata" \
    apps/backend/src/modules/tenants/tenant-invitation.controller.ts | head -5
  ```
  POST /tenants/activate is marked as public (no JWT guard) since tenant has just created their account.
  </verify>
  <done>Onboarding page and activation endpoint audited. Edge cases documented.</done>
</task>

<task type="auto">
  <name>Task 4: Audit tenant portal access guard</name>
  <files>
    apps/frontend/src/app/(tenant)/tenant/page.tsx
    apps/backend/src/modules/tenant-portal/
  </files>
  <action>
  Check how the tenant portal is protected. The tenant user_type is set to 'TENANT' after activation.

  Frontend: Check how the tenant dashboard route group `(tenant)` is protected:
  ```bash
  grep -rn "user_type\|TENANT\|TenantAuthGuard\|middleware" \
    apps/frontend/src/app/\(tenant\)/ | head -15
  ```

  Backend: Check TenantAuthGuard:
  ```bash
  grep -rn "TenantAuthGuard\|user_type.*TENANT\|userType.*tenant" \
    apps/backend/src/ | head -20
  ```

  Key question: After `POST /tenants/activate`, does the tenant's JWT get refreshed to reflect `user_type: TENANT`? If not, the tenant may get access denied trying to reach the portal immediately after activation.

  Check if `activateTenantFromAuthUser` updates `app_metadata`:
  ```bash
  grep -n "app_metadata\|user_type\|auth.admin\|updateUserById" \
    apps/backend/src/modules/tenants/tenant-invitation-token.service.ts | head -15
  ```

  If `app_metadata.user_type` is not updated, the tenant's JWT won't reflect TENANT status until they log out and back in. This is a critical gap if it exists.
  </action>
  <verify>
  ```bash
  grep -n "app_metadata\|user_type.*TENANT\|auth.admin.updateUserById" \
    apps/backend/src/modules/tenants/tenant-invitation-token.service.ts | head -10
  ```
  After activation, user's app_metadata.user_type is set to 'TENANT' (or tenant checks use DB lookup not JWT).
  </verify>
  <done>Tenant portal access mechanism audited. JWT refresh requirement documented.</done>
</task>

<task type="auto">
  <name>Task 5: Audit Pay Rent flow — payment methods and amount-due</name>
  <files>
    apps/frontend/src/app/(tenant)/tenant/payments/new/page.tsx
    apps/backend/src/modules/tenant-portal/payments/payments.controller.ts
  </files>
  <action>
  Read `payments/new/page.tsx` in full.

  The pay rent flow requires:
  1. `GET /api/v1/tenant-portal/payments/amount-due` → base rent + late fees
  2. `GET /api/v1/stripe/tenant-payment-methods` → saved payment methods
  3. User selects payment method
  4. `POST /api/v1/tenant-portal/payments/pay-rent { payment_method_id, amount_cents }`

  Critical gap check: What happens if the tenant has NO saved payment methods?
  ```bash
  grep -n "no.*method\|payment.*method.*empty\|addMethod\|setup.*intent" \
    apps/frontend/src/app/\(tenant\)/tenant/payments/new/page.tsx | head -15
  ```

  Check if there's a "Add payment method" flow:
  ```bash
  ls apps/frontend/src/app/\(tenant\)/tenant/payments/methods/ 2>/dev/null
  grep -rn "SetupIntent\|AddPaymentMethod\|useAddPaymentMethod" \
    apps/frontend/src/app/\(tenant\)/ | head -10
  ```

  Read `payments.controller.ts` to check:
  - Does `amount-due` work when no lease is active (returns 0 gracefully)?
  - Does `pay-rent` validate that `payment_method_id` belongs to this tenant?
  ```bash
  grep -n "amount-due\|pay-rent\|getAmountDue\|payRent" \
    apps/backend/src/modules/tenant-portal/payments/payments.controller.ts | head -20
  ```
  </action>
  <verify>
  ```bash
  grep -n "noMethods\|payment.*method\|addMethod\|/methods" \
    apps/frontend/src/app/\(tenant\)/tenant/payments/new/page.tsx | head -10
  ```
  Pay rent page handles the case where tenant has no payment methods.
  </verify>
  <done>Pay rent flow audited. Payment method setup gap (if any) documented.</done>
</task>

<task type="auto">
  <name>Task 6: Fix the most critical gaps found in audit</name>
  <files>
    apps/frontend/src/app/(tenant)/tenant/payments/new/page.tsx
    apps/frontend/src/app/(tenant)/tenant/payments/methods/page.tsx (if exists)
    apps/backend/src/modules/tenants/tenant-invitation-token.service.ts
    apps/backend/src/modules/tenant-portal/payments/payments.controller.ts
  </files>
  <action>
  Based on findings from Tasks 1-5, fix the most critical gaps. Focus on P0/P1 issues:

  **Priority 1: JWT not refreshed after activation (if found in Task 4)**

  If `activateTenantFromAuthUser` doesn't update `app_metadata`, add the Supabase admin call:
  ```typescript
  // In tenant-invitation-token.service.ts
  await supabaseAdmin.auth.admin.updateUserById(authUserId, {
    app_metadata: { user_type: 'TENANT' }
  })
  ```

  Then the onboarding page should call `supabase.auth.refreshSession()` after activation to get the updated token before redirecting to /tenant.

  **Priority 2: No payment methods empty state (if found in Task 5)**

  If the pay rent page doesn't handle the "no payment methods" case, add an empty state that links to the payment methods setup page:
  ```tsx
  {methods.length === 0 && (
    <div className="text-center py-8">
      <p className="text-muted-foreground mb-4">
        No payment methods added yet.
      </p>
      <Button asChild>
        <Link href="/tenant/payments/methods">Add Payment Method</Link>
      </Button>
    </div>
  )}
  ```

  **Priority 3: Email sending gap (if found in Task 1)**

  If no email is sent on invitation, add a TODO comment and ensure the development flow at least logs the invitation token to console for testing:
  ```typescript
  // Temporary: log token for development testing
  this.logger.log('Invitation token (DEV ONLY)', { token, email: dto.email })
  ```

  Fix only what was found in the audit. Do not add hypothetical fixes.
  </action>
  <verify>
  ```bash
  # Verify the specific fixes applied
  grep -rn "refreshSession\|user_type.*TENANT\|app_metadata" \
    apps/frontend/src/app/\(tenant\)/tenant/onboarding/page.tsx 2>/dev/null | head -5
  ```
  Critical gaps fixed based on audit findings.
  </verify>
  <done>Critical gaps identified and fixed: JWT refresh after activation, payment methods empty state, email logging for dev testing.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Tenant onboarding and payment flow</what-built>
  <how-to-verify>
  Use the E2E test tenant account if available, or create a new one through the invitation flow.

  Check `.env.test` or `apps/e2e-tests/playwright/.auth/tenant.json` for tenant credentials.
  Tenant email: `E2E_TENANT_EMAIL` from `.env.test`
  The tenant portal is at: http://localhost:3050/tenant

  **Invitation flow (if testing from scratch):**
  1. As owner, go to /tenants → Invite Tenant
  2. Fill email, first/last name, optionally assign property
  3. Submit → verify success toast
  4. Check backend logs for invitation token (if no email)
  5. Navigate to /accept-invite?code={token}
  6. Create account → verify redirects to /tenant/onboarding
  7. Onboarding activates → verify redirects to /tenant

  **Existing tenant account flow:**
  Sign in as tenant account.

  **--- Tenant Portal ---**
  1. `/tenant` loads — dashboard visible, not 404 ✅/❌
  2. Current lease visible (if tenant has a lease assigned) ✅/❌ (N/A acceptable)
  3. Rent amount shown ✅/❌ (N/A acceptable)

  **--- Payments ---**
  4. `/tenant/payments` loads — payments page visible ✅/❌
  5. "Pay Rent" CTA visible ✅/❌
  6. `/tenant/payments/new` loads without crash ✅/❌
  7. Amount due displayed (or $0 / no lease) ✅/❌
  8. Payment methods section shows (even if empty) ✅/❌

  **--- Lease ---**
  9. `/tenant/lease` loads without crash ✅/❌ (can be empty state)

  **--- Maintenance ---**
  10. `/tenant/maintenance` loads ✅/❌
  11. Submit request form opens ✅/❌
  </how-to-verify>
  <resume-signal>
  Paste results:
  1. Tenant dashboard: PASS/FAIL
  2. Lease visible: PASS/FAIL/N/A
  3. Rent amount: PASS/FAIL/N/A
  4. Payments page: PASS/FAIL
  5. Pay Rent CTA: PASS/FAIL
  6. /payments/new loads: PASS/FAIL
  7. Amount due: PASS/FAIL/N/A
  8. Payment methods: PASS/FAIL
  9. Lease page: PASS/FAIL
  10. Maintenance loads: PASS/FAIL
  11. Submit form: PASS/FAIL

  When finished, type: tenant-onboarding-verified
  </resume-signal>
</task>

<task type="auto">
  <name>Task 7: Fix any issues from manual verification and run typecheck</name>
  <files>
    apps/frontend/src/app/(tenant)/tenant/
    apps/backend/src/modules/tenant-portal/
  </files>
  <action>
  Fix any failures reported in the manual verification checkpoint.

  Then run:
  ```bash
  cd /Users/richard/Developer/tenant-flow
  pnpm typecheck 2>&1 | tail -20
  ```

  Fix TypeScript errors introduced by this plan's changes.
  </action>
  <verify>
  ```bash
  pnpm typecheck 2>&1 | grep -c "error TS" || echo "0"
  ```
  Zero new TypeScript errors.
  </verify>
  <done>Manual verification fixes applied. Typecheck passes.</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] Invitation endpoint audited and email gap documented
- [ ] Accept invite page → activation → /tenant redirect verified
- [ ] JWT refresh after activation confirmed working
- [ ] Pay rent page handles no-payment-methods state
- [ ] Manual verification: tenant portal loads (item 1), payments page loads (item 4), /payments/new loads (item 6)
- [ ] pnpm typecheck passes
</verification>

<success_criteria>
- Tenant can accept an invitation and activate their account (invitation → /accept-invite → /tenant/onboarding → /tenant)
- Tenant portal loads without errors
- Pay Rent page loads and shows amount due (or $0 gracefully)
- Pay Rent page shows payment methods or empty state with "Add Payment Method" CTA
- POST /pay-rent works when tenant has a saved payment method
</success_criteria>

<output>
After completion, create `.planning/phases/36-tenant-onboarding/36-01-SUMMARY.md`:

---
phase: 36-tenant-onboarding
plan: 01
subsystem: tenant-portal
provides: tenant-onboarding-verified
affects: [37-financial-wiring]
key-files:
  - apps/frontend/src/app/(auth)/accept-invite/page.tsx
  - apps/frontend/src/app/(tenant)/tenant/onboarding/page.tsx
  - apps/frontend/src/app/(tenant)/tenant/payments/new/page.tsx
  - apps/backend/src/modules/tenants/tenant-invitation-token.service.ts
  - apps/backend/src/modules/tenant-portal/payments/payments.controller.ts
key-decisions:
  - Tenant activation requires JWT refresh to get updated app_metadata.user_type
  - Pay rent uses payment_method_id (not Stripe Checkout redirect) — tenant must have saved PM first
---

# Phase 36 Plan 01 Summary: Tenant Onboarding Flow

**[Headline: Tenant invitation → activation → portal → payments flow verified]**

## Accomplishments

[fill in]

## Files Created/Modified

[fill in]

## Key Findings

[fill in]

## Next Step

Phase 36 complete. Ready for Phase 37: Financial Page Wiring.
Update STATE.md: Phase 37, Plan 01, Ready to plan.
</output>
