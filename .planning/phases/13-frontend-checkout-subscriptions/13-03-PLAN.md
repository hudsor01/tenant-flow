---
phase: 13-frontend-checkout-subscriptions
plan: 03
type: execute
domain: stripe-frontend
---

<objective>
Add Express Checkout Element for Apple Pay/Google Pay and checkout result pages.

Purpose: Improve checkout UX with one-click wallet payments and proper success/failure handling.
Output: ExpressCheckoutElement integration, success and failure result pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-frontend-checkout-subscriptions/RESEARCH.md
@.planning/phases/13-frontend-checkout-subscriptions/13-CONTEXT.md

**Prior summaries:**
@.planning/phases/13-frontend-checkout-subscriptions/13-01-SUMMARY.md
@.planning/phases/13-frontend-checkout-subscriptions/13-02-SUMMARY.md

**Key source files:**
@apps/frontend/src/app/(tenant)/tenant/payments/methods/payment-method-setup-form.tsx
@apps/frontend/src/lib/stripe/stripe-client.ts

**Stripe Elements available:**
- ExpressCheckoutElement from @stripe/react-stripe-js
- Already using PaymentElement, Elements provider

**Constraining decisions:**
- ExpressCheckoutElement shows Apple Pay on Safari, Google Pay on Chrome
- Falls back gracefully if wallets not available
- Use existing Elements provider patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ExpressCheckoutElement to payment setup form</name>
  <files>
    apps/frontend/src/app/(tenant)/tenant/payments/methods/payment-method-setup-form.tsx
  </files>
  <action>
    Add ExpressCheckoutElement above the existing PaymentElement for one-click wallet payments.

    **Changes to PaymentMethodSetupForm:**
    1. Import ExpressCheckoutElement from @stripe/react-stripe-js
    2. Add ExpressCheckoutElement before PaymentElement with:
       - Layout: 'tab' style for horizontal buttons
       - paymentMethods: ['applePay', 'googlePay', 'link']
       - onConfirm handler that creates payment method and calls onSuccess
       - onCancel handler to reset state
       - onClick handler for pre-flight checks
    3. Add divider with "Or pay with card" text between Express and PaymentElement
    4. Handle case where no wallets available (element doesn't render)

    **ExpressCheckoutElement behavior:**
    - Appears as Apple Pay / Google Pay buttons when available
    - User clicks → native wallet sheet opens
    - On success → payment method created → onSuccess callback
    - Falls back gracefully if wallets not configured

    Note: ExpressCheckoutElement requires same Elements provider options.
    Ensure mode: 'setup' is set for payment method collection.
  </action>
  <verify>
    pnpm typecheck passes
    Component renders without errors
    ExpressCheckoutElement appears (if browser supports wallets)
  </verify>
  <done>
    ExpressCheckoutElement integrated above PaymentElement
    Divider separates wallet and card options
    One-click flow works when wallets available
  </done>
</task>

<task type="auto">
  <name>Task 2: Create checkout result pages (success/failure)</name>
  <files>
    apps/frontend/src/app/(owner)/billing/checkout/success/page.tsx,
    apps/frontend/src/app/(owner)/billing/checkout/cancel/page.tsx
  </files>
  <action>
    Create result pages for Stripe Checkout redirects.

    **Success page (/billing/checkout/success):**
    - Extract session_id from URL query params
    - Display success message with checkmark icon
    - Show: "Your subscription is now active"
    - "Go to Dashboard" button linking to /dashboard
    - Confetti animation (optional, use simple CSS)

    **Cancel page (/billing/checkout/cancel):**
    - Display cancelled message with X icon
    - Show: "Checkout was cancelled"
    - "Try Again" button linking back to /billing/plans
    - "Contact Support" link (if support email configured)

    Both pages should be simple Server Components.
    Use consistent styling with other pages.
    Include proper meta tags for SEO (noindex for these pages).
  </action>
  <verify>
    Pages accessible at correct URLs
    Query params handled properly
    Buttons navigate correctly
  </verify>
  <done>
    Success page shows confirmation with session_id
    Cancel page shows retry option
    Both pages styled consistently
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Express Checkout and result pages</what-built>
  <how-to-verify>
    1. Run: pnpm --filter @repo/frontend dev
    2. Visit: http://localhost:3050/tenant/settings/payment-methods
    3. Verify: Apple Pay/Google Pay buttons appear (if supported by browser)
    4. Note: Safari for Apple Pay, Chrome for Google Pay
    5. Visit: http://localhost:3050/billing/checkout/success?session_id=test
    6. Verify: Success page displays with confirmation message
    7. Visit: http://localhost:3050/billing/checkout/cancel
    8. Verify: Cancel page displays with retry button
    9. Test: Navigation buttons work correctly
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm typecheck passes
- [ ] pnpm lint passes
- [ ] ExpressCheckoutElement renders (browser-dependent)
- [ ] Success page shows at /billing/checkout/success
- [ ] Cancel page shows at /billing/checkout/cancel
- [ ] No console errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Express Checkout integrated for wallet payments
- Result pages handle checkout redirects
- Phase 13 complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-frontend-checkout-subscriptions/13-03-SUMMARY.md`

**Phase 13 Complete:** All frontend checkout and subscription management UI implemented.
</output>
