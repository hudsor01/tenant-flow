---
phase: 13-frontend-checkout-subscriptions
plan: 02
type: execute
domain: stripe-frontend
---

<objective>
Build payment method management UI for tenants to view, add, remove, and set default payment methods.

Purpose: Allow tenants to manage their saved payment methods for rent payments.
Output: Payment methods list page with add/remove/default actions, integrated with existing backend endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-frontend-checkout-subscriptions/RESEARCH.md
@.planning/phases/13-frontend-checkout-subscriptions/13-CONTEXT.md

**Prior summaries:**
@.planning/phases/13-frontend-checkout-subscriptions/13-01-SUMMARY.md

**Key source files:**
@apps/frontend/src/app/(tenant)/tenant/payments/methods/payment-method-setup-form.tsx
@apps/frontend/src/lib/stripe/stripe-client.ts

**Existing components:**
- PaymentMethodSetupForm already exists with full PaymentElement integration
- Uses accordion layout with card + bank account options
- Handles Link authentication and address collection

**Backend endpoints (already exist):**
- GET /api/v1/stripe/payment-methods
- POST /api/v1/stripe/attach-tenant-payment-method
- DELETE /api/v1/stripe/payment-methods/:id
- POST /api/v1/stripe/payment-methods/:id/set-default

**Constraining decisions:**
- Reuse existing PaymentMethodSetupForm for adding new methods
- Use existing backend endpoints, no new API work needed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create payment methods list component</name>
  <files>
    apps/frontend/src/components/billing/payment-methods-list.tsx,
    apps/frontend/src/hooks/api/use-payment-methods.ts
  </files>
  <action>
    Create a component to display saved payment methods with actions.

    **Hook (use-payment-methods.ts):**
    - usePaymentMethods(): Fetch list from GET /api/v1/stripe/payment-methods
    - useDeletePaymentMethod(): Mutation for DELETE endpoint
    - useSetDefaultPaymentMethod(): Mutation for set-default endpoint
    - Follow queryOptions pattern from existing hooks

    **PaymentMethodsList component:**
    - Display each payment method as a card with:
      - Card brand icon (Visa, Mastercard, Amex, etc.) or Bank icon
      - Last 4 digits
      - Expiry date (for cards)
      - "Default" badge if default
    - Actions dropdown (MoreVertical icon):
      - "Set as Default" (if not default)
      - "Remove" (with confirmation dialog)
    - Empty state with "Add Payment Method" CTA
    - Loading skeleton during fetch

    Use shadcn/ui Card, DropdownMenu, Badge components.
    Follow SubscriptionsTab patterns for table layout.
  </action>
  <verify>
    pnpm typecheck passes
    Hook functions are typed correctly
    Component renders with mock data
  </verify>
  <done>
    Payment methods list displays saved methods
    Actions dropdown shows correct options
    Empty state displays when no methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Create payment methods page with add flow</name>
  <files>
    apps/frontend/src/app/(tenant)/tenant/settings/payment-methods/page.tsx
  </files>
  <action>
    Create a page combining the list and add-new functionality.

    **Page structure:**
    - Header: "Payment Methods"
    - Section 1: PaymentMethodsList (from Task 1)
    - Section 2: "Add Payment Method" expandable section
      - Uses existing PaymentMethodSetupForm
      - Collapses after successful add
      - Invalidates payment methods query on success

    **Flow:**
    1. User sees existing payment methods
    2. Clicks "Add Payment Method" button
    3. PaymentMethodSetupForm expands below
    4. On success: form collapses, list refreshes, toast shown
    5. On error: error message in form

    Wire up mutations for remove and set-default:
    - Remove: Confirmation dialog, then DELETE call
    - Set Default: Direct POST call with loading state

    Invalidate queries after mutations using queryClient.
  </action>
  <verify>
    Page accessible at /tenant/settings/payment-methods
    Add form integrates with list
    Mutations trigger list refresh
  </verify>
  <done>
    Full payment methods management page functional
    Add, remove, set-default all working
    Proper loading and error states
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Payment method management UI for tenants</what-built>
  <how-to-verify>
    1. Run: pnpm --filter @repo/frontend dev
    2. Visit: http://localhost:3050/tenant/settings/payment-methods
    3. Verify: Existing payment methods display (or empty state)
    4. Click: "Add Payment Method" button
    5. Verify: PaymentMethodSetupForm appears with card/bank options
    6. Test: Actions dropdown on existing method
    7. Verify: "Set as Default" and "Remove" options appear
    8. Test: Remove shows confirmation dialog
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm typecheck passes
- [ ] pnpm lint passes
- [ ] Payment methods list renders correctly
- [ ] Add form works with existing PaymentMethodSetupForm
- [ ] Remove and set-default mutations work
- [ ] Query invalidation refreshes list
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Payment methods page accessible at /tenant/settings/payment-methods
- Full CRUD operations functional
</success_criteria>

<output>
After completion, create `.planning/phases/13-frontend-checkout-subscriptions/13-02-SUMMARY.md`
</output>
