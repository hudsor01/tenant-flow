---
phase: 37-financial-wiring
plan: 01
type: execute
---

<objective>
Verify financial pages show real data and fix the tax-documents placeholder page. The main financials, expenses, and payouts pages use real hooks — verify they work end-to-end. Tax-documents is a confirmed placeholder with mock data that needs backend wiring.

Purpose: Phase 33-02 manual walkthrough documents the actual state of each financial page. This plan uses those findings + the known placeholder to make all financial pages show real or at least graceful-empty states (not mock data).
Output: All financial sub-pages (/financials, /expenses, /payouts, /tax-documents) load without errors and show real data or clean empty states.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md
@apps/frontend/src/app/(owner)/financials/tax-documents/page.tsx
@apps/frontend/src/hooks/api/use-financials.ts
@apps/backend/src/modules/financial/financial-overview.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Review ISSUES.md findings for financial pages</name>
  <files>.planning/ISSUES.md</files>
  <action>
  Read `.planning/ISSUES.md` (created in Phase 33-02) to find all financial page issues.

  Filter for financial-related issues:
  - Any `/financials` pages marked as FAIL or PARTIAL in the manual walkthrough
  - Issues tagged with Phase 37

  Also read the Phase 33-02 SMOKE-TEST-RESULTS.md manual verification section:
  ```bash
  grep -A 5 "financials\|expenses\|payouts\|tax-documents" \
    .planning/phases/33-smoke-test/SMOKE-TEST-RESULTS.md | head -40
  ```

  Create a task-specific list of what to fix:
  - Page-by-page status (PASS / FAIL / PARTIAL)
  - Specific error messages seen
  - Empty vs. crash states

  If ISSUES.md doesn't exist yet (Phase 33-02 not complete): proceed with what is known from the pre-smoke gap analysis (tax-documents is placeholder; other pages use real hooks).
  </action>
  <verify>
  ```bash
  ls .planning/ISSUES.md && echo "exists" || echo "not yet created"
  ```
  Financial page issues from Phase 33 identified.
  </verify>
  <done>Financial page issues inventoried from ISSUES.md / pre-smoke analysis.</done>
</task>

<task type="auto">
  <name>Task 2: Audit financial overview and monthly metrics backend endpoints</name>
  <files>
    apps/backend/src/modules/financial/financial-overview.controller.ts
    apps/frontend/src/hooks/api/use-financials.ts
  </files>
  <action>
  Read `financial-overview.controller.ts` — specifically the `getOverview()` and `getMonthlyMetrics()` handlers.

  Check what Supabase query backs these:
  ```bash
  grep -n "getOverview\|getMonthlyMetrics\|rpc\|from.*properties\|from.*leases" \
    apps/backend/src/modules/financial/financial-overview.controller.ts | head -30
  ```

  Common failure mode: The RPC or query returns empty/null when the owner has no active leases, causing the frontend to crash or show NaN values.

  Check the frontend handling of empty data:
  ```bash
  grep -n "overview?.overview\|?.total_revenue\|??\s*0\|isLoading\|error" \
    apps/frontend/src/app/\(owner\)/financials/page.tsx | head -20
  ```

  The code already uses `?? 0` fallbacks (`const totalRevenue = overview?.overview?.total_revenue ?? 0`). Confirm the error state is also handled:
  ```bash
  grep -n "error\|isError\|ErrorBoundary\|something.*wrong" \
    apps/frontend/src/app/\(owner\)/financials/page.tsx | head -10
  ```

  If `error` state has no UI: add a simple error state with a retry button.
  </action>
  <verify>
  ```bash
  grep -n "if.*error\|error.*return\|refetch" \
    apps/frontend/src/app/\(owner\)/financials/page.tsx | head -10
  ```
  Financials page handles error state (not just loading and success).
  </verify>
  <done>Financial overview and monthly metrics backend audited. Error states verified in frontend.</done>
</task>

<task type="auto">
  <name>Task 3: Audit expenses page backend endpoint</name>
  <files>
    apps/frontend/src/app/(owner)/financials/expenses/page.tsx
    apps/backend/src/modules/financial/financial-overview.controller.ts
  </files>
  <action>
  Read expenses page to understand what it queries and how it handles empty data.

  Check the `getExpenses()` endpoint:
  ```bash
  grep -n "getExpenses\|/expenses\|from.*expenses" \
    apps/backend/src/modules/financial/financial-overview.controller.ts | head -20
  ```

  Check for expenses table existence:
  ```bash
  grep -rn "\"expenses\"\|create table.*expenses" \
    supabase/migrations/ | head -10
  ```

  If expenses table doesn't exist: this is a P1 issue. The expenses page will return empty but the API should return `[]` not crash.

  Check expenses backend endpoint for null/error safety:
  - Does it return `[]` when no expenses exist?
  - Does it filter by `owner_user_id` correctly?

  If the expenses endpoint is missing or crashes: it needs to be fixed.
  </action>
  <verify>
  ```bash
  grep -rn "expenses\|create_expense\|property_expense" \
    supabase/migrations/20251101000000_base_schema.sql | head -10
  ```
  Expenses table exists in schema. Backend endpoint returns [] when no expenses exist.
  </verify>
  <done>Expenses page backend audited.</done>
</task>

<task type="auto">
  <name>Task 4: Audit payouts page — Connect account requirement</name>
  <files>apps/frontend/src/app/(owner)/financials/payouts/page.tsx</files>
  <action>
  Read the payouts page. It uses:
  - `useConnectedAccountBalance()`
  - `useConnectedAccountPayouts()`
  - `useConnectedAccountTransfers()`

  These all require a Stripe Connect account to exist. Check how the page handles the "no Connect account" state:
  ```bash
  grep -n "no.*account\|isLoading\|error\|null\|Connect.*account\|setup" \
    apps/frontend/src/app/\(owner\)/financials/payouts/page.tsx | head -20
  ```

  If the page crashes when no Connect account exists (because the API returns 404), add an empty state:
  ```tsx
  if (!balance && !balanceLoading) {
    return (
      <div className="flex flex-col items-center justify-center py-16 text-center">
        <h3 className="text-lg font-semibold mb-2">
          Connect your Stripe account to view payouts
        </h3>
        <p className="text-sm text-muted-foreground mb-4">
          Set up Stripe Connect to receive rent payments from tenants.
        </p>
        <Button asChild>
          <Link href="/settings?tab=billing">Connect Stripe Account</Link>
        </Button>
      </div>
    )
  }
  ```

  Check if the backend `getConnectedAccountBalance()` returns a specific error code when no account exists vs a crash:
  ```bash
  grep -n "balance\|no.*account\|not.*found\|getBalance" \
    apps/backend/src/modules/billing/connect/connect.controller.ts | head -15
  ```
  </action>
  <verify>
  ```bash
  grep -n "no.*account\|Connect Stripe\|setup.*billing\|settings.*billing" \
    apps/frontend/src/app/\(owner\)/financials/payouts/page.tsx | head -10
  ```
  Payouts page shows useful empty state when no Connect account configured.
  </verify>
  <done>Payouts page handles "no Connect account" state with actionable empty state.</done>
</task>

<task type="auto">
  <name>Task 5: Replace tax-documents placeholder with real data or clean empty state</name>
  <files>
    apps/frontend/src/app/(owner)/financials/tax-documents/page.tsx
    apps/backend/src/modules/financial/
  </files>
  <action>
  The tax-documents page is a confirmed placeholder with hardcoded mock data.

  First check if there's a backend endpoint for tax documents:
  ```bash
  grep -rn "tax.*document\|1099\|form.*tax\|/tax-documents" \
    apps/backend/src/ | head -10
  ```

  **If NO backend endpoint exists** (most likely): Replace the placeholder with a clean empty state that explains when tax documents will appear:

  ```tsx
  // Replace sampleDocuments with empty state
  export default function TaxDocumentsPage() {
    return (
      <div className="p-6 lg:p-8">
        <div className="mb-6">
          <h1 className="text-2xl font-bold">Tax Documents</h1>
          <p className="text-muted-foreground mt-1">
            Year-end tax forms and financial summaries
          </p>
        </div>

        <div className="flex flex-col items-center justify-center py-16 text-center border rounded-lg">
          <FileText className="h-12 w-12 text-muted-foreground mb-4" />
          <h3 className="text-lg font-semibold mb-2">No tax documents yet</h3>
          <p className="text-sm text-muted-foreground max-w-sm">
            Tax documents such as 1099 forms will be generated here at year end.
            Ensure your Stripe Connect account is set up to receive tax forms.
          </p>
        </div>
      </div>
    )
  }
  ```

  **If a backend endpoint exists**: Wire it up using the `useFinancialOverview` pattern.

  The goal is: page loads without error, shows real data or a clean (non-fake) empty state. No hardcoded mock data.
  </action>
  <verify>
  ```bash
  grep -n "sampleDocuments\|hardcoded\|mock\|'1'\|'2'\|'3'" \
    apps/frontend/src/app/\(owner\)/financials/tax-documents/page.tsx | head -5
  ```
  Zero lines with hardcoded mock data in tax-documents page.
  </verify>
  <done>Tax-documents page replaced with clean empty state (or wired to backend if endpoint exists). No more mock data.</done>
</task>

<task type="auto">
  <name>Task 6: Fix any additional issues from Phase 33-02 ISSUES.md</name>
  <files>
    apps/frontend/src/app/(owner)/financials/
    apps/backend/src/modules/financial/
  </files>
  <action>
  Read `.planning/ISSUES.md` for all financial-related P0/P1 issues tagged Phase 37.

  For each issue:
  1. Identify the specific page and failure mode
  2. Apply the minimal fix

  Prioritize:
  - P0: Page crashes (throws error, blank white screen)
  - P1: Page shows fake/mock data
  - P2: Page shows empty state but doesn't explain why

  Do NOT implement new features or backend endpoints not already outlined. Stick to fixes.

  If no ISSUES.md exists yet: verify the following pages load without crashes by checking for error boundaries and null safety:
  ```bash
  grep -rn "?..*??\s*0\|?..*??\s*\[\]\|?..*??\s*''\|isError" \
    apps/frontend/src/app/\(owner\)/financials/ | head -30
  ```
  </action>
  <verify>
  All P0/P1 financial issues from ISSUES.md addressed (or ISSUES.md not created yet — covered by Tasks 2-5).
  </verify>
  <done>Additional financial page issues from ISSUES.md addressed.</done>
</task>

<task type="auto">
  <name>Task 7: Verify financial backend RPC functions filter inactive properties</name>
  <files>apps/backend/src/modules/financial/financial-overview.controller.ts</files>
  <action>
  Known common bug: RPC functions must filter `status != 'inactive'` properties.

  Check the financial overview RPCs:
  ```bash
  grep -rn "get_dashboard_stats\|get_financial_overview\|neq.*inactive\|status.*inactive" \
    apps/backend/src/modules/financial/ | head -20
  ```

  Also check in Supabase migrations:
  ```bash
  grep -rn "get_financial_overview\|get_owner_financial" \
    supabase/migrations/ | head -10
  ```

  If any RPC includes inactive (soft-deleted) properties in revenue/expense calculations, add the filter. This is a data correctness issue that could make financial pages show phantom revenue.

  If the RPCs are correct: document and move on.
  </action>
  <verify>
  ```bash
  grep -rn "neq.*inactive\|status.*inactive\|active.*status" \
    supabase/migrations/ | grep -i "financial\|revenue\|expense" | head -5
  ```
  Financial RPCs correctly exclude inactive properties from calculations.
  </verify>
  <done>Financial RPCs verified to exclude inactive (soft-deleted) properties.</done>
</task>

<task type="auto">
  <name>Task 8: Run typecheck and lint</name>
  <files>N/A</files>
  <action>
  ```bash
  cd /Users/richard/Developer/tenant-flow
  pnpm typecheck 2>&1 | tail -20
  pnpm lint 2>&1 | tail -20
  ```

  Fix any TypeScript or lint errors introduced by this plan's changes.
  </action>
  <verify>
  ```bash
  pnpm typecheck 2>&1 | grep -c "error TS" || echo "0"
  ```
  Zero new TypeScript errors.
  </verify>
  <done>Typecheck and lint pass with no new errors.</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] Financial overview page (/financials) loads without crash, handles error state
- [ ] Expenses page (/financials/expenses) loads and shows real or empty state
- [ ] Payouts page (/financials/payouts) shows "Connect Stripe Account" CTA when no Connect account
- [ ] Tax-documents page has NO mock/hardcoded data — shows clean empty state or real data
- [ ] Financial RPCs exclude inactive properties
- [ ] All P0/P1 issues from ISSUES.md addressed
- [ ] pnpm typecheck passes
</verification>

<success_criteria>
- All 4 financial sub-pages load without runtime crashes
- Tax-documents page shows clean empty state (not mock/fake data)
- Payouts page shows actionable empty state when Stripe Connect not configured
- Financial overview shows $0 gracefully when no active leases exist (no NaN/undefined)
- All TypeScript checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/37-financial-wiring/37-01-SUMMARY.md`:

---
phase: 37-financial-wiring
plan: 01
subsystem: financials
provides: financial-pages-verified
affects: []
key-files:
  - apps/frontend/src/app/(owner)/financials/tax-documents/page.tsx
  - apps/frontend/src/app/(owner)/financials/payouts/page.tsx
  - apps/frontend/src/app/(owner)/financials/page.tsx
  - apps/backend/src/modules/financial/financial-overview.controller.ts
key-decisions:
  - Tax-documents: replaced placeholder with clean empty state (no mock data)
  - Payouts: added empty state when no Connect account configured
  - Financial RPCs exclude inactive (soft-deleted) properties
---

# Phase 37 Plan 01 Summary: Financial Page Wiring

**[Headline: All financial pages verified — tax-documents placeholder replaced, payouts empty state added]**

## Accomplishments

[fill in]

## Files Created/Modified

[fill in]

## Key Findings

[fill in]

## Next Step

Phase 37 complete. v5.0 Production Hardening milestone complete.
Update STATE.md: v5.0 complete. Ready for /gsd:complete-milestone.
</output>
