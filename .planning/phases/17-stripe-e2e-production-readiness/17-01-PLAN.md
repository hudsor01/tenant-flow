# Plan 17-01: Connect Onboarding E2E Tests

## Objective

Create comprehensive E2E tests for Stripe Connect onboarding flow to verify the complete owner payout setup experience.

## Context

- Existing E2E tests cover payment flows and subscriptions
- Connect onboarding has no E2E coverage
- Backend endpoints: `/connect/onboard`, `/connect/status`, `/connect/account`, `/connect/dashboard-link`, `/connect/balance`, `/connect/payouts`
- Frontend: `billing-settings.tsx`, `stripe-connect-tab.tsx`, `stripe/page.tsx`

## Tasks

### Task 1: Create Connect Onboarding E2E Test File

Create `apps/e2e-tests/tests/owner/connect-onboarding.e2e.spec.ts`:

```typescript
// Test structure:
describe('Stripe Connect Onboarding', () => {
  describe('Onboarding Flow', () => {
    test('displays Connect setup prompt for new owners')
    test('initiates onboarding and redirects to Stripe')
    test('handles onboarding return with success status')
    test('handles onboarding return with refresh needed')
  })

  describe('Connected Account Status', () => {
    test('shows pending status during verification')
    test('shows complete status when fully onboarded')
    test('displays account capabilities')
  })

  describe('Dashboard Access', () => {
    test('generates dashboard login link')
    test('displays balance information')
  })

  describe('Payout Dashboard', () => {
    test('displays payout history')
    test('shows payout details')
    test('displays transfer history')
  })

  describe('Error Handling', () => {
    test('handles onboarding API errors')
    test('handles expired onboarding links')
    test('handles Stripe service unavailable')
  })
})
```

**Key Implementation Notes**:
- Use Playwright's `page.route()` to mock Stripe API responses (actual Stripe onboarding requires manual verification)
- Test frontend UI states and navigation
- Verify API calls are made with correct parameters
- Test loading, success, and error states

### Task 2: Implement Mock Fixtures for Connect Tests

Create test fixtures that mock:
- Connected account responses (pending, complete)
- Balance responses
- Payout list responses
- Transfer list responses

### Task 3: Run and Verify Tests

- Run: `pnpm test:e2e -- --grep "Connect"`
- Verify all tests pass
- Verify no regressions in other E2E tests

## Verification

- [ ] connect-onboarding.e2e.spec.ts exists
- [ ] All Connect E2E tests pass
- [ ] Full E2E suite passes: `pnpm test:e2e`

## Notes

- Cannot test actual Stripe Express onboarding flow (requires manual identity verification)
- Tests mock Stripe responses to verify frontend behavior
- Focus on UI states, navigation, and error handling
