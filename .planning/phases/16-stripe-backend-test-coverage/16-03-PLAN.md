---
phase: 16-stripe-backend-test-coverage
plan: 03
type: execute
domain: testing
---

<objective>
Add unit tests for remaining payment services.

Purpose: Complete test coverage for all Stripe Connect services.
Output: Test files for connect-setup.service and connect.service (facade).
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-stripe-backend-test-coverage/16-CONTEXT.md

**Key source files to test:**
@apps/backend/src/modules/billing/connect/connect-setup.service.ts
@apps/backend/src/modules/billing/connect/connect.service.ts

**Reference existing tests:**
@apps/backend/src/modules/billing/connect/connect-billing.service.spec.ts
@apps/backend/src/modules/billing/connect/connect-payouts.service.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connect-setup.service tests</name>
  <files>
    apps/backend/src/modules/billing/connect/connect-setup.service.spec.ts
  </files>
  <action>
    Create unit tests for ConnectSetupService covering:

    1. **getStripe tests:**
       - Returns Stripe instance

    2. **createConnectedAccount tests:**
       - Returns existing account if user already has one
       - Creates new Express account with correct params
       - Uses idempotency key for creation
       - Saves account to database
       - Cleans up Stripe account on database failure
       - Handles invalid country codes (falls back to default)
       - Propagates Stripe errors

    3. **createAccountLink tests:**
       - Creates account link with correct URLs
       - Validates FRONTEND_URL format
       - Propagates Stripe errors

    4. **getConnectedAccount tests:**
       - Returns account from Stripe
       - Propagates Stripe errors

    5. **updateOnboardingStatus tests:**
       - Updates database with onboarding status
       - Sets onboarding_completed_at when both charges_enabled and payouts_enabled
       - Handles database errors

    **Mock setup:**
    - Mock StripeClientService.getClient()
    - Mock SupabaseService.getAdminClient()
    - Mock AppConfigService (getFrontendUrl, getStripeConnectDefaultCountry)
    - Mock StripeSharedService.generateIdempotencyKey()
    - Mock AppLogger with SilentLogger
  </action>
  <verify>
    Test file created
    All methods covered
    Error handling tested
    pnpm test:unit:backend passes
  </verify>
  <done>
    connect-setup.service.spec.ts created with comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 2: Add connect.service facade tests</name>
  <files>
    apps/backend/src/modules/billing/connect/connect.service.spec.ts
  </files>
  <action>
    Create unit tests for ConnectService (facade) covering delegation:

    1. **Setup delegation tests:**
       - getStripe → ConnectSetupService
       - createConnectedAccount → ConnectSetupService
       - createAccountLink → ConnectSetupService
       - getConnectedAccount → ConnectSetupService
       - updateOnboardingStatus → ConnectSetupService

    2. **Billing delegation tests:**
       - createCustomerOnConnectedAccount → ConnectBillingService
       - createSubscriptionOnConnectedAccount → ConnectBillingService
       - deleteCustomer → ConnectBillingService
       - cancelSubscription → ConnectBillingService

    3. **Payouts delegation tests:**
       - getConnectedAccountBalance → ConnectPayoutsService
       - listConnectedAccountPayouts → ConnectPayoutsService
       - getPayoutDetails → ConnectPayoutsService
       - listTransfersToAccount → ConnectPayoutsService
       - createDashboardLoginLink → ConnectPayoutsService

    **Mock setup:**
    - Mock all three underlying services
    - Verify delegation with correct parameters
  </action>
  <verify>
    Test file created
    All delegation methods covered
    pnpm test:unit:backend passes
  </verify>
  <done>
    connect.service.spec.ts created with delegation tests
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] connect-setup.service.spec.ts exists and passes
- [ ] connect.service.spec.ts exists and passes
- [ ] pnpm typecheck passes
- [ ] pnpm test:unit:backend passes
</verification>

<success_criteria>
- 2 new test files created
- All tests pass
- Connect account creation tested
- Onboarding flow tested
- Facade delegation tested
</success_criteria>

<output>
After completion, create `.planning/phases/16-stripe-backend-test-coverage/16-03-SUMMARY.md`
</output>
