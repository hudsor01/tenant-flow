---
phase: 16-stripe-backend-test-coverage
plan: 01
type: execute
domain: testing
---

<objective>
Add unit tests for high-priority payment services.

Purpose: Cover the most business-critical payment services that currently lack tests.
Output: Test files for stripe-shared.service, stripe-owner.service, stripe.service, and stripe-sync.service.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-stripe-backend-test-coverage/16-CONTEXT.md

**Key source files to test:**
@apps/backend/src/modules/billing/stripe-shared.service.ts
@apps/backend/src/modules/billing/stripe-owner.service.ts
@apps/backend/src/modules/billing/stripe.service.ts
@apps/backend/src/modules/billing/stripe-sync.service.ts

**Reference existing tests:**
@apps/backend/src/modules/billing/stripe-tenant.service.spec.ts
@apps/backend/src/modules/billing/stripe-customer.service.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stripe-shared.service tests</name>
  <files>
    apps/backend/src/modules/billing/stripe-shared.service.spec.ts
  </files>
  <action>
    Create unit tests for StripeSharedService covering:

    1. **generateIdempotencyKey tests:**
       - Returns deterministic key for same inputs
       - Different inputs produce different keys
       - Handles various argument counts
       - Key format is valid (alphanumeric)

    2. **handleStripeError tests:**
       - StripeCardError → BadRequestException
       - StripeInvalidRequestError → BadRequestException
       - StripeAPIError → InternalServerErrorException
       - StripeAuthenticationError → InternalServerErrorException
       - StripeRateLimitError → HttpException with 429
       - StripeConnectionError → InternalServerErrorException
       - StripePermissionError → InternalServerErrorException
       - StripeIdempotencyError → BadRequestException
       - Unknown error type → InternalServerErrorException

    **Mock setup:**
    - Mock AppLogger with SilentLogger
    - Create mock Stripe error objects with correct `type` property
  </action>
  <verify>
    Test file created
    All error types covered
    Idempotency key tests pass
    pnpm test:unit:backend passes
  </verify>
  <done>
    stripe-shared.service.spec.ts created with comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 2: Add stripe-owner.service tests</name>
  <files>
    apps/backend/src/modules/billing/stripe-owner.service.spec.ts
  </files>
  <action>
    Create unit tests for StripeOwnerService covering:

    1. **getOrCreateOwnerStripeCustomer tests:**
       - Returns existing customer from cache
       - Creates new customer when none exists
       - Caches newly created customer
       - Updates database with new customer ID
       - Handles customer creation errors

    2. **createRentPaymentIntent tests:**
       - Creates payment intent with destination charges
       - Calculates application fee correctly
       - Includes proper metadata
       - Uses idempotency key
       - Handles missing connected account

    3. **Error handling tests:**
       - Handles Stripe API errors
       - Cleans up orphaned customers on DB failure

    **Mock setup:**
    - Mock StripeClientService.getClient()
    - Mock SupabaseService.getAdminClient()
    - Mock StripeSharedService.generateIdempotencyKey()
    - Mock AppLogger with SilentLogger
  </action>
  <verify>
    Test file created
    Cache behavior tested
    Payment intent creation tested
    Error scenarios covered
    pnpm test:unit:backend passes
  </verify>
  <done>
    stripe-owner.service.spec.ts created with comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 3: Add stripe.service tests</name>
  <files>
    apps/backend/src/modules/billing/stripe.service.spec.ts
  </files>
  <action>
    Create unit tests for StripeService covering:

    1. **listSubscriptions tests:**
       - Returns paginated subscriptions
       - Filters by customer ID
       - Handles empty results
       - Handles pagination with has_more

    2. **retrieveSubscription tests:**
       - Returns subscription by ID
       - Handles not found errors

    3. **listInvoices tests:**
       - Returns invoices for customer
       - Uses Redis cache when available
       - Caches results after fetch
       - Handles cache miss

    4. **getInvoice tests:**
       - Returns invoice by ID
       - Handles not found errors

    **Mock setup:**
    - Mock StripeClientService.getClient()
    - Mock RedisCacheService (get/set/del)
    - Mock AppLogger with SilentLogger
  </action>
  <verify>
    Test file created
    Pagination tested
    Caching tested
    Error scenarios covered
    pnpm test:unit:backend passes
  </verify>
  <done>
    stripe.service.spec.ts created with comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 4: Add stripe-sync.service tests</name>
  <files>
    apps/backend/src/modules/billing/stripe-sync.service.spec.ts
  </files>
  <action>
    Create unit tests for StripeSyncService covering:

    1. **Initialization tests:**
       - Initializes lazily on first use
       - Throws error on missing config
       - Logs successful initialization

    2. **processWebhook tests:**
       - Delegates to StripeSync.processWebhook
       - Passes payload and signature correctly

    3. **syncSingleEntity tests:**
       - Delegates to StripeSync.syncSingleEntity
       - Logs entity ID being synced

    4. **syncBackfill tests:**
       - Delegates to StripeSync.syncBackfill
       - Passes options correctly
       - Logs duration on completion

    5. **getHealthStatus tests:**
       - Returns healthy when config valid
       - Returns unhealthy when config missing
       - Returns initialized status correctly

    6. **onModuleDestroy tests:**
       - Closes connection pool on shutdown
       - Handles close errors gracefully

    **Mock setup:**
    - Mock AppConfigService (getDirectUrl, getDatabaseUrl, getStripeSecretKey, getStripeWebhookSecret)
    - Mock StripeSync class from @supabase/stripe-sync-engine
    - Mock AppLogger with SilentLogger
  </action>
  <verify>
    Test file created
    Lazy initialization tested
    Health checks tested
    Cleanup tested
    pnpm test:unit:backend passes
  </verify>
  <done>
    stripe-sync.service.spec.ts created with comprehensive coverage
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Unit tests for 4 critical Stripe services</what-built>
  <how-to-verify>
    1. Run: pnpm --filter @repo/backend test:unit
    2. Verify: All new tests pass
    3. Check: Test coverage for each service
    4. Review: Error handling scenarios covered
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] stripe-shared.service.spec.ts exists and passes
- [ ] stripe-owner.service.spec.ts exists and passes
- [ ] stripe.service.spec.ts exists and passes
- [ ] stripe-sync.service.spec.ts exists and passes
- [ ] pnpm typecheck passes
- [ ] pnpm test:unit:backend passes
</verification>

<success_criteria>
- 4 new test files created
- All tests pass
- Error handling comprehensively tested
- Idempotency key generation tested
</success_criteria>

<output>
After completion, create `.planning/phases/16-stripe-backend-test-coverage/16-01-SUMMARY.md`
</output>
