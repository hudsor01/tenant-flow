---
phase: 16-stripe-backend-test-coverage
plan: 02
type: execute
domain: testing
---

<objective>
Add unit tests for medium-priority payment services.

Purpose: Cover remaining payment services that handle billing queries, payment methods, and Connect operations.
Output: Test files for billing.service, payment-method.service, connect-billing.service, and connect-payouts.service.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-stripe-backend-test-coverage/16-CONTEXT.md

**Key source files to test:**
@apps/backend/src/modules/billing/billing.service.ts
@apps/backend/src/modules/billing/subscriptions/payment-method.service.ts
@apps/backend/src/modules/billing/connect/connect-billing.service.ts
@apps/backend/src/modules/billing/connect/connect-payouts.service.ts

**Reference existing tests:**
@apps/backend/src/modules/billing/stripe-shared.service.spec.ts
@apps/backend/src/modules/billing/stripe.service.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add billing.service tests</name>
  <files>
    apps/backend/src/modules/billing/billing.service.spec.ts
  </files>
  <action>
    Create unit tests for BillingService covering:

    1. **getStripeCustomer tests:**
       - Returns customer from stripe schema
       - Returns null when not found (PGRST116)
       - Throws on other errors

    2. **findCustomerByOwnerId tests:**
       - Returns customer when owner has stripe_customer_id
       - Returns null when owner not found
       - Returns null when owner has no stripe_customer_id

    3. **findCustomerByTenantId tests:**
       - Returns customer when tenant has stripe_customer_id
       - Returns null when tenant not found

    4. **linkCustomerToOwner/linkCustomerToTenant tests:**
       - Updates user/tenant record with stripe_customer_id
       - Throws on database error

    5. **findSubscriptionByStripeId tests:**
       - Returns subscription from stripe schema
       - Returns null when not found

    6. **findSubscriptionsByCustomerId tests:**
       - Returns array of subscriptions
       - Returns empty array when none found

    7. **findSubscriptionByUserId tests (RLS-enforced):**
       - Returns subscription with RLS-enforced query
       - Returns null when not found (PGRST116)
       - Throws on other errors (fail-closed)

    **Mock setup:**
    - Mock SupabaseService (getAdminClient, getUserClient)
    - Mock stripe schema queries via asStripeSchemaClient
    - Mock AppLogger with SilentLogger
  </action>
  <verify>
    Test file created
    All query methods covered
    Error handling tested
    pnpm test:unit:backend passes
  </verify>
  <done>
    billing.service.spec.ts created with comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 2: Add payment-method.service tests</name>
  <files>
    apps/backend/src/modules/billing/subscriptions/payment-method.service.spec.ts
  </files>
  <action>
    Create unit tests for PaymentMethodService covering:

    1. **createPaymentIntent tests:**
       - Creates payment intent with params
       - Uses idempotency key when provided
       - Propagates Stripe errors

    2. **createCheckoutSession tests:**
       - Creates checkout session with params
       - Uses idempotency key when provided
       - Propagates Stripe errors

    3. **getCharge tests:**
       - Returns charge by ID
       - Returns null on error

    4. **listPaymentMethods tests:**
       - Lists payment methods for customer
       - Filters by type when provided
       - Propagates Stripe errors

    5. **detachPaymentMethod tests:**
       - Detaches payment method
       - Propagates Stripe errors

    **Mock setup:**
    - Mock StripeClientService.getClient()
    - Mock Stripe SDK methods (paymentIntents.create, checkout.sessions.create, etc.)
    - Mock AppLogger with SilentLogger
  </action>
  <verify>
    Test file created
    All methods covered
    Idempotency key handling tested
    pnpm test:unit:backend passes
  </verify>
  <done>
    payment-method.service.spec.ts created with comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 3: Add connect-billing.service tests</name>
  <files>
    apps/backend/src/modules/billing/connect/connect-billing.service.spec.ts
  </files>
  <action>
    Create unit tests for ConnectBillingService covering:

    1. **createCustomerOnConnectedAccount tests:**
       - Creates customer with stripeAccount header
       - Includes metadata with platform tag
       - Propagates Stripe errors

    2. **createSubscriptionOnConnectedAccount tests:**
       - Creates price first, then subscription
       - Uses idempotency keys for both operations
       - Sets payment_behavior to default_incomplete
       - Propagates Stripe errors

    3. **deleteCustomer tests:**
       - Deletes customer with idempotency key
       - Uses stripeAccount header
       - Propagates Stripe errors

    4. **cancelSubscription tests:**
       - Cancels subscription with idempotency key
       - Uses stripeAccount header
       - Propagates Stripe errors

    **Mock setup:**
    - Mock StripeClientService.getClient()
    - Mock StripeSharedService.generateIdempotencyKey()
    - Mock Stripe SDK methods with stripeAccount
    - Mock AppLogger with SilentLogger
  </action>
  <verify>
    Test file created
    Connected account operations tested
    Idempotency keys tested
    pnpm test:unit:backend passes
  </verify>
  <done>
    connect-billing.service.spec.ts created with comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 4: Add connect-payouts.service tests</name>
  <files>
    apps/backend/src/modules/billing/connect/connect-payouts.service.spec.ts
  </files>
  <action>
    Create unit tests for ConnectPayoutsService covering:

    1. **getConnectedAccountBalance tests:**
       - Retrieves balance with stripeAccount header
       - Returns balance object

    2. **listConnectedAccountPayouts tests:**
       - Lists payouts with stripeAccount header
       - Uses default limit of 10
       - Supports pagination with starting_after

    3. **getPayoutDetails tests:**
       - Retrieves payout by ID with stripeAccount header

    4. **listTransfersToAccount tests:**
       - Lists transfers with destination filter
       - Supports pagination options

    5. **createDashboardLoginLink tests:**
       - Creates login link for connected account
       - Returns URL string
       - Propagates Stripe errors

    **Mock setup:**
    - Mock StripeClientService.getClient()
    - Mock Stripe SDK methods (balance.retrieve, payouts.list, etc.)
    - Mock AppLogger with SilentLogger
  </action>
  <verify>
    Test file created
    All payout operations tested
    Pagination tested
    pnpm test:unit:backend passes
  </verify>
  <done>
    connect-payouts.service.spec.ts created with comprehensive coverage
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] billing.service.spec.ts exists and passes
- [ ] payment-method.service.spec.ts exists and passes
- [ ] connect-billing.service.spec.ts exists and passes
- [ ] connect-payouts.service.spec.ts exists and passes
- [ ] pnpm typecheck passes
- [ ] pnpm test:unit:backend passes
</verification>

<success_criteria>
- 4 new test files created
- All tests pass
- Stripe schema queries tested
- Connected account operations tested
- Idempotency handling tested
</success_criteria>

<output>
After completion, create `.planning/phases/16-stripe-backend-test-coverage/16-02-SUMMARY.md`
</output>
