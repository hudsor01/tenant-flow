# Plan: 25-01 Migrate from Doppler to Native dotenv

## Objective

Remove Doppler CLI dependency entirely and integrate dotenv globally so environment variables load automatically without any CLI wrapper. Use existing Zod validation for type safety.

## Context

**Current state:**
- 30+ scripts use `doppler run --` wrapper
- No `.env` files exist - Doppler is the only source
- Backend already has `dotenv: 17.2.3` installed
- NestJS ConfigModule already uses Zod validation in `config.schema.ts`
- ConfigModule.forRoot already has `envFilePath: ['.env.local', '.env']` (just added)

**Target state:**
- Zero `doppler run --` references anywhere
- dotenv loads automatically at app startup (preload pattern)
- `.env.example` documents all required variables
- `.env.local` for local development (gitignored)
- Platform secrets for CI/CD (GitHub Actions, Railway, Vercel)

## Official dotenv Integration Pattern

From official docs (https://github.com/motdotla/dotenv):

```javascript
// ES6: Import at very top of entry file
import 'dotenv/config'

// Or preload via CLI (but we're avoiding CLI wrappers)
// node -r dotenv/config app.js
```

For this project, we'll use the import pattern at the top of entry files.

## Tasks

### Task 1: Backend - Add dotenv preload to entry point
**File:** `apps/backend/src/main.ts`

Add `import 'dotenv/config'` as the VERY FIRST import, before Sentry instrument:

```typescript
// Load environment variables FIRST - before any other imports
import 'dotenv/config'

// Sentry instrumentation MUST be imported second
import './instrument'
// ... rest of imports
```

**Verification:** `node -e "require('dotenv/config'); console.log(process.env.NODE_ENV)"`

### Task 2: Backend - Remove doppler from package.json scripts
**File:** `apps/backend/package.json`

Remove `doppler run --` from ALL scripts:
- `dev`: `nest start --watch` → `nest start --watch`
- `start`: `node dist/main.js` → `node dist/main.js`
- `start:dev`: `node dist/main.js` → `node dist/main.js`
- `start:prod`: `NODE_ENV=production node dist/main.js` → `NODE_ENV=production node dist/main.js`
- `stripe:migrate`: `tsx scripts/...` → `tsx scripts/...`
- `stripe:backfill-customers`: `tsx scripts/...` → `tsx scripts/...`
- `validate:supabase`: `tsx scripts/...` → `tsx scripts/...`
- `test:integration`: `jest ...` → `jest ...`

### Task 3: Frontend - Add dotenv loading to Next.js
**File:** `apps/frontend/next.config.ts` or create `apps/frontend/env.ts`

Next.js automatically loads `.env*` files. Verify configuration:
- `.env` - base config (committed, no secrets)
- `.env.local` - local overrides (gitignored)
- `.env.production` - production defaults

No code changes needed - Next.js handles this natively.

### Task 4: Frontend - Remove doppler from package.json scripts
**File:** `apps/frontend/package.json`

Remove `doppler run --` from ALL scripts:
- `dev`: Remove doppler wrapper
- `build:local`: Remove doppler wrapper
- `analyze`: Remove doppler wrapper
- `start:local`: Remove doppler wrapper

### Task 5: Root - Remove doppler from package.json scripts
**File:** `package.json` (root)

Remove `doppler run --` from ALL scripts:
- `dev`: `turbo run dev` → `turbo run dev`
- `build`: `NODE_ENV=production turbo run build` → `NODE_ENV=production turbo run build`
- `build:backend`: `turbo run build --filter=@repo/backend` → `turbo run build --filter=@repo/backend`
- `build:frontend`: `NODE_ENV=production turbo run build --filter=@repo/frontend` → `NODE_ENV=production turbo run build --filter=@repo/frontend`
- `build:ci`: `turbo run build` → `turbo run build`
- `db:push`: `supabase db push` → `supabase db push`
- `db:pull`: `supabase db pull` → `supabase db pull`
- `db:reset`: `supabase db reset` → `supabase db reset`

### Task 6: E2E Tests - Update Playwright config
**File:** `apps/e2e-tests/playwright.config.ts`

Update webServer command to remove doppler:
- Current: `bash -c "..."`
- New: `bash -c "..."` (dotenv will load automatically)

### Task 7: Create .env.example template
**File:** `apps/backend/.env.example`

Create template with ALL required variables from `config.schema.ts`:

```bash
# Application
NODE_ENV=development
PORT=4650

# Frontend
FRONTEND_URL=http://localhost:3050
NEXT_PUBLIC_APP_URL=http://localhost:3050

# Supabase
SUPABASE_URL=http://127.0.0.1:54321
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SUPABASE_PUBLISHABLE_KEY=your-publishable-key
PROJECT_REF=local

# Database
DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres

# Stripe
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Security
JWT_SECRET=your-32-character-minimum-jwt-secret
IDEMPOTENCY_KEY_SECRET=your-32-character-minimum-secret

# Email (optional for local)
SUPPORT_EMAIL=support@localhost

# Redis (optional for local)
# REDIS_URL=redis://localhost:6379
```

### Task 8: Create frontend .env.example
**File:** `apps/frontend/.env.example`

```bash
# API
NEXT_PUBLIC_API_BASE_URL=http://localhost:4650

# Supabase
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your-publishable-key

# Stripe
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
```

### Task 9: Update .gitignore
**File:** `.gitignore` (root)

Ensure these patterns exist:
```
# Environment files
.env
.env.local
.env.*.local
!.env.example

# Doppler (remove if present)
# .doppler/
```

### Task 10: Remove Doppler VSCode settings
**Files:** `.vscode/settings.json`, `.vscode/launch.json`, `.vscode/tasks.json`

Remove Doppler-specific configuration:
- Remove `doppler.autocomplete.enable`
- Remove `doppler.hover.enable`
- Update launch.json `runtimeExecutable` from `doppler` to `node`
- Update tasks.json commands to remove `doppler run --`

### Task 11: Verify backend starts
**Command:**
```bash
cd apps/backend
cp .env.example .env.local
pnpm dev
```

**Expected:** Server starts on port 4650, Zod validation passes

### Task 12: Verify frontend starts
**Command:**
```bash
cd apps/frontend
cp .env.example .env.local
# Fill in real values
pnpm dev
```

**Expected:** Next.js starts on port 3050

### Task 13: Export secrets (One-time user action)
**Documentation only - user performs manually:**

```bash
# Option 1: Export from Doppler (if still installed)
doppler secrets download --no-file --format env > apps/backend/.env.local
doppler secrets download --no-file --format env > apps/frontend/.env.local

# Option 2: Copy from .env.example and fill in real values
cp apps/backend/.env.example apps/backend/.env.local
cp apps/frontend/.env.example apps/frontend/.env.local
# Then edit .env.local files with actual secrets
```

## Success Criteria

- [x] Zero `doppler run --` in any package.json
- [x] Zero `doppler` references in VSCode config (gitignored, user-specific)
- [x] Backend starts with `pnpm dev` (no doppler)
- [x] Frontend starts with `pnpm dev` (no doppler)
- [x] `.env.example` files document all required variables
- [x] `.env.local` is gitignored
- [x] Zod validation passes on startup
- [x] Tests run without doppler wrapper

## Notes

- Railway, Vercel, and GitHub Actions set env vars natively - no changes needed
- turbo.json `globalEnv` already lists required variables for caching
- Supabase CLI may need env vars set before running `db:push` etc.
