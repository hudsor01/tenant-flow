---
phase: 23-documentation-best-practices
plan: 01
type: execute
---

<objective>
Create a unified best practices guide consolidating v3.0 architectural patterns for maintainability.

Purpose: Codify the patterns established across v3.0 phases (18-22) into actionable developer documentation that lives in the tracked codebase.
Output: BEST_PRACTICES.md in project root with consolidated guidance from ADRs 0004-0008.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# v3.0 ADRs to consolidate:
@.planning/adr/0004-supabase-client-patterns.md
@.planning/adr/0005-rpc-usage-patterns.md
@.planning/adr/0006-api-response-standards.md
@.planning/adr/0007-module-architecture.md
@.planning/adr/0008-cold-start-optimization.md

# Existing documentation context:
@CLAUDE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md

**Tech stack available:**
- Supabase three-tier client strategy (admin/user pool/RPC service)
- RPC-first patterns with complexity guidelines
- API response standards with Zod validation
- Module architecture thresholds (<5k good, 5-8k watch, >8k action)
- Cold start baseline (0.87s for 53 modules)

**Constraining decisions:**
- Phase 18: ADRs stored in .planning/adr/ (docs/ is gitignored)
- Phase 19: RPC threshold is >3 JOINs or >5 round trips
- Phase 20: Zod validation at API boundary
- Phase 21: forwardRef indicates circular deps
- Phase 22: No lazy loading (all candidates have controllers)

**Pattern:** v3.0 produced research and ADRs; Phase 23 consolidates into developer-actionable documentation.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BEST_PRACTICES.md with Supabase patterns</name>
  <files>BEST_PRACTICES.md</files>
  <action>
Create BEST_PRACTICES.md in project root with structured sections:

1. **Overview** - Purpose and scope (v3.0 patterns for TenantFlow)

2. **Supabase Client Usage** (from ADR-0004):
   - Three-tier strategy table: Admin vs User Pool vs RPC
   - When to use which client (webhook → admin, user request → user pool)
   - Code snippets showing correct patterns
   - Link to key files (supabase.module.ts, supabase-user-client-pool.ts)

3. **RPC Guidelines** (from ADR-0005):
   - When to create RPC: >3 JOINs, >5 round trips, complex transactions
   - When NOT: simple CRUD, already efficient
   - Error handling with `RAISE EXCEPTION`
   - Security: always check auth.uid() in SECURITY DEFINER functions
   - Naming convention: `fn_{domain}_{verb}_{object}`

Keep sections concise with cross-references to full ADRs for deep dives.
  </action>
  <verify>cat BEST_PRACTICES.md | wc -l shows reasonable size (100-200 lines)</verify>
  <done>BEST_PRACTICES.md exists with Supabase client patterns and RPC guidelines</done>
</task>

<task type="auto">
  <name>Task 2: Add API and architecture patterns to BEST_PRACTICES.md</name>
  <files>BEST_PRACTICES.md</files>
  <action>
Append to BEST_PRACTICES.md:

4. **API Response Standards** (from ADR-0006):
   - Success responses: `{ data, meta? }` structure
   - Error responses: `{ error: { code, message, details? } }`
   - Pagination: cursor-based with `{ data, meta: { nextCursor, hasMore } }`
   - Validation: Zod at API boundary, DTO wraps shared schema
   - Common patterns table (list, single, create, update, delete)

5. **Module Architecture** (from ADR-0007):
   - Size thresholds: <5k lines good, 5-8k warning, >8k action needed
   - Current oversized modules: billing (14k), tenants (12k), leases (10k)
   - Circular dependency signals: forwardRef usage
   - Recommendation: extract shared services to eliminate forwardRef
   - Link to IMPROVEMENTS.md for prioritized refactoring list

6. **Performance Baselines** (from ADR-0008):
   - Startup time: 0.87s for 53 modules (excellent)
   - Lazy loading: not recommended (all candidates have controllers)
   - Future optimization: Supabase connection pooling when traffic demands

Format as actionable checklists where appropriate.
  </action>
  <verify>grep -c "##" BEST_PRACTICES.md shows ~6 top-level sections</verify>
  <done>BEST_PRACTICES.md contains all 6 sections covering v3.0 patterns</done>
</task>

<task type="auto">
  <name>Task 3: Update CLAUDE.md to reference BEST_PRACTICES.md</name>
  <files>CLAUDE.md</files>
  <action>
Add a new section to CLAUDE.md (after "Key Directories" section):

## Best Practices Reference

For detailed architectural patterns established in v3.0, see `BEST_PRACTICES.md`:
- Supabase client usage (three-tier strategy)
- RPC guidelines (when to use, naming conventions)
- API response standards
- Module size thresholds
- Performance baselines

ADRs for deep dives: `.planning/adr/`

Keep the addition brief (5-10 lines) - CLAUDE.md is already comprehensive, this just adds the cross-reference.
  </action>
  <verify>grep "BEST_PRACTICES" CLAUDE.md returns the new reference</verify>
  <done>CLAUDE.md references BEST_PRACTICES.md and .planning/adr/</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cat BEST_PRACTICES.md | head -50` shows well-structured content
- [ ] `grep -c "ADR-" BEST_PRACTICES.md` shows cross-references to ADRs
- [ ] `grep "BEST_PRACTICES" CLAUDE.md` shows reference added
- [ ] All 6 sections present (Supabase, RPC, API, Architecture, Performance, References)
</verification>

<success_criteria>

- BEST_PRACTICES.md created with v3.0 patterns consolidated
- All 5 v3.0 ADRs (0004-0008) referenced/summarized
- CLAUDE.md updated with cross-reference
- Documentation is actionable (code examples, checklists, decision tables)
- No code changes (documentation only phase)
</success_criteria>

<output>
After completion, create `.planning/phases/23-documentation-best-practices/23-01-SUMMARY.md`:

# Phase 23 Plan 01: Best Practices Guide Summary

**[Substantive one-liner - what shipped]**

## Accomplishments
- Created BEST_PRACTICES.md with consolidated v3.0 patterns
- Cross-referenced from CLAUDE.md

## Files Created/Modified
- `BEST_PRACTICES.md` - New file with v3.0 patterns
- `CLAUDE.md` - Added cross-reference section

## Decisions Made
None (documentation consolidation)

## Issues Encountered
[Any problems and resolutions]

## Next Phase Readiness
Phase 23 complete - v3.0 Backend Architecture Excellence milestone finished
</output>
