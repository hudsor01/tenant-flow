---
phase: 32-frontend-test-restoration
plan: 01
type: implementation
subsystem: frontend-testing
depends-on: [31-synthetic-monitoring]
provides: [tenant-hook-tests, lease-hook-tests]
affects: [apps/frontend/src/hooks/api/__tests__/]
tags: [testing, frontend, hooks, vitest]
estimated-tasks: 3
estimated-scope: small
checkpoints: []
---

# Phase 32-01: Core Domain Hook Tests (Tenant & Lease)

## Objective

Add unit test coverage for the highest-value API hooks: tenant and lease management. These are core domain hooks with complex query patterns and mutations.

Purpose: Restore test coverage for critical business logic hooks following established patterns.
Output: Test files for use-tenant.ts and use-lease.ts with query and mutation coverage.

## Execution Context

@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Existing Test Pattern (from use-properties.test.tsx):**
- Use `vi.fn()` for mockFetch, not MSW
- Create `createWrapper()` with fresh QueryClient per test
- Mock `#lib/api-config`, `@repo/shared/lib/frontend-logger`
- Mock `#utils/supabase/client` with hoisted mocks
- Test query configuration, mutation calls, error handling
- Use `waitFor` for async hook results

**Hooks to Test (highest value):**
- `use-tenant.ts` (17KB) - CRUD, invitations, bulk operations
- `use-lease.ts` (16KB) - CRUD, renewals, deposits, documents

**QueryClient Config for Tests:**
```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: { retry: false },
    mutations: { retry: false }
  }
})
```

## Tasks

<task type="auto">
  <name>Task 1: Create use-tenant.ts Tests</name>
  <files>apps/frontend/src/hooks/api/__tests__/use-tenant.test.tsx</files>
  <action>
Create test file following use-properties.test.tsx pattern:

1. Setup mocks (fetch, api-config, logger, supabase client)
2. Create wrapper with fresh QueryClient
3. Test query hooks:
   - useTenantList: fetches with pagination params
   - useTenant: fetches by ID, disabled when empty
   - useTenantsByProperty: fetches filtered by property
   - useTenantStats: fetches stats endpoint
4. Test mutation hooks:
   - useCreateTenantMutation: POST to correct endpoint
   - useUpdateTenantMutation: PUT with ID
   - useDeleteTenantMutation: DELETE with ID
   - useInviteTenantMutation: POST invitation
5. Test error handling for failed API calls

Follow exact mock patterns from use-properties.test.tsx.
Do NOT use MSW - use vi.stubGlobal('fetch', mockFetch) pattern.
  </action>
  <verify>pnpm --filter @repo/frontend test:unit -- --testPathPattern="use-tenant.test" passes</verify>
  <done>use-tenant.test.tsx exists with 15+ tests covering queries and mutations</done>
</task>

<task type="auto">
  <name>Task 2: Create use-lease.ts Tests</name>
  <files>apps/frontend/src/hooks/api/__tests__/use-lease.test.tsx</files>
  <action>
Create test file following same pattern:

1. Setup mocks (identical to Task 1)
2. Test query hooks:
   - useLeaseList: fetches with filters (status, property, tenant)
   - useLease: fetches by ID, disabled when empty
   - useLeasesByProperty: fetches filtered
   - useLeaseStats: fetches stats
   - useUpcomingRenewals: fetches renewals endpoint
3. Test mutation hooks:
   - useCreateLeaseMutation: POST with lease data
   - useUpdateLeaseMutation: PUT with ID
   - useTerminateLeaseMutation: termination endpoint
   - useRenewLeaseMutation: renewal endpoint
4. Test edge cases:
   - Empty ID returns disabled query
   - Error responses handled

Match existing test patterns exactly.
  </action>
  <verify>pnpm --filter @repo/frontend test:unit -- --testPathPattern="use-lease.test" passes</verify>
  <done>use-lease.test.tsx exists with 15+ tests covering queries and mutations</done>
</task>

<task type="auto">
  <name>Task 3: Create Test Utilities Module</name>
  <files>apps/frontend/src/test/api-test-utils.ts</files>
  <action>
Extract common test utilities from existing tests to reduce duplication:

1. createTestWrapper() - Creates QueryClient wrapper for hook tests
2. createMockFetchResponse() - Creates mock fetch response with text()/json()
3. setupApiMocks() - Common vi.mock setup for api-config, logger
4. mockSupabaseClient - Reusable Supabase client mock

Export all utilities for use in hook tests.
Keep it simple - just extract what's repeated, don't over-engineer.

Update existing test files to import from this module (optional, can be done in follow-up).
  </action>
  <verify>pnpm --filter @repo/frontend test:unit passes (all existing tests still work)</verify>
  <done>api-test-utils.ts exports createTestWrapper, createMockFetchResponse utilities</done>
</task>

</tasks>

## Verification

Before declaring phase complete:
- [ ] `pnpm --filter @repo/frontend test:unit` passes all tests
- [ ] use-tenant.test.tsx has 15+ tests
- [ ] use-lease.test.tsx has 15+ tests
- [ ] api-test-utils.ts exports reusable utilities
- [ ] No TypeScript errors

## Success Criteria

- All tasks completed
- 30+ new tests added for tenant and lease hooks
- Test utilities module created for future hook tests
- All verification checks pass
- No errors introduced

## Output

Files created:
- `apps/frontend/src/hooks/api/__tests__/use-tenant.test.tsx` (NEW)
- `apps/frontend/src/hooks/api/__tests__/use-lease.test.tsx` (NEW)
- `apps/frontend/src/test/api-test-utils.ts` (NEW)

After completion, create `.planning/phases/32-frontend-test-restoration/32-01-SUMMARY.md`
