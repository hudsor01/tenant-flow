---
phase: 35-subscription-enforcement
plan: 01
type: execute
---

<objective>
Audit what `SubscriptionGuard` currently enforces and implement proper plan-based limits so Free tier users cannot exceed property/tenant count limits and cannot access Pro-only features.

Purpose: The guard exists globally but only checks `basic_properties` feature access (active subscription check). There are no granular plan limits. `get_user_plan_limits` returns hardcoded values. This plan audits the gap, implements property/tenant count limits in the backend, and adds frontend upgrade prompts.
Output: Free users hit a 403 when creating properties/tenants beyond their plan limit; Pro users are not blocked. Upgrade prompts appear in the UI.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/backend/src/shared/guards/subscription.guard.ts
@apps/backend/src/modules/properties/properties.controller.ts
@apps/frontend/src/app/(owner)/properties/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit SubscriptionGuard and plan limit RPC functions</name>
  <files>
    apps/backend/src/shared/guards/subscription.guard.ts
    supabase/migrations/
  </files>
  <action>
  Read `subscription.guard.ts` in full to understand what it currently enforces.

  Then check the plan limit RPC functions in migrations:
  ```bash
  grep -rn "get_user_plan_limits\|check_user_feature_access\|user_feature_access" \
    supabase/migrations/ | head -20
  ```

  Read the `get_user_plan_limits` function body (it was confirmed to return hardcoded values).
  Read the `check_user_feature_access` function body.

  Document:
  1. What does `SubscriptionGuard` actually check? (Currently: `check_user_feature_access('basic_properties')`)
  2. What does `get_user_plan_limits` return? (Currently: hardcoded 100 properties, 1000 units, etc.)
  3. What does `check_user_feature_access` actually do? (Does it query subscriptions table?)
  4. Does the `user_feature_access` table have data? (Check with Neon MCP or migration files)

  ```bash
  grep -rn "user_feature_access\|feature_access" supabase/migrations/ | head -20
  grep -rn "basic_properties\|FREETRIAL\|STARTER\|GROWTH" supabase/migrations/ | head -20
  ```
  </action>
  <verify>
  ```bash
  grep -n "check_user_feature_access\|get_user_plan_limits" \
    apps/backend/src/shared/guards/subscription.guard.ts | head -10
  ```
  Audit complete. Gap documented: what works vs what needs implementing.
  </verify>
  <done>Subscription enforcement gap documented: current state vs desired state for plan limits.</done>
</task>

<task type="auto">
  <name>Task 2: Define plan limits per tier</name>
  <files>
    packages/shared/src/types/stripe.ts
    supabase/migrations/
  </files>
  <action>
  Define the limits for each plan tier. Based on the codebase plans: `FREETRIAL | STARTER | GROWTH | TENANTFLOW_MAX`.

  Use these limits (conservative for a SaaS freemium model):
  - **FREETRIAL**: 3 properties, 10 tenants, 1GB storage
  - **STARTER**: 10 properties, 50 tenants, 10GB storage
  - **GROWTH**: 50 properties, 200 tenants, 50GB storage
  - **TENANTFLOW_MAX**: unlimited (9999) properties, tenants, 100GB storage

  Create a migration to update `get_user_plan_limits` to return plan-specific limits based on the user's active subscription. The function signature already accepts `p_user_id`.

  First check what subscription data is available:
  ```bash
  grep -rn "stripe_price_id\|plan_type\|PlanType\|metadata.*plan" \
    supabase/migrations/20251101000000_base_schema.sql | head -20
  ```

  Write migration file at `supabase/migrations/{timestamp}_fix_plan_limits.sql`:

  ```sql
  -- Update get_user_plan_limits to return plan-specific limits
  create or replace function "public"."get_user_plan_limits"("p_user_id" text)
  returns table(
    "property_limit" integer,
    "tenant_limit" integer,
    "unit_limit" integer,
    "storage_gb" integer,
    "has_api_access" boolean,
    "has_white_label" boolean,
    "support_level" text
  )
  language plpgsql security definer
  set search_path to 'public'
  as $$
  declare
    v_plan_type text;
  begin
    -- Get the user's current plan from their subscription
    select coalesce(s.plan_type, 'FREETRIAL')
    into v_plan_type
    from subscriptions s
    where s.user_id = p_user_id::uuid
      and s.status in ('active', 'trialing')
    order by s.created_at desc
    limit 1;

    return query
    select
      case v_plan_type
        when 'FREETRIAL'     then 3
        when 'STARTER'       then 10
        when 'GROWTH'        then 50
        when 'TENANTFLOW_MAX' then 9999
        else 3
      end::integer as property_limit,
      case v_plan_type
        when 'FREETRIAL'     then 10
        when 'STARTER'       then 50
        when 'GROWTH'        then 200
        when 'TENANTFLOW_MAX' then 9999
        else 10
      end::integer as tenant_limit,
      case v_plan_type
        when 'FREETRIAL'     then 30
        when 'STARTER'       then 150
        when 'GROWTH'        then 600
        when 'TENANTFLOW_MAX' then 9999
        else 30
      end::integer as unit_limit,
      case v_plan_type
        when 'FREETRIAL'     then 1
        when 'STARTER'       then 10
        when 'GROWTH'        then 50
        when 'TENANTFLOW_MAX' then 100
        else 1
      end::integer as storage_gb,
      (v_plan_type in ('GROWTH', 'TENANTFLOW_MAX'))::boolean as has_api_access,
      (v_plan_type = 'TENANTFLOW_MAX')::boolean as has_white_label,
      case v_plan_type
        when 'FREETRIAL'     then 'community'
        when 'STARTER'       then 'email'
        when 'GROWTH'        then 'priority'
        when 'TENANTFLOW_MAX' then 'dedicated'
        else 'community'
      end::text as support_level;
  end;
  $$;
  ```

  Note: Check if `subscriptions` table has a `plan_type` column. If not, derive plan from `stripe_price_id` mapping or add `plan_type` column.
  </action>
  <verify>
  ```bash
  ls supabase/migrations/ | grep "plan_limits" | head -5
  ```
  Migration file exists with updated get_user_plan_limits function.
  </verify>
  <done>get_user_plan_limits migration created with plan-specific limits.</done>
</task>

<task type="auto">
  <name>Task 3: Add property count enforcement in properties controller</name>
  <files>
    apps/backend/src/modules/properties/properties.controller.ts
    apps/backend/src/modules/properties/properties.service.ts
  </files>
  <action>
  Read `properties.controller.ts` and `properties.service.ts` to understand the CREATE property flow.

  Add a plan limit check to `createProperty()` (or the relevant create handler). Before inserting, check the user's current property count against their plan limit.

  Pattern to add in `properties.service.ts` create method:
  ```typescript
  // Check plan limit before creating
  const { data: limits } = await this.supabase
    .getClient()
    .rpc('get_user_plan_limits', { p_user_id: userId })

  const propertyLimit = limits?.[0]?.property_limit ?? 3

  const { count } = await this.supabase
    .getUserClient(token)
    .from('properties')
    .select('*', { count: 'exact', head: true })
    .eq('owner_user_id', userId)
    .neq('status', 'inactive')

  if (count !== null && count >= propertyLimit) {
    throw new ForbiddenException({
      code: 'PLAN_LIMIT_EXCEEDED',
      message: `Your plan allows up to ${propertyLimit} properties. Upgrade to add more.`,
      limit: propertyLimit,
      current: count,
    })
  }
  ```

  Similarly check `tenants.service.ts` for the invite/create tenant flow:
  ```bash
  grep -n "createTenant\|inviteTenant\|inviteToPlatform" \
    apps/backend/src/modules/tenants/*.ts | head -10
  ```

  Add the same tenant count check against `tenant_limit` from `get_user_plan_limits`.

  Note: Use the admin Supabase client (not user client) for `get_user_plan_limits` since it's a SECURITY DEFINER function.
  </action>
  <verify>
  ```bash
  grep -n "PLAN_LIMIT_EXCEEDED\|plan_limit\|propertyLimit\|tenantLimit" \
    apps/backend/src/modules/properties/properties.service.ts \
    apps/backend/src/modules/tenants/tenant-platform-invitation.service.ts 2>/dev/null | head -10
  ```
  Plan limit checks exist in property and tenant creation flows.
  </verify>
  <done>Backend plan limit checks added to property and tenant creation. Returns ForbiddenException with PLAN_LIMIT_EXCEEDED code when limit reached.</done>
</task>

<task type="auto">
  <name>Task 4: Add upgrade prompt to frontend when plan limit hit</name>
  <files>
    apps/frontend/src/hooks/api/use-properties.ts
    apps/frontend/src/components/properties/add-property-button.tsx (or similar CTA)
    apps/frontend/src/app/(owner)/properties/page.tsx
  </files>
  <action>
  Find where the "Add Property" CTA is rendered:
  ```bash
  grep -rn "Add.*Property\|CreateProperty\|addProperty\|/properties/new" \
    apps/frontend/src/app/\(owner\)/properties/ | head -10
  ```

  Find how mutations handle errors from the backend:
  ```bash
  grep -rn "PLAN_LIMIT_EXCEEDED\|onError.*mutation\|useCreateProperty" \
    apps/frontend/src/hooks/api/ | head -10
  ```

  Add error handling in the property creation mutation (`useCreateProperty` or similar) to detect `PLAN_LIMIT_EXCEEDED` errors and show an upgrade toast/modal:

  ```typescript
  onError: (error) => {
    const err = error as { code?: string; limit?: number }
    if (err?.code === 'PLAN_LIMIT_EXCEEDED') {
      toast.error(`Property limit reached. Upgrade your plan to add more properties.`, {
        action: {
          label: 'Upgrade',
          onClick: () => router.push('/billing/plans')
        }
      })
      return
    }
    toast.error('Failed to create property. Please try again.')
  }
  ```

  Do the same for tenant invitation mutation errors (PLAN_LIMIT_EXCEEDED â†’ "Upgrade to invite more tenants").

  Also check if there's a way to proactively show the limit in the UI (e.g., "2/3 properties" counter on the properties page). If there's already a stats display, add the limit:
  ```bash
  grep -rn "propertyCount\|total.*properties\|properties.*count" \
    apps/frontend/src/app/\(owner\)/properties/page.tsx | head -10
  ```
  </action>
  <verify>
  ```bash
  grep -rn "PLAN_LIMIT_EXCEEDED\|Upgrade.*plan\|billing/plans" \
    apps/frontend/src/hooks/api/ | head -10
  ```
  Frontend handles PLAN_LIMIT_EXCEEDED errors with upgrade CTAs.
  </verify>
  <done>Frontend shows upgrade prompts when plan limits are hit for properties and tenants.</done>
</task>

<task type="auto">
  <name>Task 5: Push migration and run typecheck</name>
  <files>N/A</files>
  <action>
  Push the migration to the local Supabase instance:
  ```bash
  cd /Users/richard/Developer/tenant-flow
  pnpm db:push 2>&1 | tail -20
  ```

  Regenerate types:
  ```bash
  pnpm db:types 2>&1 | tail -10
  ```

  Run typecheck:
  ```bash
  pnpm typecheck 2>&1 | tail -20
  ```

  Fix any TypeScript errors from the type regeneration or new code.

  Run backend unit tests for properties and tenants:
  ```bash
  cd apps/backend && npx jest "properties.service\|tenants" --forceExit 2>&1 | tail -30
  ```
  </action>
  <verify>
  ```bash
  pnpm typecheck 2>&1 | grep -c "error TS" || echo "0"
  ```
  Zero TypeScript errors. Migration applied. Types regenerated.
  </verify>
  <done>Migration applied, types regenerated, typecheck passes.</done>
</task>

</tasks>

<verification>
Before declaring this plan complete:
- [ ] `get_user_plan_limits` migration created and pushes successfully
- [ ] Property creation returns `PLAN_LIMIT_EXCEEDED` when Free user has 3+ properties
- [ ] Tenant invite returns `PLAN_LIMIT_EXCEEDED` when Free user has 10+ tenants
- [ ] Frontend shows upgrade prompt with link to /billing/plans when limit hit
- [ ] pnpm typecheck passes
- [ ] Existing backend tests still pass
</verification>

<success_criteria>
- Free users are limited to 3 properties and 10 tenants (configurable per plan)
- Pro users (GROWTH+) have higher limits
- Backend returns structured ForbiddenException with `PLAN_LIMIT_EXCEEDED` code and the limit value
- Frontend shows actionable upgrade prompt with link to billing page
- SubscriptionGuard still blocks users without any active subscription (existing behavior preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/35-subscription-enforcement/35-01-SUMMARY.md`:

---
phase: 35-subscription-enforcement
plan: 01
subsystem: billing
provides: plan-limit-enforcement
affects: [37-financial-wiring]
key-files:
  - supabase/migrations/{timestamp}_fix_plan_limits.sql
  - apps/backend/src/modules/properties/properties.service.ts
  - apps/backend/src/modules/tenants/tenant-platform-invitation.service.ts
  - apps/frontend/src/hooks/api/use-properties.ts
key-decisions:
  - Plan limits: FREETRIAL=3 properties/10 tenants, STARTER=10/50, GROWTH=50/200, MAX=unlimited
  - Enforcement at service layer (not guard), returns PLAN_LIMIT_EXCEEDED ForbiddenException
  - Frontend shows upgrade toast with /billing/plans link
---

# Phase 35 Plan 01 Summary: Subscription Enforcement

**[Headline: Plan-based limits enforced for property and tenant creation]**

## Accomplishments

- get_user_plan_limits RPC updated with real plan tiers
- Backend property + tenant creation checks plan limits
- Frontend shows upgrade prompt on limit hit

## Files Created/Modified

[list changes]

## Key Findings

[what was missing, what was already correct]

## Next Step

Phase 35 complete. Ready for Phase 36: Tenant Onboarding Flow.
Update STATE.md: Phase 36, Plan 01, Ready to plan.
</output>
