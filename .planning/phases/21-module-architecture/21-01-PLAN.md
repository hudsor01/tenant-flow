# Phase 21 Plan 01: Module Architecture Audit

<objective>
Audit NestJS module architecture, document service boundaries, identify coupling issues, and create ADR with recommendations.

**Goal:** Research service boundaries, recommend improvements (documentation-only, no refactoring)

**Scope:** Audit module sizes, analyze dependencies, document patterns, recommend decomposition strategies

**Output:**
- ADR-0007: Module Architecture Recommendations
- IMPROVEMENTS.md logging specific refactoring opportunities

**NOT in scope:** Actual refactoring or module splitting (future phases)
</objective>

<execution_context>
**Prior phases:**
- Phase 18: Supabase client patterns (ADR-0004)
- Phase 19: RPC usage patterns (ADR-0005)
- Phase 20: API response standards (ADR-0006)

**Known issues:**
- Billing module flagged as "god module" (14k+ lines, 15 services, 10 controllers)
- 27 modules total in app.module.ts
- 25/28 modules lack README documentation

**Discovery findings:**
- Module sizes (lines): billing (14k), tenants (12k), leases (10k), pdf (8.6k)
- Billing already has subdirectories: connect/, subscriptions/, webhooks/
- Nested modules: owner-dashboard (7 sub-modules), tenant-portal (6 sub-modules)
- Global modules: SharedModule, ServicesModule, SupabaseModule
</execution_context>

<context>
**Key files to analyze:**
- `apps/backend/src/app.module.ts` - Module registration
- `apps/backend/src/modules/billing/stripe.module.ts` - God module
- `apps/backend/src/shared/shared.module.ts` - Global shared services
- `.planning/codebase/CONCERNS.md` - Known architectural issues

**Standards:**
- NestJS module pattern: one domain per module
- Single responsibility: services should have focused concerns
- Dependency injection: modules should declare dependencies explicitly
</context>

<tasks>
## Task 1: Audit Module Sizes and Structure

**Type:** auto
**Scope:** Analyze all 27 modules for size, complexity, and structure

**Actions:**
1. Document each module with: line count, service count, controller count
2. Identify modules exceeding 5k lines (complexity threshold)
3. Map sub-module structure (owner-dashboard, tenant-portal, billing)
4. Note modules with circular or unusual dependencies

**Output:** Module inventory table for ADR

---

## Task 2: Analyze Billing Module (God Module)

**Type:** auto
**Scope:** Deep dive into billing module structure and coupling

**Actions:**
1. Map all services and their responsibilities
2. Identify shared state between services
3. Document controller-to-service relationships
4. Assess existing subdirectory decomposition (connect/, subscriptions/, webhooks/)
5. Identify candidates for extraction to separate modules

**Output:** Billing module analysis section for ADR

---

## Task 3: Assess Cross-Module Dependencies

**Type:** auto
**Scope:** Analyze how modules depend on each other

**Actions:**
1. Check imports across all modules for coupling patterns
2. Identify services used by multiple modules (candidates for SharedModule)
3. Document circular dependency risks
4. Note modules that should be merged or split

**Output:** Dependency analysis section for ADR

---

## Task 4: Create ADR-0007 Module Architecture Recommendations

**Type:** auto
**Scope:** Document findings and recommendations

**Actions:**
1. Create ADR following existing format (see ADR-0004, 0005, 0006)
2. Document current state (module inventory)
3. Document problems (god modules, coupling)
4. Recommend improvements with priority
5. Include migration strategy (gradual decomposition)

**Output:** `.planning/adr/0007-module-architecture.md`

---

## Task 5: Log Improvement Opportunities

**Type:** auto
**Scope:** Create actionable list for future phases

**Actions:**
1. Create IMPROVEMENTS.md in phase directory
2. List specific refactoring opportunities by priority
3. Estimate effort for each improvement
4. Note dependencies between improvements

**Output:** `.planning/phases/21-module-architecture/IMPROVEMENTS.md`
</tasks>

<verification>
**Phase success criteria:**
- [ ] All 27 modules audited with size metrics
- [ ] Billing module analyzed with decomposition recommendations
- [ ] Cross-module dependencies documented
- [ ] ADR-0007 created with recommendations
- [ ] IMPROVEMENTS.md created with prioritized list

**Quality checks:**
- ADR follows format of ADR-0004/0005/0006
- Recommendations are actionable and prioritized
- No code changes (documentation-only phase)
</verification>

<success_criteria>
- Module inventory table complete
- God module(s) identified with decomposition strategy
- ADR-0007 provides clear guidance for future refactoring
- IMPROVEMENTS.md lists 5+ specific opportunities
</success_criteria>

<output>
**Files to create:**
- `.planning/adr/0007-module-architecture.md`
- `.planning/phases/21-module-architecture/IMPROVEMENTS.md`
- `.planning/phases/21-module-architecture/21-01-SUMMARY.md`

**State updates:**
- STATE.md: Phase 21, Plan 01 complete
- ROADMAP.md: Phase 21 status updated
</output>
