---
phase: 31-synthetic-monitoring
plan: 01
type: implementation
subsystem: devops
depends-on: [30-sentry-frontend]
provides: [smoke-test-script, health-check-integration]
affects: [scripts/, .github/workflows/]
tags: [monitoring, health-checks, ci-cd, smoke-tests]
estimated-tasks: 3
estimated-scope: small
checkpoints: []
---

# Phase 31-01: Synthetic Monitoring & Production Smoke Tests

## Objective

Create post-deployment verification scripts and CI/CD integration for health monitoring. Establish alert thresholds and escalation documentation.

Purpose: Ensure deployments are verified automatically and provide runbook for production monitoring.
Output: Smoke test script, CI integration, monitoring documentation.

## Execution Context

@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Existing Health Endpoints:**
- `/health/ping` - Lightweight liveness probe
- `/health/ready` - Readiness probe (DB + Redis)
- `/health` - Full health check
- `/health/stripe-sync` - Stripe sync service status
- `/health/performance` - Performance metrics
- `/health/circuit-breaker` - Circuit breaker status

**Research Findings (from ROADMAP.md):**
- Post-deploy smoke script: Bash script hitting all critical endpoints within 30s of deploy
- Alert thresholds: DB response <100ms warning/<500ms critical, API p95 <200ms
- Escalation: Warning → Slack, Critical → Slack + PagerDuty

## Tasks

<task type="auto">
  <name>Task 1: Create Post-Deploy Smoke Test Script</name>
  <files>scripts/smoke-test.sh</files>
  <action>
Create a bash script that:
1. Takes BACKEND_URL as environment variable (default: http://localhost:4650)
2. Hits each health endpoint with curl and validates response
3. Exits non-zero on any failure (for CI integration)
4. Includes timeout handling (5s per request)
5. Provides colored output for readability
6. Tests in order: ping (fastest) → ready → stripe-sync → full health

Endpoints to test:
- GET /api/v1/health/ping - expect 200
- GET /api/v1/health/ready - expect 200
- GET /api/v1/health/stripe-sync - expect 200 and contains "healthy" or status field
- GET /api/v1/health - expect 200

Make script executable with proper shebang.
  </action>
  <verify>bash scripts/smoke-test.sh (with local backend running) passes all checks</verify>
  <done>Script exists, is executable, validates all health endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Add Smoke Test to Package.json Scripts</name>
  <files>package.json</files>
  <action>
Add script entry to root package.json:
```json
"test:smoke": "bash scripts/smoke-test.sh"
```

This allows running smoke tests via `pnpm test:smoke` which integrates with existing test commands pattern.
  </action>
  <verify>pnpm test:smoke runs the smoke test script</verify>
  <done>Package.json has test:smoke script that runs smoke-test.sh</done>
</task>

<task type="auto">
  <name>Task 3: Create Monitoring Runbook Documentation</name>
  <files>.planning/docs/MONITORING-RUNBOOK.md</files>
  <action>
Create monitoring runbook documenting:

1. **Health Endpoints Reference**
   - All endpoints with expected responses
   - When to use each endpoint

2. **Alert Thresholds** (from research)
   - DB response: <100ms normal, 100-500ms warning, >500ms critical
   - API p95 latency: <200ms normal, >200ms warning
   - Memory: <80% normal, 80-90% warning, >90% critical
   - Error rate: <1% normal, 1-5% warning, >5% critical

3. **Escalation Matrix**
   - Warning → Slack #alerts channel
   - Critical → Slack + PagerDuty on-call
   - Payment critical → Immediate escalation (faster SLA)

4. **Smoke Test Usage**
   - Local: `pnpm test:smoke`
   - CI: After deploy step
   - Manual: `BACKEND_URL=https://api.tenantflow.app pnpm test:smoke`

5. **Troubleshooting Guide**
   - Common failures and remediation steps
  </action>
  <verify>Document exists with all sections populated</verify>
  <done>MONITORING-RUNBOOK.md created with complete reference</done>
</task>

</tasks>

## Verification

Before declaring phase complete:
- [ ] `bash scripts/smoke-test.sh` passes locally
- [ ] `pnpm test:smoke` command works
- [ ] MONITORING-RUNBOOK.md has all required sections
- [ ] Script handles failures gracefully with clear error messages

## Success Criteria

- All tasks completed
- Smoke test script validates all health endpoints
- Package.json integration works
- Documentation provides actionable runbook
- No errors introduced

## Output

Files created:
- `scripts/smoke-test.sh` (NEW)
- `package.json` (MODIFIED - added test:smoke)
- `.planning/docs/MONITORING-RUNBOOK.md` (NEW)

After completion, create `.planning/phases/31-synthetic-monitoring/31-01-SUMMARY.md`
