---
phase: 29-sentry-backend
plan: 01
type: implementation
subsystem: observability
depends-on: [28-real-service-integration]
provides: [sentry-context-middleware, sentry-data-scrubbing, sentry-dlq-integration]
affects: [billing/webhooks, shared/middleware, instrument.ts]
tags: [sentry, observability, monitoring, security, middleware]
estimated-tasks: 4
estimated-scope: small
checkpoints: []
---

# Phase 29-01: Sentry Backend Integration Enhancement

## Objective

Enhance the existing Sentry integration with tenant context propagation, sensitive data scrubbing, and improved transaction naming for production-grade observability.

## Execution Context

**Current State (already working):**
- `instrument.ts` imports before all modules ✅
- `SentryModule.forRoot()` configured ✅
- `SentryGlobalFilter` as APP_FILTER ✅
- Performance tracing with 20% sample rate in prod ✅
- Profiling integration enabled ✅
- Trace propagation for Supabase/Stripe ✅
- DLQ webhook integration with `Sentry.captureException()` ✅

**Enhancements needed:**
1. Add `SentryContextMiddleware` for automatic tenant_id/user_id tagging
2. Enhance `beforeSend` with data scrubbing for sensitive headers
3. Add structured transaction naming for background jobs
4. Configure alert rules documentation

## Context

### Research Findings (from ROADMAP.md Phase 29)

- SentryContextMiddleware pattern: `Sentry.setUser({ id: userId, tenant_id: tenantId })`
- Data scrubbing targets: `authorization`, `x-stripe-signature`, card data patterns
- Transaction naming: Auto-names from routes, manual for background jobs (`webhook.${eventType}.process`)
- Source maps: `sentry-cli releases files upload-sourcemaps dist/apps/backend`

### Existing Patterns

The codebase already uses:
- `ClsService` for request context (REQUEST_CONTEXT with requestId, startTime, path, method)
- `RequestIdMiddleware` pattern for middleware injection
- `@sentry/nestjs` with `SentryGlobalFilter`

## Tasks

### Task 1: Create SentryContextMiddleware

Create a middleware that extracts user/tenant context from JWT and sets Sentry scope.

**File:** `apps/backend/src/shared/middleware/sentry-context.middleware.ts`

**Implementation:**
```typescript
import type { NestMiddleware } from '@nestjs/common'
import { Injectable } from '@nestjs/common'
import type { NextFunction, Request, Response } from 'express'
import * as Sentry from '@sentry/nestjs'
import { ClsService } from 'nestjs-cls'

interface AuthenticatedRequest extends Request {
  user?: {
    sub?: string
    user_id?: string
    email?: string
    user_metadata?: {
      tenant_id?: string
    }
    app_metadata?: {
      role?: string
    }
  }
}

@Injectable()
export class SentryContextMiddleware implements NestMiddleware {
  constructor(private readonly cls: ClsService) {}

  use(req: AuthenticatedRequest, _res: Response, next: NextFunction): void {
    const requestContext = this.cls.get('REQUEST_CONTEXT') as Record<string, unknown> | undefined
    const requestId = requestContext?.requestId as string | undefined

    // Set request context on Sentry scope
    Sentry.setContext('http_request', {
      method: req.method,
      path: req.path,
      url: req.url,
      requestId,
      ip: req.ip,
      userAgent: req.get('user-agent')
    })

    // Set user context if authenticated
    if (req.user) {
      const userId = req.user.sub || req.user.user_id
      const tenantId = req.user.user_metadata?.tenant_id

      if (userId) {
        Sentry.setUser({
          id: userId,
          email: req.user.email
        })
      }

      if (tenantId) {
        Sentry.setTag('tenant_id', tenantId)
      }

      if (req.user.app_metadata?.role) {
        Sentry.setTag('user_role', req.user.app_metadata.role)
      }
    }

    // Set request ID as tag for filtering
    if (requestId) {
      Sentry.setTag('request_id', requestId)
    }

    next()
  }
}
```

**Verification:**
- [ ] File created with proper types
- [ ] Uses existing ClsService pattern
- [ ] Sets user, tags, and context

### Task 2: Enhance beforeSend Data Scrubbing

Update `instrument.ts` to scrub sensitive data from events before sending to Sentry.

**File:** `apps/backend/src/instrument.ts`

**Changes:**
```typescript
beforeSend(event, hint) {
  // Don't send events in test environment
  if (process.env.NODE_ENV === 'test') {
    return null
  }

  // Scrub sensitive headers
  if (event.request?.headers) {
    const sensitiveHeaders = ['authorization', 'x-stripe-signature', 'cookie', 'x-api-key']
    for (const header of sensitiveHeaders) {
      if (event.request.headers[header]) {
        event.request.headers[header] = '[REDACTED]'
      }
    }
  }

  // Scrub sensitive data patterns from breadcrumbs
  if (event.breadcrumbs) {
    event.breadcrumbs = event.breadcrumbs.map(breadcrumb => {
      if (breadcrumb.data) {
        const scrubbed = { ...breadcrumb.data }
        // Scrub card numbers (4-digit groups)
        for (const [key, value] of Object.entries(scrubbed)) {
          if (typeof value === 'string') {
            // Card number pattern: 4 groups of 4 digits
            if (/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/.test(value)) {
              scrubbed[key] = '[CARD_REDACTED]'
            }
            // CVV pattern
            if (/\b\d{3,4}\b/.test(value) && key.toLowerCase().includes('cvv')) {
              scrubbed[key] = '[CVV_REDACTED]'
            }
          }
        }
        return { ...breadcrumb, data: scrubbed }
      }
      return breadcrumb
    })
  }

  return event
}
```

**Verification:**
- [ ] Sensitive headers are scrubbed
- [ ] Card data patterns are redacted
- [ ] Test environment still returns null

### Task 3: Add Transaction Naming for Background Jobs

Update `webhook-queue.processor.ts` to use proper Sentry transaction naming.

**File:** `apps/backend/src/modules/billing/webhooks/webhook-queue.processor.ts`

**Changes:**
Add transaction start/finish around webhook processing:

```typescript
async process(job: Job<WebhookJob>): Promise<void> {
  const { eventId, eventType, stripeEvent } = job.data
  const startTime = Date.now()

  // Start Sentry transaction for this background job
  const transaction = Sentry.startInactiveSpan({
    name: `webhook.${eventType}.process`,
    op: 'queue.process',
    attributes: {
      'job.id': job.id,
      'job.attempts': job.attemptsMade + 1,
      'stripe.event_id': eventId,
      'stripe.event_type': eventType
    }
  })

  // ... existing processing code ...

  // End transaction
  transaction?.end()
}
```

**Verification:**
- [ ] Transactions named as `webhook.{eventType}.process`
- [ ] Job metadata captured in attributes
- [ ] Transaction ends on success and failure paths

### Task 4: Register SentryContextMiddleware

Add the middleware to app.module.ts middleware chain.

**File:** `apps/backend/src/app.module.ts`

**Changes:**
1. Import SentryContextMiddleware
2. Add to middleware chain after RequestIdMiddleware

```typescript
import { SentryContextMiddleware } from './shared/middleware/sentry-context.middleware'

// In configure() method:
consumer
  .apply(
    RequestTimingMiddleware,
    RequestIdMiddleware,
    SentryContextMiddleware,  // Add after RequestIdMiddleware
    RequestLoggerMiddleware
  )
  .forRoutes('*')
```

**Verification:**
- [ ] Middleware registered in correct order
- [ ] `pnpm --filter @repo/backend typecheck` passes
- [ ] `pnpm --filter @repo/backend test:unit` passes

## Verification

Run these commands to verify the implementation:

```bash
# Type check
pnpm --filter @repo/backend typecheck

# Unit tests
pnpm --filter @repo/backend test:unit

# Verify middleware is applied (check logs on startup)
pnpm --filter @repo/backend dev
```

## Success Criteria

- [ ] SentryContextMiddleware created and registered
- [ ] User/tenant context automatically set on all requests
- [ ] Sensitive headers and card data scrubbed from events
- [ ] Background job transactions properly named
- [ ] All existing tests pass
- [ ] No TypeScript errors

## Output

Files created/modified:
- `apps/backend/src/shared/middleware/sentry-context.middleware.ts` (NEW)
- `apps/backend/src/instrument.ts` (MODIFIED)
- `apps/backend/src/modules/billing/webhooks/webhook-queue.processor.ts` (MODIFIED)
- `apps/backend/src/app.module.ts` (MODIFIED)

## Notes

- Source maps upload is a CI/CD concern, documented in ADR rather than implemented here
- Alert rules are configured in Sentry dashboard, not in code
- The DLQ integration already exists in webhook-queue.processor.ts
