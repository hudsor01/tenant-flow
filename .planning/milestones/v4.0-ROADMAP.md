# Milestone v4.0: Production-Parity Testing & Observability

**Status:** SHIPPED 2026-01-21
**Phases:** 26-32
**Total Plans:** 9

## Overview

Tests run against real services (Supabase, Stripe test mode) in production-equivalent environments, with comprehensive Sentry observability, so passing tests = confidence it works in production.

**Key Principle:** Testing should mirror production as closely as possible. Not just "tests pass" but "tests prove production readiness."

## Phases

### Phase 26: Test Environment Parity

**Goal**: Docker Compose setup mirroring production exactly—real Supabase, real Stripe test mode, same env structure
**Depends on**: v3.0 complete
**Plans**: 2 plans

Plans:
- [x] 26-01: Docker Compose Infrastructure (postgres, redis, backend)
- [x] 26-02: Environment Variable Parity

**Details:**
- PostgreSQL 17 already pinned in `supabase/config.toml`
- Docker Compose with service health checks (`condition: service_healthy`)
- Environment variable parity: `.env.development`, `.env.test`, `.env.production` hierarchy
- Supabase local via `supabase start` (ports 54321-54327) matches production RLS
- Network config: Internal Docker DNS for service discovery

---

### Phase 27: Production-Like Seed Data

**Goal**: Realistic test data reflecting actual usage patterns—multi-tenant isolation, realistic volumes, temporal distribution
**Depends on**: Phase 26
**Plans**: 1 plan

Plans:
- [x] 27-01: Three-Tier Seed Data System (smoke/dev/perf)

**Details:**
- Three-tier seed strategy: Smoke (2 owners, CI fast), Development (10 owners, realistic), Performance (100+ owners, 50K+ records)
- Multi-tenant pattern: Owner A/B/C with isolation boundaries + 50-tenant pool
- Stripe sync: Create real Stripe test customers/payment methods, link via database
- Temporal distribution: Spread dates across 24 months using `NOW() - random() * interval`
- Idempotency: Use `ON CONFLICT DO UPDATE` for re-runnable seeds

---

### Phase 28: Real Service Integration Tests

**Goal**: Replace mocks with real Supabase RLS verification, real Stripe test mode API calls
**Depends on**: Phase 27
**Plans**: 2 plans

Plans:
- [x] 28-01: StripeTestFixtures Infrastructure
- [x] 28-02: Real Stripe Integration Tests

**Details:**
- Stripe test mode: Use `sk_test_*` keys, never mock in integration tests
- Test clocks: `stripe.testHelpers.testClocks.create()` for subscription lifecycle without 30-day wait
- Webhook testing: `stripe listen --forward-to localhost:4600/api/v1/webhooks/stripe` in CI
- Cleanup strategy: `StripeTestFixtures` class with `cleanup()` method tracking all created resources
- Connect testing: Create test connected accounts with `stripe.accounts.create({ type: 'express' })`

---

### Phase 29: Sentry Backend Integration

**Goal**: Error tracking, performance monitoring, release health for NestJS with tenant context
**Depends on**: Phase 28
**Plans**: 1 plan

Plans:
- [x] 29-01: Sentry Backend Integration Enhancement (context middleware, data scrubbing, transaction naming)

**Details:**
- `SentryContextMiddleware` for automatic tenant_id/user_id tagging
- Data scrubbing: `beforeSend` to remove `authorization`, `x-stripe-signature`, card data
- Transaction naming: Auto-names from routes, manual for background jobs (`webhook.${eventType}.process`)
- Distributed tracing: `tracePropagationTargets` configured for Supabase/Stripe

---

### Phase 30: Sentry Frontend Integration

**Goal**: Source maps, user context, session replay, performance traces for Next.js 15+
**Depends on**: Phase 29
**Plans**: 1 plan

Plans:
- [x] 30-01: Sentry Frontend Integration Enhancement (data scrubbing, query error capture, user context)

**Details:**
- Three config files: `sentry.client.config.ts`, `sentry.server.config.ts`, `sentry.edge.config.ts`
- TanStack Query error capture: Subscribe to `queryClient.getQueryCache()` and `getMutationCache()`
- User context on auth state change
- Data scrubbing in client and server configs

---

### Phase 31: Synthetic Monitoring & Production Smoke Tests

**Goal**: Post-deployment verification, scheduled health checks, alerting integration
**Depends on**: Phase 30
**Plans**: 1 plan

Plans:
- [x] 31-01: Smoke test script, package.json integration, monitoring runbook

**Details:**
- Post-deploy smoke script: Bash script hitting all critical endpoints within 30s of deploy
- `pnpm test:smoke` script in package.json
- Monitoring runbook documentation
- Critical paths to verify: Auth flow, property CRUD, payment intent creation, RLS isolation

---

### Phase 32: Frontend Test Coverage Restoration

**Goal**: Restore frontend tests running against real QueryClient/stores
**Depends on**: Phase 31
**Plans**: 1 plan

Plans:
- [x] 32-01: Core domain hook tests (tenant, lease) + test utilities

**Details:**
- Test production parity: Real `QueryClient` (not mocked), vi.stubGlobal for fetch
- 48 new tests: 22 tenant hook tests, 26 lease hook tests
- Reusable test utilities: `createTestWrapper()`, `createMockFetchResponse()`, `createSupabaseMocks()`
- QueryClient config: `retry: false` for predictable testing

---

## Milestone Summary

**Key Decisions:**
- Docker Compose over Docker-in-Docker for test environment
- Real Stripe test mode API over mocks for integration tests
- Three-tier seed data (smoke/dev/perf) for different test scenarios
- vi.stubGlobal over MSW for frontend API mocking (existing pattern)

**Issues Resolved:**
- Test environment parity with production
- Real Stripe API testing infrastructure
- Sentry context for multi-tenant observability
- Frontend test coverage gaps

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

_For current project status, see .planning/ROADMAP.md_
