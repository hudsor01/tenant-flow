{"version":3,"file":"setup.js","sourceRoot":"","sources":["setup.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Backend RLS Integration Test Setup\n *\n * Provides utilities for multi-user authentication and RLS boundary testing.\n * These tests connect to real Supabase database to verify RLS policies work correctly.\n *\n * PREREQUISITES:\n * - Backend must be running: `doppler run -- pnpm --filter @repo/backend dev`\n * - Test accounts must exist in Supabase Auth (see .env.test for credentials)\n * - Database must have latest migrations applied\n */\n\nimport { createClient, type SupabaseClient } from '@supabase/supabase-js'\nimport type { Database } from '@repo/shared/types/supabase-generated'\n\n/**\n * Test user credentials\n * These accounts must be created manually in Supabase Auth\n */\nexport interface TestCredentials {\n\temail: string\n\tpassword: string\n\trole: 'owner' | 'TENANT'\n}\n\nexport const TEST_USERS = {\n\towner_A: {\n\t\temail: process.env.E2E_owner_A_EMAIL || 'owner-a@test.tenantflow.local',\n\t\tpassword: process.env.E2E_owner_A_PASSWORD || 'TestPassword123!',\n\t\trole: 'owner' as const\n\t},\n\towner_B: {\n\t\temail: process.env.E2E_owner_B_EMAIL || 'owner-b@test.tenantflow.local',\n\t\tpassword: process.env.E2E_owner_B_PASSWORD || 'TestPassword123!',\n\t\trole: 'owner' as const\n\t},\n\tTENANT_A: {\n\t\temail: process.env.E2E_TENANT_A_EMAIL || 'tenant-a@test.tenantflow.local',\n\t\tpassword: process.env.E2E_TENANT_A_PASSWORD || 'TestPassword123!',\n\t\trole: 'TENANT' as const\n\t},\n\tTENANT_B: {\n\t\temail: process.env.E2E_TENANT_B_EMAIL || 'tenant-b@test.tenantflow.local',\n\t\tpassword: process.env.E2E_TENANT_B_PASSWORD || 'TestPassword123!',\n\t\trole: 'TENANT' as const\n\t}\n} as const\n\n/**\n * Authenticated test client with user context\n */\nexport interface AuthenticatedTestClient {\n\tclient: SupabaseClient<Database>\n\tuserId: string\n\temail: string\n\trole: 'owner' | 'TENANT'\n\taccessToken: string\n}\n\n/**\n * Create Supabase client for testing\n */\nfunction createTestClient(): SupabaseClient<Database> {\n\tconst supabaseUrl =\n\t\tprocess.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL\n\tconst supabaseKey =\n\t\tprocess.env.SUPABASE_PUBLISHABLE_KEY ||\n\t\tprocess.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY\n\n\tif (!supabaseUrl || !supabaseKey) {\n\t\tthrow new Error(\n\t\t\t'Missing Supabase credentials. Set SUPABASE_URL and SUPABASE_PUBLISHABLE_KEY in environment.'\n\t\t)\n\t}\n\n\treturn createClient<Database>(supabaseUrl, supabaseKey, {\n\t\tauth: {\n\t\t\tautoRefreshToken: false,\n\t\t\tpersistSession: false,\n\t\t\tdetectSessionInUrl: false\n\t\t}\n\t})\n}\n\n/**\n * Authenticate as a test user and return authenticated client\n * NOTE: Test users must already exist in Supabase Auth\n */\nexport async function authenticateAs(\n\tcredentials: TestCredentials\n): Promise<AuthenticatedTestClient> {\n\tconst client = createTestClient()\n\n\t// Sign in with the test user\n\tconst authData = await client.auth.signInWithPassword({\n\t\temail: credentials.email,\n\t\tpassword: credentials.password\n\t})\n\n\tif (authData.error || !authData.data.session) {\n\t\tthrow new Error(\n\t\t\t`Failed to authenticate as ${credentials.email}: ${authData.error?.message || 'No session'}`\n\t\t)\n\t}\n\n\t// Ensure user exists in users table (for foreign key constraints)\n\tconst serviceClient = getServiceRoleClient()\n\tconst authUserId = authData.data.user.id\n\n\tif (serviceClient) {\n\t\t// Check if a user already exists with this auth ID as their primary key\n\t\tconst { data: existingUser } = await serviceClient\n\t\t\t.from('users')\n\t\t\t.select('id, supabaseId')\n\t\t\t.eq('id', authData.data.user.id)\n\t\t\t.maybeSingle()\n\n\t\tif (!existingUser) {\n\t\t\t// Create new user with auth ID as both id and supabaseId\n\t\t\tconst { error: userError } = await serviceClient.from('users').insert({\n\t\t\t\tid: authData.data.user.id,\n\t\t\t\tsupabaseId: authData.data.user.id,\n\t\t\t\temail: authData.data.user.email!,\n\t\t\t\tfirstName: credentials.role === 'owner' ? 'Owner' : 'Tenant',\n\t\t\t\tlastName: 'Test',\n\t\t\t\trole: credentials.role === 'owner' ? 'OWNER' : 'TENANT'\n\t\t\t})\n\n\t\t\tif (userError && !userError.message.includes('duplicate key')) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Failed to create user record for ${credentials.email}: ${userError.message} (code: ${userError.code})`\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t}\n\n\treturn {\n\t\tclient,\n\t\tuserId: authUserId, // Use auth ID for both RLS and foreign keys\n\t\temail: authData.data.user.email!,\n\t\trole: credentials.role,\n\t\taccessToken: authData.data.session.access_token\n\t}\n} /**\n * Get service role client for cleanup operations\n * Throws an error if environment variables are not available\n */\nexport function getServiceRoleClient(): SupabaseClient<Database> {\n\tconst supabaseUrl =\n\t\tprocess.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL\n\tconst serviceRoleKey = process.env.SUPABASE_SECRET_KEY\n\n\tif (!supabaseUrl || !serviceRoleKey) {\n\t\tthrow new Error(\n\t\t\t'Missing service role credentials (SUPABASE_URL and SUPABASE_SECRET_KEY). Cannot run tests.'\n\t\t)\n\t}\n\n\treturn createClient<Database>(supabaseUrl, serviceRoleKey, {\n\t\tauth: {\n\t\t\tautoRefreshToken: false,\n\t\t\tpersistSession: false\n\t\t},\n\t\tdb: {\n\t\t\tschema: 'public'\n\t\t}\n\t})\n}\n\n/**\n * Cleanup test data created during tests\n */\nexport async function cleanupTestData(\n\tserviceClient: SupabaseClient<Database>,\n\tresourceIds: {\n\t\tproperties?: string[]\n\t\ttenants?: string[]\n\t\tleases?: string[]\n\t\tpayments?: string[]\n\t\tunits?: string[]\n\t}\n) {\n\t// Delete in reverse foreign key order\n\tif (resourceIds.payments) {\n\t\tfor (const id of resourceIds.payments) {\n\t\t\tawait serviceClient.from('rent_payment').delete().eq('id', id)\n\t\t}\n\t}\n\n\tif (resourceIds.leases) {\n\t\tfor (const id of resourceIds.leases) {\n\t\t\tawait serviceClient.from('lease').delete().eq('id', id)\n\t\t}\n\t}\n\n\tif (resourceIds.tenants) {\n\t\tfor (const id of resourceIds.tenants) {\n\t\t\tawait serviceClient.from('tenant').delete().eq('id', id)\n\t\t}\n\t}\n\n\tif (resourceIds.units) {\n\t\tfor (const id of resourceIds.units) {\n\t\t\tawait serviceClient.from('unit').delete().eq('id', id)\n\t\t}\n\t}\n\n\tif (resourceIds.properties) {\n\t\tfor (const id of resourceIds.properties) {\n\t\t\tawait serviceClient.from('property').delete().eq('id', id)\n\t\t}\n\t}\n}\n\n/**\n * Helper to expect query to return empty results (RLS filtered)\n */\nexport function expectEmptyResult<T>(data: T[] | null, context: string): void {\n\tif (data === null || data.length === 0) {\n\t\treturn // Success - RLS filtered results\n\t}\n\tthrow new Error(\n\t\t`Expected empty result for ${context}, but got ${data.length} rows. RLS policy may be broken!`\n\t)\n}\n\n/**\n * Helper to expect query to fail with permission error\n */\nexport function expectPermissionError(error: any, context: string): void {\n\tif (!error) {\n\t\tthrow new Error(\n\t\t\t`Expected permission error for ${context}, but query succeeded. RLS policy may be broken!`\n\t\t)\n\t}\n\n\t// Supabase returns various error codes for permission issues\n\tconst permissionErrors = [\n\t\t'PGRST301', // Permission denied\n\t\t'42501', // Insufficient privilege\n\t\t'42P01' // Relation does not exist (RLS hides table)\n\t]\n\n\tconst errorCode = error.code || error.error_code || ''\n\tconst errorMessage = error.message || ''\n\n\tif (\n\t\tpermissionErrors.some(code => errorCode.includes(code)) ||\n\t\terrorMessage.toLowerCase().includes('permission') ||\n\t\terrorMessage.toLowerCase().includes('policy')\n\t) {\n\t\treturn // Success - permission denied as expected\n\t}\n\n\tthrow new Error(\n\t\t`Expected permission error for ${context}, but got: ${errorMessage} (${errorCode})`\n\t)\n}\n\n/**\n * Create or get a test lease for payment testing\n * Uses a fixed ID so it can be reused across tests\n */\nexport async function ensureTestLease(\n\townerId: string,\n\ttenantId: string\n): Promise<string> {\n\tconst serviceClient = getServiceRoleClient()\n\tif (!serviceClient) {\n\t\tthrow new Error('Service role client not available')\n\t}\n\n\tconst testLeaseId = 'test-lease-for-payments'\n\tconst testPropertyId = 'test-property-for-payments'\n\tconst testUnitId = 'test-unit-for-payments'\n\n\t// Check if lease already exists\n\tconst { data: existing } = await serviceClient\n\t\t.from('lease')\n\t\t.select('id')\n\t\t.eq('id', testLeaseId)\n\t\t.maybeSingle()\n\n\tif (existing) {\n\t\treturn testLeaseId\n\t}\n\n\t// Create minimal test property first\n\tconst { error: propertyError } = await serviceClient.from('property').upsert({\n\t\tid: testPropertyId,\n\t\townerId,\n\t\tname: 'Test Property',\n\t\taddress: '123 Test St',\n\t\tcity: 'Test City',\n\t\tstate: 'CA',\n\t\tzipCode: '12345',\n\t\tpropertyType: 'SINGLE_FAMILY',\n\t\tstatus: 'ACTIVE'\n\t})\n\n\tif (propertyError && !propertyError.message.includes('duplicate key')) {\n\t\tthrow new Error(`Failed to create test property: ${propertyError.message}`)\n\t}\n\n\t// Create minimal test unit\n\tconst { error: unitError } = await serviceClient.from('unit').upsert({\n\t\tid: testUnitId,\n\t\tpropertyId: testPropertyId,\n\t\tunitNumber: '1',\n\t\trent: 150000, // $1,500\n\t\tbedrooms: 1,\n\t\tbathrooms: 1,\n\t\tsquareFeet: 500,\n\t\tstatus: 'OCCUPIED'\n\t})\n\n\tif (unitError && !unitError.message.includes('duplicate key')) {\n\t\tthrow new Error(`Failed to create test unit: ${unitError.message}`)\n\t}\n\n\t// Create minimal test lease\n\tconst startDate = new Date()\n\tconst endDate = new Date()\n\tendDate.setFullYear(endDate.getFullYear() + 1)\n\n\t// Create tenant record (lease.tenantId references tenant table, not users)\n\tconst testTenantRecordId = 'test-tenant-record-for-payments'\n\tconst { error: tenantRecordError } = await serviceClient\n\t\t.from('tenant')\n\t\t.upsert({\n\t\t\tid: testTenantRecordId,\n\t\t\tuserId: tenantId, // Link to users table\n\t\t\temail: 'test-tenant@test.tenantflow.local',\n\t\t\tfirstName: 'Test',\n\t\t\tlastName: 'Tenant',\n\t\t\tstatus: 'ACTIVE'\n\t\t})\n\n\tif (\n\t\ttenantRecordError &&\n\t\t!tenantRecordError.message.includes('duplicate key')\n\t) {\n\t\tthrow new Error(\n\t\t\t`Failed to create tenant record: ${tenantRecordError.message}`\n\t\t)\n\t}\n\n\tconst { error } = await serviceClient.from('lease').insert({\n\t\tid: testLeaseId,\n\t\ttenantId: testTenantRecordId, // Use tenant record ID, not user ID\n\t\tunitId: testUnitId,\n\t\trentAmount: 150000, // $1,500\n\t\tsecurityDeposit: 150000,\n\t\tstartDate: startDate.toISOString().split('T')[0]!,\n\t\tendDate: endDate.toISOString().split('T')[0]!,\n\t\tstatus: 'ACTIVE'\n\t})\n\n\tif (error) {\n\t\tthrow new Error(`Failed to create test lease: ${error.message}`)\n\t}\n\n\treturn testLeaseId\n}\n"]}