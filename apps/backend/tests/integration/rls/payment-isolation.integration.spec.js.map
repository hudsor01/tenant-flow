{"version":3,"file":"payment-isolation.integration.spec.js","sourceRoot":"","sources":["payment-isolation.integration.spec.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Backend RLS Integration Tests: Payment Isolation\n *\n * Tests that rent_payment table RLS policies correctly enforce data isolation:\n * - owners can only see payments for their properties\n * - Tenants can only see their own payments\n * - Only service role can INSERT/UPDATE payments\n * - Prevents unauthorized payment access (PCI DSS compliance)\n *\n * @group integration\n * @group rls\n * @group security\n */\n\nimport { describe, it, expect, beforeAll } from '@jest/globals'\nimport type { Database } from '@repo/shared/types/supabase-generated'\nimport {\n\tauthenticateAs,\n\tensureTestLease,\n\texpectEmptyResult,\n\texpectPermissionError,\n\tgetServiceRoleClient,\n\tTEST_USERS,\n\ttype AuthenticatedTestClient\n} from './setup'\n\ndescribe('RLS: Payment Isolation', () => {\n\tlet ownerA: AuthenticatedTestClient\n\tlet ownerB: AuthenticatedTestClient\n\tlet tenantA: AuthenticatedTestClient\n\tlet tenantB: AuthenticatedTestClient\n\tlet serviceClient: ReturnType<typeof getServiceRoleClient>\n\tlet testLeaseId: string\n\n\t// Test data IDs for cleanup\n\tconst testData = {\n\t\tproperties: [] as string[],\n\t\ttenants: [] as string[],\n\t\tleases: [] as string[],\n\t\tpayments: [] as string[]\n\t}\n\n\tbeforeAll(async () => {\n\t\t// Authenticate all test users\n\t\townerA = await authenticateAs(TEST_USERS.owner_A)\n\t\townerB = await authenticateAs(TEST_USERS.owner_B)\n\t\ttenantA = await authenticateAs(TEST_USERS.TENANT_A)\n\t\ttenantB = await authenticateAs(TEST_USERS.TENANT_B)\n\t\tserviceClient = getServiceRoleClient()\n\n\t\t// Create test lease for payment foreign key\n\t\ttestLeaseId = await ensureTestLease(ownerA.userId, tenantA.userId)\n\t})\n\n\tdescribe('SELECT Policy: Owner/Tenant Access', () => {\n\t\tit('owner A can only see their own property payments', async () => {\n\t\t\t// owner A queries all payments\n\t\t\tconst { data, error } = await ownerA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.select('*')\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data).toBeDefined()\n\n\t\t\t// All returned payments should belong to owner A\n\t\t\tif (data && data.length > 0) {\n\t\t\t\tfor (const payment of data) {\n\t\t\t\t\texpect(payment.ownerId).toBe(ownerA.userId)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\n\t\tit('owner A cannot see owner B payments', async () => {\n\t\t\t// Try to query payments by owner B's ID directly\n\t\t\tconst { data, error } = await ownerA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.select('*')\n\t\t\t\t.eq('ownerId', ownerB.userId)\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpectEmptyResult(data, 'owner A querying owner B payments')\n\t\t})\n\n\t\tit('tenant A can only see their own payments', async () => {\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.select('*')\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data).toBeDefined()\n\n\t\t\t// All returned payments should belong to tenant A\n\t\t\tif (data && data.length > 0) {\n\t\t\t\tfor (const payment of data) {\n\t\t\t\t\texpect(payment.tenantId).toBe(tenantA.userId)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\n\t\tit('tenant A cannot see tenant B payments', async () => {\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.select('*')\n\t\t\t\t.eq('tenantId', tenantB.userId)\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpectEmptyResult(data, 'tenant A querying tenant B payments')\n\t\t})\n\n\t\tit('tenant cannot see owner payments for other properties', async () => {\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.select('*')\n\t\t\t\t.eq('ownerId', ownerB.userId)\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpectEmptyResult(data, 'tenant querying other owner payments')\n\t\t})\n\t})\n\n\tdescribe('INSERT Policy: Service Role Only', () => {\n\t\tit('authenticated user (owner) CANNOT insert payments', async () => {\n\t\t\tconst { data, error } = await ownerA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.insert({\n\t\t\t\t\townerId: ownerA.userId,\n\t\t\t\t\ttenantId: tenantA.userId,\n\t\t\t\t\tamount: 150000,\n\t\t\t\t\tstatus: 'pending',\n\t\t\t\t\tdueDate: new Date().toISOString().split('T')[0] || null,\n\t\t\t\t\tleaseId: testLeaseId,\n\t\t\t\t\townerReceives: 142500, // 5% platform fee\n\t\t\t\t\tpaymentType: 'card',\n\t\t\t\t\tplatformFee: 7500,\n\t\t\t\t\tstripeFee: 0\n\t\t\t\t})\n\t\t\t\t.select()\n\n\t\t\t// CRITICAL: This MUST fail due to RLS policy restricting INSERT to service_role\n\t\t\texpectPermissionError(error, 'owner attempting to insert payment')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\n\t\tit('authenticated user (tenant) CANNOT insert payments', async () => {\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.insert({\n\t\t\t\t\townerId: ownerB.userId,\n\t\t\t\t\ttenantId: tenantA.userId,\n\t\t\t\t\tamount: 150000,\n\t\t\t\t\tstatus: 'pending',\n\t\t\t\t\tdueDate: new Date().toISOString().split('T')[0] || null,\n\t\t\t\t\tleaseId: testLeaseId,\n\t\t\t\t\townerReceives: 142500, // 5% platform fee\n\t\t\t\t\tpaymentType: 'card',\n\t\t\t\t\tplatformFee: 7500,\n\t\t\t\t\tstripeFee: 0\n\t\t\t\t})\n\t\t\t\t.select()\n\n\t\t\t// CRITICAL: This MUST fail due to RLS policy restricting INSERT to service_role\n\t\t\texpectPermissionError(error, 'tenant attempting to insert payment')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\n\t\tit('service role CAN insert payments', async () => {\n\t\t\tconst testPayment: Database['public']['Tables']['rent_payment']['Insert'] =\n\t\t\t\t{\n\t\t\t\t\townerId: ownerA.userId,\n\t\t\t\t\ttenantId: tenantA.userId,\n\t\t\t\t\tamount: 150000,\n\t\t\t\t\tstatus: 'pending',\n\t\t\t\t\tdueDate: new Date().toISOString().split('T')[0] || null,\n\t\t\t\t\tleaseId: testLeaseId,\n\t\t\t\t\townerReceives: 142500, // 5% platform fee\n\t\t\t\t\tpaymentType: 'card',\n\t\t\t\t\tplatformFee: 7500,\n\t\t\t\t\tstripeFee: 0\n\t\t\t\t}\n\n\t\t\tconst { data, error } = await serviceClient\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.insert(testPayment)\n\t\t\t\t.select()\n\t\t\t\t.single()\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data).toBeDefined()\n\t\t\texpect(data?.amount).toBe(150000)\n\n\t\t\t// Track for cleanup\n\t\t\tif (data) {\n\t\t\t\ttestData.payments.push(data.id)\n\t\t\t}\n\t\t})\n\t})\n\n\tdescribe('UPDATE Policy: Service Role Only', () => {\n\t\tlet testPaymentId: string\n\n\t\tbeforeAll(async () => {\n\t\t\t// Create test payment using service role\n\t\t\tconst { data } = await serviceClient\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.insert({\n\t\t\t\t\townerId: ownerA.userId,\n\t\t\t\t\ttenantId: tenantA.userId,\n\t\t\t\t\tamount: 150000,\n\t\t\t\t\tstatus: 'pending',\n\t\t\t\t\tdueDate: new Date().toISOString().split('T')[0] || null,\n\t\t\t\t\tleaseId: testLeaseId,\n\t\t\t\t\townerReceives: 142500, // 5% platform fee\n\t\t\t\t\tpaymentType: 'card',\n\t\t\t\t\tplatformFee: 7500,\n\t\t\t\t\tstripeFee: 0\n\t\t\t\t})\n\t\t\t\t.select()\n\t\t\t\t.single()\n\n\t\t\tif (data) {\n\t\t\t\ttestPaymentId = data.id\n\t\t\t\ttestData.payments.push(data.id)\n\t\t\t}\n\t\t})\n\n\t\tit('authenticated user (owner) CANNOT update payments', async () => {\n\t\t\tconst { data, error } = await ownerA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.update({ status: 'succeeded' })\n\t\t\t\t.eq('id', testPaymentId)\n\t\t\t\t.select()\n\n\t\t\t// CRITICAL: This MUST fail due to RLS policy restricting UPDATE to service_role\n\t\t\texpectPermissionError(error, 'owner attempting to update payment')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\n\t\tit('authenticated user (tenant) CANNOT update payments', async () => {\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.update({ status: 'succeeded' })\n\t\t\t\t.eq('id', testPaymentId)\n\t\t\t\t.select()\n\n\t\t\t// CRITICAL: This MUST fail due to RLS policy restricting UPDATE to service_role\n\t\t\texpectPermissionError(error, 'tenant attempting to update payment')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\n\t\tit('service role CAN update payments', async () => {\n\t\t\tconst { data, error } = await serviceClient\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.update({ status: 'succeeded', paidAt: new Date().toISOString() })\n\t\t\t\t.eq('id', testPaymentId)\n\t\t\t\t.select()\n\t\t\t\t.single()\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data).toBeDefined()\n\t\t\texpect(data?.status).toBe('succeeded')\n\t\t})\n\t})\n\n\tdescribe('DELETE Policy: None (7-Year Retention)', () => {\n\t\tlet testPaymentId: string\n\n\t\tbeforeAll(async () => {\n\t\t\t// Create test payment using service role\n\t\t\tconst { data } = await serviceClient\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.insert({\n\t\t\t\t\townerId: ownerA.userId,\n\t\t\t\t\ttenantId: tenantA.userId,\n\t\t\t\t\tamount: 150000,\n\t\t\t\t\tstatus: 'pending',\n\t\t\t\t\tdueDate: new Date().toISOString().split('T')[0] || null,\n\t\t\t\t\tleaseId: testLeaseId,\n\t\t\t\t\townerReceives: 142500, // 5% platform fee\n\t\t\t\t\tpaymentType: 'card',\n\t\t\t\t\tplatformFee: 7500,\n\t\t\t\t\tstripeFee: 0\n\t\t\t\t})\n\t\t\t\t.select()\n\t\t\t\t.single()\n\n\t\t\tif (data) {\n\t\t\t\ttestPaymentId = data.id\n\t\t\t\ttestData.payments.push(data.id)\n\t\t\t}\n\t\t})\n\n\t\tit('authenticated user (owner) CANNOT delete payments', async () => {\n\t\t\tconst { data, error } = await ownerA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.delete()\n\t\t\t\t.eq('id', testPaymentId)\n\n\t\t\t// MUST fail - no DELETE policy exists (7-year retention requirement)\n\t\t\texpectPermissionError(error, 'owner attempting to delete payment')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\n\t\tit('authenticated user (tenant) CANNOT delete payments', async () => {\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.delete()\n\t\t\t\t.eq('id', testPaymentId)\n\n\t\t\t// MUST fail - no DELETE policy exists (7-year retention requirement)\n\t\t\texpectPermissionError(error, 'tenant attempting to delete payment')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\n\t\tit('service role CAN delete payments (cleanup only)', async () => {\n\t\t\t// Service role can delete for test cleanup, but application should never do this\n\t\t\tconst { error } = await serviceClient\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.delete()\n\t\t\t\t.eq('id', testPaymentId)\n\n\t\t\texpect(error).toBeNull()\n\n\t\t\t// Remove from cleanup list since we just deleted it\n\t\t\ttestData.payments = testData.payments.filter(id => id !== testPaymentId)\n\t\t})\n\t})\n\n\tdescribe('Cross-Tenant Payment Spoofing Prevention', () => {\n\t\tit('tenant cannot create payment with another tenant ID', async () => {\n\t\t\t// Tenant A tries to create payment claiming to be Tenant B\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.insert({\n\t\t\t\t\townerId: ownerA.userId,\n\t\t\t\t\ttenantId: tenantB.userId, // Spoofing attempt\n\t\t\t\t\tamount: 150000,\n\t\t\t\t\tstatus: 'pending',\n\t\t\t\t\tdueDate: new Date().toISOString().split('T')[0] || null,\n\t\t\t\t\tleaseId: testLeaseId,\n\t\t\t\t\townerReceives: 142500, // 5% platform fee\n\t\t\t\t\tpaymentType: 'card',\n\t\t\t\t\tplatformFee: 7500,\n\t\t\t\t\tstripeFee: 0\n\t\t\t\t})\n\t\t\t\t.select()\n\n\t\t\t// CRITICAL: This MUST fail - tenants cannot insert payments at all\n\t\t\texpectPermissionError(error, 'tenant spoofing another tenant ID')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\n\t\tit('owner cannot create payment for another owner', async () => {\n\t\t\t// owner A tries to create payment claiming to be owner B\n\t\t\tconst { data, error } = await ownerA.client\n\t\t\t\t.from('rent_payment')\n\t\t\t\t.insert({\n\t\t\t\t\townerId: ownerB.userId, // Spoofing attempt\n\t\t\t\t\ttenantId: tenantA.userId,\n\t\t\t\t\tamount: 150000,\n\t\t\t\t\tstatus: 'pending',\n\t\t\t\t\tdueDate: new Date().toISOString().split('T')[0] || null,\n\t\t\t\t\tleaseId: testLeaseId,\n\t\t\t\t\townerReceives: 142500, // 5% platform fee\n\t\t\t\t\tpaymentType: 'card',\n\t\t\t\t\tplatformFee: 7500,\n\t\t\t\t\tstripeFee: 0\n\t\t\t\t})\n\t\t\t\t.select()\n\n\t\t\t// CRITICAL: This MUST fail - owners cannot insert payments at all\n\t\t\texpectPermissionError(error, 'owner spoofing another owner ID')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\t})\n})\n"]}