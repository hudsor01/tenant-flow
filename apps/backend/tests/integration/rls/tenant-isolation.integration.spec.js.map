{"version":3,"file":"tenant-isolation.integration.spec.js","sourceRoot":"","sources":["tenant-isolation.integration.spec.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Backend RLS Integration Tests: Tenant Isolation\n *\n * Tests that tenant table and related RLS policies correctly enforce data isolation:\n * - Tenants can only see/update their own profile\n * - Tenants cannot access other tenants' data\n * - owners can view their managed tenants\n * - Emergency contacts are properly isolated\n *\n * @group integration\n * @group rls\n * @group security\n */\n\nimport { describe, it, expect, beforeAll, afterAll } from '@jest/globals'\nimport {\n\tauthenticateAs,\n\texpectEmptyResult,\n\texpectPermissionError,\n\tgetServiceRoleClient,\n\tTEST_USERS,\n\ttype AuthenticatedTestClient\n} from './setup'\n\ndescribe('RLS: Tenant Isolation', () => {\n\tlet tenantA: AuthenticatedTestClient\n\tlet tenantB: AuthenticatedTestClient\n\tlet serviceClient: ReturnType<typeof getServiceRoleClient>\n\n\t// Test data IDs for cleanup\n\tconst testData = {\n\t\ttenants: [] as string[],\n\t\temergencyContacts: [] as string[]\n\t}\n\n\tbeforeAll(async () => {\n\t\ttenantA = await authenticateAs(TEST_USERS.TENANT_A)\n\t\ttenantB = await authenticateAs(TEST_USERS.TENANT_B)\n\t\tserviceClient = getServiceRoleClient()\n\n\t\t// Create tenant records for test users\n\t\tconst tenantData = [\n\t\t\t{\n\t\t\t\tauth_user_id: tenantA.userId,\n\t\t\t\tuserId: tenantA.userId,\n\t\t\t\tfirstName: 'Test',\n\t\t\t\tlastName: 'Tenant A',\n\t\t\t\temail: tenantA.email,\n\t\t\t\tphone: '+1234567890',\n\t\t\t\tstatus: 'ACTIVE' as const\n\t\t\t},\n\t\t\t{\n\t\t\t\tauth_user_id: tenantB.userId,\n\t\t\t\tuserId: tenantB.userId,\n\t\t\t\tfirstName: 'Test',\n\t\t\t\tlastName: 'Tenant B',\n\t\t\t\temail: tenantB.email,\n\t\t\t\tphone: '+1234567891',\n\t\t\t\tstatus: 'ACTIVE' as const\n\t\t\t}\n\t\t]\n\n\t\tfor (const tenant of tenantData) {\n\t\t\tconst { data, error } = await serviceClient\n\t\t\t\t.from('tenant')\n\t\t\t\t.insert(tenant)\n\t\t\t\t.select('id')\n\t\t\t\t.single()\n\t\t\tif (error) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Failed to create tenant record for ${tenant.email}:`,\n\t\t\t\t\terror\n\t\t\t\t)\n\t\t\t} else if (data) {\n\t\t\t\ttestData.tenants.push(data.id)\n\t\t\t}\n\t\t}\n\t})\n\n\tafterAll(async () => {\n\t\t// Cleanup emergency contacts first\n\t\tfor (const id of testData.emergencyContacts) {\n\t\t\tawait serviceClient.from('tenant_emergency_contact').delete().eq('id', id)\n\t\t}\n\t})\n\n\tdescribe('Tenant Profile Access', () => {\n\t\tit('tenant A can read their own profile', async () => {\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('*')\n\t\t\t\t.eq('auth_user_id', tenantA.userId)\n\t\t\t\t.single()\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data).toBeDefined()\n\t\t\texpect(data?.auth_user_id).toBe(tenantA.userId)\n\t\t})\n\n\t\tit('tenant A cannot read tenant B profile', async () => {\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('*')\n\t\t\t\t.eq('auth_user_id', tenantB.userId)\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpectEmptyResult(data, 'tenant A querying tenant B profile')\n\t\t})\n\n\t\tit('tenant A can update their own profile', async () => {\n\t\t\t// First get tenant A's record\n\t\t\tconst { data: tenantRecord } = await serviceClient\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('id')\n\t\t\t\t.eq('auth_user_id', tenantA.userId)\n\t\t\t\t.single()\n\n\t\t\tif (!tenantRecord) {\n\t\t\t\tconsole.warn('Tenant A record not found - skipping update test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// Update as tenant A\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant')\n\t\t\t\t.update({ firstName: 'UpdatedName' })\n\t\t\t\t.eq('id', tenantRecord.id)\n\t\t\t\t.select()\n\t\t\t\t.single()\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data?.firstName).toBe('UpdatedName')\n\n\t\t\t// Restore original value\n\t\t\tawait serviceClient\n\t\t\t\t.from('tenant')\n\t\t\t\t.update({ firstName: 'Test' })\n\t\t\t\t.eq('id', tenantRecord.id)\n\t\t})\n\n\t\tit('tenant A cannot update tenant B profile', async () => {\n\t\t\t// Get tenant B's record\n\t\t\tconst { data: tenantRecord } = await serviceClient\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('id')\n\t\t\t\t.eq('auth_user_id', tenantB.userId)\n\t\t\t\t.single()\n\n\t\t\tif (!tenantRecord) {\n\t\t\t\tconsole.warn('Tenant B record not found - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// Tenant A tries to update tenant B\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant')\n\t\t\t\t.update({ firstName: 'Hacked' })\n\t\t\t\t.eq('id', tenantRecord.id)\n\t\t\t\t.select()\n\n\t\t\t// MUST fail or return empty\n\t\t\tif (error) {\n\t\t\t\texpectPermissionError(error, 'tenant A updating tenant B')\n\t\t\t} else {\n\t\t\t\texpectEmptyResult(data, 'tenant A updating tenant B')\n\t\t\t}\n\t\t})\n\t})\n\n\tdescribe('Emergency Contact Isolation', () => {\n\t\tlet tenantAId: string\n\t\tlet tenantBId: string\n\t\tlet tenantAEmergencyContactId: string\n\n\t\tbeforeAll(async () => {\n\t\t\t// Get tenant IDs\n\t\t\tconst { data: tenantARecord } = await serviceClient\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('id')\n\t\t\t\t.eq('auth_user_id', tenantA.userId)\n\t\t\t\t.single()\n\n\t\t\tconst { data: tenantBRecord } = await serviceClient\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('id')\n\t\t\t\t.eq('auth_user_id', tenantB.userId)\n\t\t\t\t.single()\n\n\t\t\tif (tenantARecord) tenantAId = tenantARecord.id\n\t\t\tif (tenantBRecord) tenantBId = tenantBRecord.id\n\n\t\t\t// Create emergency contact for tenant A\n\t\t\tif (tenantAId) {\n\t\t\t\tconst { data } = await serviceClient\n\t\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t\t.insert({\n\t\t\t\t\t\ttenant_id: tenantAId,\n\t\t\t\t\t\tcontact_name: 'John Emergency',\n\t\t\t\t\t\trelationship: 'Father',\n\t\t\t\t\t\tphone_number: '+1234567890',\n\t\t\t\t\t\temail: 'emergency@test.com'\n\t\t\t\t\t})\n\t\t\t\t\t.select()\n\t\t\t\t\t.single()\n\n\t\t\t\tif (data) {\n\t\t\t\t\ttenantAEmergencyContactId = data.id\n\t\t\t\t\ttestData.emergencyContacts.push(data.id)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\n\t\tit('tenant A can read their own emergency contact', async () => {\n\t\t\tif (!tenantAId) {\n\t\t\t\tconsole.warn('Tenant A ID not found - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.select('*')\n\t\t\t\t.eq('tenant_id', tenantAId)\n\t\t\t\t.single()\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data).toBeDefined()\n\t\t\texpect(data?.tenant_id).toBe(tenantAId)\n\t\t})\n\n\t\tit('tenant B cannot read tenant A emergency contact', async () => {\n\t\t\tif (!tenantAId) {\n\t\t\t\tconsole.warn('Tenant A ID not found - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { data, error } = await tenantB.client\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.select('*')\n\t\t\t\t.eq('tenant_id', tenantAId)\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpectEmptyResult(data, 'tenant B querying tenant A emergency contact')\n\t\t})\n\n\t\tit('tenant A can create their own emergency contact', async () => {\n\t\t\tif (!tenantAId) {\n\t\t\t\tconsole.warn('Tenant A ID not found - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// Delete existing contact first\n\t\t\tawait serviceClient\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.delete()\n\t\t\t\t.eq('tenant_id', tenantAId)\n\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.insert({\n\t\t\t\t\ttenant_id: tenantAId,\n\t\t\t\t\tcontact_name: 'Jane Emergency',\n\t\t\t\t\trelationship: 'Mother',\n\t\t\t\t\tphone_number: '+1987654321'\n\t\t\t\t})\n\t\t\t\t.select()\n\t\t\t\t.single()\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data).toBeDefined()\n\n\t\t\tif (data) {\n\t\t\t\ttenantAEmergencyContactId = data.id\n\t\t\t\ttestData.emergencyContacts.push(data.id)\n\t\t\t}\n\t\t})\n\n\t\tit('tenant A cannot create emergency contact for tenant B', async () => {\n\t\t\tif (!tenantBId) {\n\t\t\t\tconsole.warn('Tenant B ID not found - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.insert({\n\t\t\t\t\ttenant_id: tenantBId, // Attempt to create for tenant B\n\t\t\t\t\tcontact_name: 'Hacker Contact',\n\t\t\t\t\trelationship: 'None',\n\t\t\t\t\tphone_number: '+1111111111'\n\t\t\t\t})\n\t\t\t\t.select()\n\n\t\t\t// MUST fail due to RLS policy\n\t\t\texpectPermissionError(error, 'tenant A creating contact for tenant B')\n\t\t\texpect(data).toBeNull()\n\t\t})\n\n\t\tit('tenant A can update their own emergency contact', async () => {\n\t\t\tif (!tenantAId || !tenantAEmergencyContactId) {\n\t\t\t\tconsole.warn('Test data not available - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.update({ phone_number: '+1555555555' })\n\t\t\t\t.eq('id', tenantAEmergencyContactId)\n\t\t\t\t.select()\n\t\t\t\t.single()\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data?.phone_number).toBe('+1555555555')\n\t\t})\n\n\t\tit('tenant A cannot update tenant B emergency contact', async () => {\n\t\t\t// Create emergency contact for tenant B first\n\t\t\tif (!tenantBId) {\n\t\t\t\tconsole.warn('Tenant B ID not found - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { data: tenantBContact } = await serviceClient\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.insert({\n\t\t\t\t\ttenant_id: tenantBId,\n\t\t\t\t\tcontact_name: 'Tenant B Contact',\n\t\t\t\t\trelationship: 'Sibling',\n\t\t\t\t\tphone_number: '+1222222222'\n\t\t\t\t})\n\t\t\t\t.select()\n\t\t\t\t.single()\n\n\t\t\tif (!tenantBContact) {\n\t\t\t\tconsole.warn('Failed to create tenant B contact - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\ttestData.emergencyContacts.push(tenantBContact.id)\n\n\t\t\t// Tenant A tries to update tenant B's contact\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.update({ phone_number: '+1999999999' })\n\t\t\t\t.eq('id', tenantBContact.id)\n\t\t\t\t.select()\n\n\t\t\t// MUST fail or return empty\n\t\t\tif (error) {\n\t\t\t\texpectPermissionError(\n\t\t\t\t\terror,\n\t\t\t\t\t'tenant A updating tenant B emergency contact'\n\t\t\t\t)\n\t\t\t} else {\n\t\t\t\texpectEmptyResult(data, 'tenant A updating tenant B emergency contact')\n\t\t\t}\n\t\t})\n\n\t\tit('tenant A can delete their own emergency contact', async () => {\n\t\t\tif (!tenantAId || !tenantAEmergencyContactId) {\n\t\t\t\tconsole.warn('Test data not available - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { error } = await tenantA.client\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.delete()\n\t\t\t\t.eq('id', tenantAEmergencyContactId)\n\n\t\t\texpect(error).toBeNull()\n\n\t\t\t// Remove from cleanup list\n\t\t\ttestData.emergencyContacts = testData.emergencyContacts.filter(\n\t\t\t\tid => id !== tenantAEmergencyContactId\n\t\t\t)\n\t\t})\n\n\t\tit('tenant A cannot delete tenant B emergency contact', async () => {\n\t\t\t// Get tenant B's contact\n\t\t\tconst { data: contacts } = await serviceClient\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.select('id')\n\t\t\t\t.eq('tenant_id', tenantBId)\n\t\t\t\t.limit(1)\n\n\t\t\tif (!contacts || contacts.length === 0) {\n\t\t\t\tconsole.warn('Tenant B has no emergency contact - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst contactId = contacts[0]?.id\n\t\t\tif (!contactId) {\n\t\t\t\tconsole.warn('Contact ID is undefined - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant_emergency_contact')\n\t\t\t\t.delete()\n\t\t\t\t.eq('id', contactId)\n\t\t\t\t.select()\n\n\t\t\t// MUST fail or return empty\n\t\t\tif (error) {\n\t\t\t\texpectPermissionError(\n\t\t\t\t\terror,\n\t\t\t\t\t'tenant A deleting tenant B emergency contact'\n\t\t\t\t)\n\t\t\t} else {\n\t\t\t\texpectEmptyResult(data, 'tenant A deleting tenant B emergency contact')\n\t\t\t}\n\t\t})\n\t})\n\n\tdescribe('Notification Preferences Isolation', () => {\n\t\tit('tenant A can read their own notification preferences', async () => {\n\t\t\tconst { data: tenantRecord } = await serviceClient\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('id, notification_preferences')\n\t\t\t\t.eq('auth_user_id', tenantA.userId)\n\t\t\t\t.single()\n\n\t\t\tif (!tenantRecord) {\n\t\t\t\tconsole.warn('Tenant A record not found - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('notification_preferences')\n\t\t\t\t.eq('id', tenantRecord.id)\n\t\t\t\t.single()\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpect(data).toBeDefined()\n\t\t})\n\n\t\tit('tenant A cannot read tenant B notification preferences', async () => {\n\t\t\tconst { data: tenantRecord } = await serviceClient\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('id')\n\t\t\t\t.eq('auth_user_id', tenantB.userId)\n\t\t\t\t.single()\n\n\t\t\tif (!tenantRecord) {\n\t\t\t\tconsole.warn('Tenant B record not found - skipping test')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst { data, error } = await tenantA.client\n\t\t\t\t.from('tenant')\n\t\t\t\t.select('notification_preferences')\n\t\t\t\t.eq('id', tenantRecord.id)\n\n\t\t\texpect(error).toBeNull()\n\t\t\texpectEmptyResult(\n\t\t\t\tdata,\n\t\t\t\t'tenant A querying tenant B notification preferences'\n\t\t\t)\n\t\t})\n\t})\n})\n"]}