"use strict";exports.id=4787,exports.ids=[4787],exports.modules={74787:(a,b,c)=>{c.d(b,{validateFile:()=>k});var d=function(a){return a.LOGIN_SUCCESS="LOGIN_SUCCESS",a.LOGIN_FAILURE="LOGIN_FAILURE",a.LOGOUT="LOGOUT",a.SESSION_CREATED="SESSION_CREATED",a.SESSION_DESTROYED="SESSION_DESTROYED",a.SESSION_EXPIRED="SESSION_EXPIRED",a.SESSION_REFRESHED="SESSION_REFRESHED",a.SESSION_TERMINATED="SESSION_TERMINATED",a.SESSION_HIJACK_ATTEMPT="SESSION_HIJACK_ATTEMPT",a.UNAUTHORIZED_ACCESS_ATTEMPT="UNAUTHORIZED_ACCESS_ATTEMPT",a.RBAC_ACCESS_DENIED="RBAC_ACCESS_DENIED",a.PRIVILEGE_ESCALATION_ATTEMPT="PRIVILEGE_ESCALATION_ATTEMPT",a.AUTHENTICATED_ACCESS="AUTHENTICATED_ACCESS",a.INVALID_JWT_TOKEN="INVALID_JWT_TOKEN",a.TOKEN_NEAR_EXPIRATION="TOKEN_NEAR_EXPIRATION",a.CSRF_TOKEN_MISMATCH="CSRF_TOKEN_MISMATCH",a.CSRF_TOKEN_MISSING="CSRF_TOKEN_MISSING",a.SUSPICIOUS_REQUEST_PATTERN="SUSPICIOUS_REQUEST_PATTERN",a.XSS_ATTEMPT="XSS_ATTEMPT",a.SQL_INJECTION_ATTEMPT="SQL_INJECTION_ATTEMPT",a.PATH_TRAVERSAL_ATTEMPT="PATH_TRAVERSAL_ATTEMPT",a.COMMAND_INJECTION_ATTEMPT="COMMAND_INJECTION_ATTEMPT",a.BRUTE_FORCE_ATTEMPT="BRUTE_FORCE_ATTEMPT",a.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",a.SUSPICIOUS_RATE_PATTERN="SUSPICIOUS_RATE_PATTERN",a.MALICIOUS_FILE_UPLOAD="MALICIOUS_FILE_UPLOAD",a.FILE_TYPE_VIOLATION="FILE_TYPE_VIOLATION",a.FILE_SIZE_VIOLATION="FILE_SIZE_VIOLATION",a.MIDDLEWARE_ERROR="MIDDLEWARE_ERROR",a.SECURITY_CONFIG_CHANGE="SECURITY_CONFIG_CHANGE",a.BOT_ACCESS="BOT_ACCESS",a.SUSPICIOUS_ACTIVITY="SUSPICIOUS_ACTIVITY",a.PII_ACCESS="PII_ACCESS",a.DATA_EXPORT="DATA_EXPORT",a.GDPR_REQUEST="GDPR_REQUEST",a}({});let e={MEDIUM:"MEDIUM",HIGH:"HIGH",CRITICAL:"CRITICAL"};class f{static getInstance(){return f.instance||(f.instance=new f),f.instance}async logSecurityEvent(a){let b={...a,severity:this.calculateSeverity({...a,severity:void 0}),timestamp:a.timestamp||new Date().toISOString()};this.events.push(b),this.events.length>this.maxEvents&&(this.events=this.events.slice(-this.maxEvents/2));let c=this.getLogLevel(b.severity);console[c]("[SECURITY]",JSON.stringify({timestamp:b.timestamp,type:b.type,severity:b.severity,ip:b.ip,userId:b.userId,path:b.path,reason:b.reason},null,2))}calculateSeverity(a){return["SESSION_HIJACK_ATTEMPT","SQL_INJECTION_ATTEMPT","COMMAND_INJECTION_ATTEMPT"].includes(a.type)?e.CRITICAL:["BRUTE_FORCE_ATTEMPT","XSS_ATTEMPT","PATH_TRAVERSAL_ATTEMPT"].includes(a.type)?e.HIGH:e.MEDIUM}getLogLevel(a){switch(a){case e.CRITICAL:case e.HIGH:return"error";case e.MEDIUM:return"warn";default:return"log"}}getRecentEvents(a=50){return this.events.sort((a,b)=>new Date(b.timestamp).getTime()-new Date(a.timestamp).getTime()).slice(0,a)}constructor(){this.events=[],this.maxEvents=1e4}}let g=f.getInstance(),h={documents:{maxFileSize:0x3200000,allowedMimeTypes:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/csv"],allowedExtensions:[".pdf",".doc",".docx",".xls",".xlsx",".txt",".csv"],allowedMagicNumbers:{pdf:[[37,80,68,70]],docx:[[80,75,3,4]],doc:[[208,207,17,224]],txt:[[]]},scanForMalware:!0,validateContent:!0,quarantineOnSuspicion:!0},images:{maxFileSize:0x1400000,allowedMimeTypes:["image/jpeg","image/png","image/webp","image/gif","image/svg+xml"],allowedExtensions:[".jpg",".jpeg",".png",".webp",".gif",".svg"],allowedMagicNumbers:{jpeg:[[255,216,255]],png:[[137,80,78,71,13,10,26,10]],webp:[[82,73,70,70]],gif:[[71,73,70,56]],svg:[]},scanForMalware:!0,validateContent:!0,quarantineOnSuspicion:!0},avatar:{maxFileSize:5242880,allowedMimeTypes:["image/jpeg","image/png","image/webp"],allowedExtensions:[".jpg",".jpeg",".png",".webp"],allowedMagicNumbers:{jpeg:[[255,216,255]],png:[[137,80,78,71,13,10,26,10]],webp:[[82,73,70,70]]},scanForMalware:!0,validateContent:!0,quarantineOnSuspicion:!0},maintenance:{maxFileSize:0x1900000,allowedMimeTypes:["image/jpeg","image/png","image/webp","application/pdf","video/mp4","video/quicktime","video/x-msvideo"],allowedExtensions:[".jpg",".jpeg",".png",".webp",".pdf",".mp4",".mov",".avi"],allowedMagicNumbers:{jpeg:[[255,216,255]],png:[[137,80,78,71,13,10,26,10]],webp:[[82,73,70,70]],pdf:[[37,80,68,70]],mp4:[[0,0,0,24,102,116,121,112]]},scanForMalware:!0,validateContent:!0,quarantineOnSuspicion:!0}},i=[/\.(exe|bat|cmd|scr|pif|com|jar|msi|deb|rpm|dmg|app)$/i,/\.(js|vbs|vbe|jse|ws|wsf|wsc|wsh|ps1|php|py|rb|pl|sh)$/i,/\.(rar|7z|tar\.gz|tar\.bz2)$/i,/\.\w+\.(exe|bat|cmd|scr|pif|com)$/i,/\.\w+\s+\.(exe|bat|cmd|scr|pif|com)$/i],j=[/^(con|prn|aux|nul|com[1-9]|lpt[1-9])(\.|$)/i,/[<>:"|?*\\\/]/g,/^\./,/\s{2,}/,/[\x00-\x1f\x7f-\x9f]/];async function k(a,b="documents",c){let e=h[b],f={valid:!0,errors:[],warnings:[],fileInfo:{name:a.name,size:a.size,type:a.type,extension:s(a.name)},securityFlags:{containsScript:!1,containsMacros:!1,potentialMalware:!1,suspiciousName:!1,oversized:!1}};try{await l(a,e,f),await m(a,e,f),e.validateContent&&await n(a,e,f),e.scanForMalware&&await o(a,e,f),function(a){let{securityFlags:b}=a,c=Object.values(b).filter(Boolean).length;c>=3?(a.valid=!1,a.errors.push("File triggers multiple security concerns")):c>=2&&a.warnings.push("File has multiple security flags - proceed with caution"),(b.potentialMalware||b.containsScript)&&(a.valid=!1)}(f),f.fileInfo.hash=await q(a),await r(a,f,b.toString(),c)}catch(e){f.valid=!1,f.errors.push(`File validation error: ${e instanceof Error?e.message:"Unknown error"}`),await g.logSecurityEvent({type:d.FILE_TYPE_VIOLATION,timestamp:new Date().toISOString(),userId:c,reason:`File validation failed: ${e instanceof Error?e.message:"Unknown error"}`,additionalData:{fileName:a.name,fileSize:a.size,fileType:a.type,context:b}})}return f}async function l(a,b,c){a.size>b.maxFileSize&&(c.valid=!1,c.errors.push(`File size exceeds maximum allowed size of ${function(a){if(0===a)return"0 Bytes";let b=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,b)).toFixed(2))+" "+["Bytes","KB","MB","GB"][b]}(b.maxFileSize)}`),c.securityFlags.oversized=!0),0===a.size&&(c.valid=!1,c.errors.push("File is empty")),b.allowedMimeTypes.includes(a.type)||(c.valid=!1,c.errors.push(`File type "${a.type}" is not allowed`));let d=s(a.name);b.allowedExtensions.includes(d.toLowerCase())||(c.valid=!1,c.errors.push(`File extension "${d}" is not allowed`)),i.some(b=>b.test(a.name))&&(c.valid=!1,c.errors.push("File type is potentially dangerous and not allowed"),c.securityFlags.potentialMalware=!0),j.some(b=>b.test(a.name))&&(c.warnings.push("Filename contains suspicious patterns"),c.securityFlags.suspiciousName=!0),a.name.includes("\0")&&(c.valid=!1,c.errors.push("Filename contains null bytes"),c.securityFlags.suspiciousName=!0)}async function m(a,b,c){try{let d=await a.slice(0,16).arrayBuffer(),e=new Uint8Array(d),f=Array.from(e.slice(0,8)).map(a=>a.toString(16).padStart(2,"0")).join(" ");c.fileInfo.magicNumber=f;let g=s(a.name).toLowerCase().replace(".",""),h=b.allowedMagicNumbers[g];h&&h.length>0&&!h.some(a=>a.every((a,b)=>b<e.length&&e[b]===a))&&h[0].length>0&&(c.valid=!1,c.errors.push(`File signature doesn't match expected type. Expected: ${g}`),c.securityFlags.potentialMalware=!0)}catch{c.warnings.push("Could not validate file signature")}}async function n(a,b,c){try{if(a.type.startsWith("text/")||a.name.endsWith(".svg")){let b=await a.text();[/<script[\s\S]*?>/gi,/javascript:/gi,/vbscript:/gi,/on\w+\s*=/gi,/<iframe[\s\S]*?>/gi,/<object[\s\S]*?>/gi,/<embed[\s\S]*?>/gi].some(a=>a.test(b))&&(c.valid=!1,c.errors.push("File contains potentially malicious script content"),c.securityFlags.containsScript=!0),[/(\bunion\b|\bselect\b|\binsert\b|\bupdate\b|\bdelete\b|\bdrop\b)/gi,/(\bor\b\s+\d+\s*=\s*\d+)/gi].some(a=>a.test(b))&&c.warnings.push("File contains SQL-like patterns")}(a.type.includes("officedocument")||a.type.includes("ms-"))&&(c.securityFlags.containsMacros=await p(a),c.securityFlags.containsMacros&&c.warnings.push("Document may contain macros or embedded content"))}catch{c.warnings.push("Could not fully validate file content")}}async function o(a,b,c){try{let b=await a.arrayBuffer(),d=new Uint8Array(b);for(let a of[[88,53,79,33,80,37,64,65,80,91,52,92,80,90,88,53,52]])for(let b=0;b<=d.length-a.length;b++)if(a.every((a,c)=>d[b+c]===a)){c.valid=!1,c.errors.push("File contains known malware signature"),c.securityFlags.potentialMalware=!0;return}if(d.length>64){let a=d[60]|d[61]<<8|d[62]<<16|d[63]<<24;if(a<d.length-4){let b=d.slice(a,a+4);80===b[0]&&69===b[1]&&0===b[2]&&0===b[3]&&(c.valid=!1,c.errors.push("Windows executable files are not allowed"),c.securityFlags.potentialMalware=!0)}}}catch{c.warnings.push("Malware scan could not be completed")}}async function p(a){try{let b=await a.text();return/vba|macro|activex/gi.test(b)}catch{return!1}}async function q(a){try{let b=await a.arrayBuffer(),c=await crypto.subtle.digest("SHA-256",b);return Array.from(new Uint8Array(c)).map(a=>a.toString(16).padStart(2,"0")).join("")}catch{return"hash-generation-failed"}}async function r(a,b,c,e){let f=b.valid?d.PII_ACCESS:d.MALICIOUS_FILE_UPLOAD;await g.logSecurityEvent({type:f,timestamp:new Date().toISOString(),userId:e,reason:b.valid?"File upload successful":b.errors.join(", "),additionalData:{fileName:a.name,fileSize:a.size,fileType:a.type,context:c,hash:b.fileInfo.hash,securityFlags:b.securityFlags,validationErrors:b.errors,validationWarnings:b.warnings}})}function s(a){let b=a.lastIndexOf(".");return -1===b?"":a.slice(b)}}};